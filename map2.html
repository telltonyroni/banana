<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>tony's banana.place</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='0.9em' font-size='90'>üçå</text></svg>'"/>
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<style>
:root{--bg:#FFF9E5;--surface:rgba(255,255,255,0.96);--ink:#0A0A0A;--muted:#737373;--accent:#FFD93D;--accent-dark:#E0C24B;--success:#10b981;--warn:#ef4444;--info:#3b82f6;--shadow:0 2px 8px rgba(0,0,0,.04);--shadow-md:0 4px 16px rgba(0,0,0,.06);--shadow-lg:0 8px 24px rgba(0,0,0,.08);--shadow-xl:0 12px 32px rgba(0,0,0,.12);--radius:12px}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;-webkit-font-smoothing:antialiased;overflow:hidden}
#map{position:relative;height:100vh;width:100%}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideInUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shimmer{0%{background-position:-200% center}100%{background-position:200% center}}
.header{position:fixed;top:16px;left:16px;right:16px;z-index:1000;display:flex;justify-content:space-between;gap:12px;pointer-events:none}
.header>*{pointer-events:auto}
.brand{display:flex;align-items:center;gap:10px;background:var(--surface);backdrop-filter:blur(16px);border-radius:999px;padding:10px 18px;box-shadow:var(--shadow-md);font-weight:600;font-size:15px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.brand:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.brand-icon{width:26px;height:26px;flex-shrink:0;display:block}
.hgroup{display:flex;gap:8px}
.iconbtn{width:44px;height:44px;border:none;border-radius:var(--radius);background:var(--surface);backdrop-filter:blur(16px);display:grid;place-items:center;box-shadow:var(--shadow-md);cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.iconbtn:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.iconbtn.active{background:var(--accent);border-color:var(--accent-dark)}
.icon{width:18px;height:18px}
.icon-lg{width:22px;height:22px}
.search-panel{position:fixed;top:76px;left:16px;right:16px;z-index:999;display:none;animation:slideDown 0.2s cubic-bezier(0.4,0,0.2,1)}
.search-panel.show{display:block}
.search-input-wrapper{position:relative}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}
.search-panel input{width:100%;padding:14px 14px 14px 44px;border:1px solid rgba(0,0,0,0.08);border-radius:var(--radius);background:var(--surface);backdrop-filter:blur(16px);box-shadow:var(--shadow-lg);font:inherit;font-size:14px;transition:all 0.2s ease}
.search-panel input:focus{outline:none;border-color:var(--accent);box-shadow:var(--shadow-xl),0 0 0 3px rgba(255,217,61,0.08)}
.search-panel input::placeholder{color:var(--muted)}
.search-results{margin-top:8px;background:var(--surface);backdrop-filter:blur(16px);border-radius:var(--radius);box-shadow:var(--shadow-lg);max-height:60vh;overflow-y:auto;display:none;border:1px solid rgba(0,0,0,0.06)}
.search-results.show{display:block;animation:slideDown 0.2s ease}
.search-result-item{padding:12px 14px;cursor:pointer;transition:all 0.15s ease;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;gap:10px}
.search-result-item:last-child{border-bottom:none}
.search-result-item:hover{background:rgba(255,217,61,0.08);padding-left:18px}
.search-result-item .icon-wrapper{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));border-radius:10px;display:grid;place-items:center;flex-shrink:0}
.search-result-item .text{flex:1;min-width:0}
.search-result-item strong{display:block;font-size:14px;font-weight:600;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.search-result-item small{display:block;font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.menu{position:fixed;right:16px;top:76px;z-index:999;background:var(--surface);backdrop-filter:blur(16px);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:6px;min-width:220px;display:none;animation:slideDown 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.menu.show{display:block}
.menu .row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.15s ease;font-size:13px;font-weight:500}
.menu .row:hover{background:rgba(255,217,61,0.08);padding-left:16px}
.menu .row.disabled{opacity:0.35;cursor:not-allowed}
.menu .row.disabled:hover{background:transparent;padding-left:12px}
.menu .split{height:1px;background:rgba(0,0,0,0.06);margin:6px 8px}
.controls{position:fixed;right:16px;bottom:16px;z-index:998;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.controls>*{pointer-events:auto}
.fab{border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink);font-weight:600;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 20px;box-shadow:var(--shadow-lg);cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);white-space:nowrap;border:1px solid var(--accent-dark)}
.fab:hover:not(:disabled){box-shadow:var(--shadow-xl),0 8px 20px rgba(255,217,61,0.3);transform:translateY(-2px)}
.fab:disabled{opacity:0.5;cursor:not-allowed}
.quick-btn{width:44px;height:44px;border:none;border-radius:var(--radius);background:var(--surface);backdrop-filter:blur(16px);display:grid;place-items:center;box-shadow:var(--shadow-md);cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.quick-btn:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.stats{position:fixed;left:16px;bottom:16px;z-index:998;background:var(--surface);backdrop-filter:blur(16px);border-radius:var(--radius);padding:10px 14px;box-shadow:var(--shadow-md);display:flex;align-items:center;gap:12px;font-size:12px;font-weight:600;border:1px solid rgba(0,0,0,0.06);animation:slideUp 0.3s ease}
.stats-item{display:flex;align-items:center;gap:6px;color:var(--muted)}
.stats-item .banana-mini{width:16px;height:16px}
.stats-item .count{color:var(--ink);font-size:14px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;z-index:10000;background:var(--surface);backdrop-filter:blur(16px);padding:10px 16px;border-radius:var(--radius);box-shadow:var(--shadow-xl);font-size:13px;font-weight:600;max-width:90vw;animation:slideUp 0.25s cubic-bezier(0.4,0,0.2,1);display:flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,0.06)}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--warn)}
.toast.info{border-left:3px solid var(--info)}
.sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:1001;background:var(--surface);backdrop-filter:blur(16px);border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -8px 40px rgba(0,0,0,.1);padding:18px 18px 28px;transition:bottom 0.3s cubic-bezier(0.4,0,0.2,1);max-height:82vh;overflow-y:auto;border-top:1px solid rgba(0,0,0,0.06)}
.sheet.show{bottom:0}
.sheet .grab{width:36px;height:4px;background:rgba(0,0,0,0.15);border-radius:4px;margin:0 auto 14px}
.sheet h3{margin:0 0 6px 0;font-size:20px;font-weight:700}
.sheet .subtitle{color:var(--muted);font-size:13px;margin-bottom:18px;font-weight:500}
.sheet label{font-size:11px;font-weight:700;color:var(--ink);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em}
.sheet input[type="text"],.sheet textarea{width:100%;padding:12px;border:1px solid rgba(0,0,0,0.1);border-radius:10px;font:inherit;font-size:14px;transition:all 0.2s ease;background:#fff;margin-bottom:14px}
.sheet input[type="text"]:focus,.sheet textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,217,61,0.08)}
.sheet textarea{resize:vertical;min-height:80px;line-height:1.5}
.char-count{font-size:11px;color:var(--muted);text-align:right;margin-top:-10px;margin-bottom:14px}
.file-upload{position:relative;margin-bottom:14px}
.file-upload-label{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;padding:18px;border:2px dashed rgba(0,0,0,0.12);border-radius:10px;cursor:pointer;transition:all 0.2s ease;background:rgba(255,217,61,0.03)}
.file-upload-label:hover{border-color:var(--accent-dark);background:rgba(255,217,61,0.08)}
.file-upload input[type="file"]{position:absolute;opacity:0;width:0;height:0}
.file-upload-text{font-size:13px;font-weight:600;color:var(--ink)}
.file-upload-hint{font-size:11px;color:var(--muted)}
.previews{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-bottom:14px}
.preview img,.previews img{width:100%;height:100px;object-fit:cover;border-radius:10px;box-shadow:var(--shadow-md)}
.sheet-actions{display:flex;gap:10px;margin-top:18px}
.sheet-actions button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink);border:1px solid var(--accent-dark)}
.btn-primary:hover:not(:disabled){box-shadow:0 4px 16px rgba(255,217,61,0.25);transform:translateY(-1px)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed}
.btn-secondary{background:rgba(0,0,0,0.04);color:var(--ink);border:1px solid rgba(0,0,0,0.08)}
.btn-secondary:hover{background:rgba(0,0,0,0.08)}
.privacy-option{display:flex;align-items:center;gap:8px;padding:12px;background:rgba(255,217,61,0.08);border:1px solid rgba(255,217,61,0.3);border-radius:10px;margin-bottom:14px;cursor:pointer;transition:all 0.2s ease}
.privacy-option:hover{background:rgba(255,217,61,0.12)}
.privacy-option input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:var(--accent-dark)}
.privacy-option label{font-size:13px;font-weight:500;color:var(--ink);cursor:pointer;text-transform:none;letter-spacing:normal;margin:0;flex:1}
.banana-marker{width:40px;height:auto;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);filter:drop-shadow(0 3px 8px rgba(0,0,0,.12))}
.banana-marker svg{display:block;width:40px;height:auto}
.banana-marker:hover{transform:translateY(-5px) scale(1.12);filter:drop-shadow(0 6px 16px rgba(0,0,0,.2))}
.banana-marker.mine{filter:drop-shadow(0 3px 12px rgba(255,217,61,.5))}
.banana-marker.mine:hover{filter:drop-shadow(0 6px 20px rgba(255,217,61,.7))}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);z-index:2000;display:none;animation:fadeIn 0.25s ease}
.modal-overlay.show{display:block}
.modal{position:fixed;inset:0;z-index:2001;display:none;align-items:center;justify-content:center;padding:20px}
.modal.show{display:flex}
.modal-content{width:min(600px,100%);max-height:90vh;background:var(--surface);border-radius:20px;box-shadow:var(--shadow-xl);overflow:hidden;animation:slideInUp 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;display:flex;flex-direction:column}
.modal-close{position:absolute;top:16px;right:16px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);color:#fff;border:none;cursor:pointer;display:grid;place-items:center;z-index:10;transition:all 0.2s ease;box-shadow:var(--shadow-md)}
.modal-close:hover{background:rgba(0,0,0,0.8);transform:scale(1.1) rotate(90deg)}
.modal-body{padding:24px;overflow-y:auto;flex:1}
.modal-header{margin-bottom:16px}
.modal-header h3{font-size:24px;font-weight:700;margin-bottom:6px}
.modal-meta{font-size:13px;color:var(--muted);font-weight:500}
.modal-message{font-size:15px;line-height:1.7;color:#4b5563;margin-bottom:16px}
#modalPhotoGallery{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
#modalPhotoGallery img{width:100%;max-width:48%;height:180px;object-fit:cover;border-radius:12px;box-shadow:var(--shadow-md)}
#modalPhotoGallery img:only-child{max-width:100%}
.reactions-bar{display:flex;gap:8px;padding:12px;background:rgba(0,0,0,0.02);border-radius:10px;margin-bottom:16px;flex-wrap:wrap}
.reaction-btn{display:flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid rgba(0,0,0,0.1);border-radius:8px;background:#fff;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s ease}
.reaction-btn:hover{background:rgba(255,217,61,0.08);transform:translateY(-1px)}
.reaction-btn.active{background:linear-gradient(135deg,var(--accent),var(--accent-dark));border-color:var(--accent-dark)}
.reaction-emoji{font-size:18px}
.modal-actions{display:flex;gap:10px;padding:0 24px 24px;flex-wrap:wrap}
.modal-actions button{flex:1;min-width:120px;padding:14px;border:none;border-radius:12px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;gap:8px}
.action-edit{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink);border:1px solid var(--accent-dark)}
.action-edit:hover{box-shadow:0 4px 16px rgba(255,217,61,0.25);transform:translateY(-1px)}
.action-customize{background:var(--info);color:#fff;border:1px solid var(--info)}
.action-customize:hover{background:#2563eb;transform:translateY(-1px);box-shadow:0 4px 16px rgba(59,130,246,0.25)}
.action-delete{background:var(--warn);color:#fff;border:1px solid var(--warn)}
.action-delete:hover{background:#dc2626;transform:translateY(-1px);box-shadow:0 4px 16px rgba(239,68,68,0.25)}
.prompt-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);z-index:3500;display:none;animation:fadeIn 0.2s ease}
.prompt-overlay.show{display:block}
.prompt-dialog{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:min(400px,90%);background:var(--surface);border-radius:16px;box-shadow:var(--shadow-xl);z-index:3501;display:none;animation:slideInUp 0.3s cubic-bezier(0.4,0,0.2,1);padding:24px}
.prompt-dialog.show{display:block}
.prompt-dialog h3{font-size:20px;font-weight:700;margin-bottom:8px;color:var(--ink)}
.prompt-dialog p{font-size:14px;color:var(--muted);margin-bottom:16px}
.prompt-dialog input,.prompt-dialog textarea{width:100%;padding:12px;border:1px solid rgba(0,0,0,0.1);border-radius:10px;font:inherit;font-size:14px;margin-bottom:16px}
.prompt-dialog textarea{min-height:80px;resize:vertical}
.prompt-dialog input:focus,.prompt-dialog textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,217,61,0.08)}
.prompt-actions{display:flex;gap:10px}
.prompt-actions button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s ease}
.customize-modal .modal-content{width:min(720px,100%);max-height:90vh}
.customize-header{display:flex;align-items:center;gap:20px;margin-bottom:24px;padding-bottom:20px;border-bottom:2px solid rgba(0,0,0,0.06)}
.customize-stage{flex-shrink:0;width:200px;height:300px;background:linear-gradient(135deg,rgba(255,217,61,0.12),rgba(224,194,75,0.12));border-radius:20px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.customize-stage::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(255,217,61,0.2),transparent 70%);animation:pulse 3s ease-in-out infinite}
.customize-preview-svg{width:140px;height:auto;filter:drop-shadow(0 6px 16px rgba(0,0,0,0.12));transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);position:relative;z-index:2}
.customize-preview-svg.changing{transform:scale(0.85) rotate(-5deg);opacity:0.7}
.customize-info{flex:1;min-width:0}
.customize-info h4{font-size:20px;font-weight:700;color:var(--ink);margin-bottom:10px}
.customize-info p{font-size:14px;color:var(--muted);line-height:1.6}
.customize-tabs{display:flex;gap:8px;margin-bottom:20px;background:rgba(0,0,0,0.03);padding:6px;border-radius:12px}
.customize-tab{flex:1;padding:12px 16px;border:none;border-radius:8px;background:transparent;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s ease;color:var(--muted)}
.customize-tab.active{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink);box-shadow:var(--shadow-md)}
.customize-tab:hover:not(.active){background:rgba(0,0,0,0.05)}
.customize-category{display:none}
.customize-category.active{display:block}
.customize-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(105px,1fr));gap:12px;margin-bottom:24px}
.customize-option{position:relative;aspect-ratio:1;border:2px solid rgba(0,0,0,0.1);border-radius:14px;padding:10px;cursor:pointer;transition:all 0.2s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;background:#fff}
.customize-option:hover{border-color:var(--accent-dark);transform:translateY(-3px);box-shadow:var(--shadow-md)}
.customize-option.selected{border-color:var(--accent-dark);background:linear-gradient(135deg,rgba(255,217,61,0.15),rgba(224,194,75,0.15));box-shadow:var(--shadow-md)}
.customize-option-preview{width:60px;height:60px;display:flex;align-items:center;justify-content:center}
.customize-option-preview svg{width:100%;height:auto;max-height:100%}
.customize-option-label{font-size:11px;font-weight:600;color:var(--ink);text-align:center;line-height:1.2}
.customize-option.none-option{border-style:dashed;opacity:0.6}
.customize-option.none-option:hover{opacity:1}
.customize-action-bar{display:flex;gap:12px;padding-top:20px;border-top:2px solid rgba(0,0,0,0.06)}
.customize-action-bar button{flex:1;padding:16px;border:none;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-reset{background:rgba(0,0,0,0.06);color:var(--ink);border:1px solid rgba(0,0,0,0.1)}
.btn-reset:hover{background:rgba(0,0,0,0.1);transform:translateY(-1px)}
.btn-apply{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink);border:1px solid var(--accent-dark);box-shadow:var(--shadow-md)}
.btn-apply:hover{box-shadow:var(--shadow-lg),0 8px 20px rgba(255,217,61,0.3);transform:translateY(-2px)}
.tutorial-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:none;animation:fadeIn 0.3s ease}
.tutorial-overlay.show{display:flex;align-items:center;justify-content:center;padding:20px}
.tutorial-spotlight{position:fixed;border-radius:12px;box-shadow:0 0 0 4px var(--accent),0 0 0 9999px rgba(0,0,0,0.85);transition:all 0.4s ease;pointer-events:none;z-index:10000}
.tutorial-tooltip{position:relative;background:var(--surface);border-radius:18px;padding:24px;max-width:450px;width:100%;box-shadow:var(--shadow-xl);z-index:10001;margin:auto}
.tutorial-tooltip h3{font-size:20px;font-weight:700;margin-bottom:12px;color:var(--ink)}
.tutorial-tooltip p{font-size:15px;line-height:1.6;color:#4b5563;margin-bottom:20px}
.tutorial-progress{display:flex;gap:8px;margin-bottom:20px;justify-content:center}
.tutorial-dot{width:8px;height:8px;border-radius:50%;background:rgba(0,0,0,0.2);transition:all 0.3s ease}
.tutorial-dot.active{background:var(--accent);width:28px;border-radius:4px}
.tutorial-actions{display:flex;gap:12px}
.tutorial-actions button{flex:1;padding:14px 20px;border:none;border-radius:12px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s ease}
.btn-skip{background:rgba(0,0,0,0.08);color:var(--muted)}
.btn-skip:hover{background:rgba(0,0,0,0.12);color:var(--ink)}
.btn-next{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink)}
.btn-next:hover{box-shadow:0 4px 12px rgba(255,217,61,0.3);transform:translateY(-1px)}
@media (max-width:640px){
  .tutorial-tooltip{padding:20px;max-width:calc(100vw - 40px)}
  .tutorial-tooltip h3{font-size:18px}
  .tutorial-tooltip p{font-size:14px}
  .tutorial-actions button{padding:12px 16px;font-size:13px}
}
@keyframes pulseMarker{
  0%{transform:translate(-50%,-50%) scale(0.6);opacity:.9}
  100%{transform:translate(-50%,-50%) scale(2.2);opacity:0}
}
</style>
</head>
<body>

<svg style="position:absolute;width:0;height:0" aria-hidden="true">
  <symbol id="i-menu" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
  <symbol id="i-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
  <symbol id="i-eye" viewBox="0 0 24 24"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></symbol>
  <symbol id="i-share" viewBox="0 0 24 24"><path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M12 3v14M7 8l5-5 5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-trash" viewBox="0 0 24 24"><path d="M4 7h16M10 11v6M14 11v6M6 7l1 12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-12M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-left" viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-right" viewBox="0 0 24 24"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-close" viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
  <symbol id="i-location" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="10" r="3" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-dice" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="8.5" cy="8.5" r="1" fill="currentColor"/><circle cx="15.5" cy="8.5" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/><circle cx="8.5" cy="15.5" r="1" fill="currentColor"/><circle cx="15.5" cy="15.5" r="1" fill="currentColor"/></symbol>
  <symbol id="i-globe" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-camera" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="13" r="4" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  <symbol id="i-home" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" fill="none" stroke="currentColor" stroke-width="2"/><polyline points="9 22 9 12 15 12 15 22" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-edit" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" fill="none" stroke="currentColor" stroke-width="2"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-palette" viewBox="0 0 24 24"><path d="M12 2a10 10 0 0 1 10 10c0 1.5-.5 2.5-1.5 2.5S19 13.5 19 12a7 7 0 1 0-14 0c0 3.86 3.14 7 7 7h1c1.5 0 2.5 1 2.5 2.5S13.5 24 12 24a12 12 0 1 1 0-24Z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="7.5" cy="10.5" r="1.5" fill="currentColor"/><circle cx="12" cy="7.5" r="1.5" fill="currentColor"/><circle cx="16.5" cy="10.5" r="1.5" fill="currentColor"/></symbol>
  <symbol id="i-sparkles" viewBox="0 0 24 24"><path d="M12 2l1.5 4.5L18 8l-4.5 1.5L12 14l-1.5-4.5L6 8l4.5-1.5L12 2zM19 13l.75 2.25L22 16l-2.25.75L19 19l-.75-2.25L16 16l2.25-.75L19 13zM5 17l.5 1.5L7 19l-1.5.5L5 21l-.5-1.5L3 19l1.5-.5L5 17z" fill="currentColor"/></symbol>
  <symbol id="i-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><line x1="12" y1="16" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="8" r="1" fill="currentColor"/></symbol>
  <symbol id="banana-pin" viewBox="0 0 256.85 291.32">
    <g>
      <path fill="#f8db8f" d="M71.1,141.02c.28,1.47.88,7.33,1.51,8.76,1.93,4.39,14.28,1.42,18.58.95-11.67-38.63-11.64-82.48,8.03-118.8,6.14-11.33,14.88-23.92,27.11-29.82l.25-1.18-4.27-.47c-25.63,3.82-45.46,48.7-50.20,69.81-4.86,21.62-5.22,49.03-1,70.76Z"/>
      <path fill="#ffeda3" d="M122.3.45l4.27.47-.25,1.18c-12.23,5.9-20.97,18.49-27.11,29.82-19.67,36.32-19.70,80.17-8.03,118.8-4.3.48-16.64,3.45-18.58-.95-.63-1.42-1.22-7.29-1.51-8.76l-25.6,2.37c11.12-2.18,20.14.12,27.11,8.76-3.44,1.89-7.15,2.97-10.54,4.97-23.54,13.89-24.41,35.07-30.12,57.27-1.14,17.15,3.46,36,12.55,50.88,6.03,9.87,22.72,28.5,36.15,25.79,1.76-21.88-7.48-39.71-6.02-62.24.91-14.08,10.81-51.24,20.08-62,8.51-9.89,29.8-18.03,36.15-2.13,1.30-5.09,1.66-9.20,5.52-13.25-1.02-2.13,6.58-7.74,6.02-9.23-.07-.19-1.78-.28-2.51-2.84-8.39-29.54-10.59-63.06-5.02-93.24,2.16-11.71,10.88-29.39,3.51-40.23-1.89-2.78-5.10-3.54-7.53-5.44-3.52-.67-5.06-.52-8.53,0Z"/>
      <path fill="#ffdb27" d="M80.64,291.05c15.58-3.14,4.71-25.51,3.01-35.26-3.34-19.23-3.22-36.25,2.01-55.14,2.36-8.51,11.33-33.16,19.33-37.39,5.51-2.92,10.89-2.02,16.82-.95,3.42.62,5.45,2.59,9.04,2.37-6.35-15.90-27.63-7.76-36.15,2.13-9.27,10.76-19.17,47.93-20.08,62-1.45,22.52,7.78,40.35,6.02,62.24Z"/>
      <path fill="#ffc910" d="M18.89,251.30c6.47-3.93,7.28-19.33,9.04-26.27.88-3.45,3.38-8.16,4.02-10.65,5.71-22.20,6.59-43.38,30.12-57.27.11-2.35,4.35-1.54,3.01-3.55-21.74-19.04-42.85,15.37-49.20,30.29-6.43,15.12-13.02,38.46-11.04,56.32.93,8.39,3.70,17.42,14.06,11.12Z"/>
      <path fill="#ffdb27" d="M45.49,143.38C12.83,149.77-5.18,217.75,1.31,243.96c2.27,9.18,8.63,14.45,17.57,7.34-10.36,6.29-13.13-2.73-14.06-11.12-1.97-17.86,4.62-41.20,11.04-56.32,6.34-14.93,27.46-49.33,49.20-30.29,1.33,2.01-2.91,1.20-3.01,3.55,3.39-2,7.10-3.08,10.54-4.97-6.97-8.64-15.99-10.93-27.11-8.76Z"/>
      <path fill="#ffdb27" d="M226.68,282.86c-29.25,13.86-88.77-31.06-120.23-78.80-3.94-5.99-13.84-37.32,9.80-43.50,1.53-.40,2.62-.50,3.61-.38,1.80.23,2.92.93,4.51,1.76,1.39.73,3.46,1.70,6.18,2.59.19-1.78.84-4.19,1.80-7.01.74-2.17,1.79-4.21,3.72-6.24,50.98-39.77,88.26,30.02,110.95,64.13,2.34,3,5.81,7.55,9.54,8.76.38,4.53-3.49,5.60-7.78,4.73-5.68-1.15-15.85-23.65-19.33-29.11-11.19-17.56-35.92-53.71-59.49-55.14-8.08-.49-13.28,2.20-14.31,10.18-1.71,13.24,30.61,61.14,74.30,98.45,3.01,2.57,10.69,9.03,9.79,16.33-.93,7.50-10.45,12.02-13.05,13.25Z"/>
      <path fill="#ffc910" d="M227.35,283c-8.08-.83-17.63-2.33-25.60-3.61-28.79-4.62-83.79-52-94.63-77.38-2.57-6.02-9.42-29.07.79-37.25,6.96-5.58,18.77-1.65,22.94-.07-2.37-1.63-6.59-4.07-12.37-5.03-3.50-.58-6.53-.45-8.78-.16,0,0,0,0,0,0,0,0-2.19.37-4.33,1.57-6.53,3.68-11.30,12.65-11.30,12.65-4.63,8.69-6.90,17.53-8.02,24.75,6.18,10.25,15.37,24.34,28.93,39.03,11.07,12,23.42,22.98,36.59,32.91,15.18,11.45,37.24,23.97,61.16,18.46,6.38-1.47,11.36-3.93,14.65-5.85Z"/>
      <path fill="#34af0e" d="M232.29,255.34c.65,2.52,2.01,9.24-.91,16.82-4.04,10.51-16.83,15.88-18.68,16.69,2.72.60,12.47.42,19.22-2.27,2.52-1,12.08-4.84,13.35-13.11,1.15-7.51-4.18-15.66-12.98-18.14Z"/>
    </g>
  </symbol>
</svg>

<div class="tutorial-overlay" id="tutorialOverlay">
  <div class="tutorial-spotlight" id="tutorialSpotlight"></div>
  <div class="tutorial-tooltip" id="tutorialTooltip">
    <h3 id="tutorialTitle"></h3>
    <p id="tutorialText"></p>
    <div class="tutorial-progress" id="tutorialProgress"></div>
    <div class="tutorial-actions">
      <button class="btn-skip" id="tutorialSkip">Skip</button>
      <button class="btn-next" id="tutorialNext">Next</button>
    </div>
  </div>
</div>

<div class="header">
  <div class="brand" id="brandBtn" title="Return to world view">
    <svg class="brand-icon" viewBox="0 0 256.85 291.32"><use href="#banana-pin"/></svg>
    <span>banana.place</span>
  </div>
  <div class="hgroup">
    <button class="iconbtn" id="toggleSearch" title="Search locations"><svg class="icon"><use href="#i-search"/></svg></button>
    <button class="iconbtn" id="toggleMenu" title="Menu"><svg class="icon"><use href="#i-menu"/></svg></button>
  </div>
</div>

<div class="search-panel" id="searchPanel">
  <div class="search-input-wrapper">
    <svg class="icon search-icon"><use href="#i-search"/></svg>
    <input type="text" id="searchInput" placeholder="Search any location..." autocomplete="off">
  </div>
  <div class="search-results" id="searchResults"></div>
</div>

<div class="menu" id="menu">
  <div class="row" id="seeMine"><svg class="icon"><use href="#i-eye"/></svg><span>View My Banana</span></div>
<div class="row" id="customizeMine"><svg class="icon"><use href="#i-sparkles"/></svg><span>Customize My Banana</span></div>
  <div class="row" id="shareMine"><svg class="icon"><use href="#i-share"/></svg><span>Share My Banana</span></div>
  <div class="row" id="deleteMine"><svg class="icon"><use href="#i-trash"/></svg><span style="color:var(--warn)">Delete My Banana</span></div>
  <div class="split"></div>
  <div class="row" id="randomBanana"><svg class="icon"><use href="#i-dice"/></svg><span>Random Banana</span></div>
  <div class="row" id="browseBananas"><svg class="icon"><use href="#i-globe"/></svg><span>Browse All</span></div>
  <div class="split"></div>
  <div class="row" id="showTutorial"><svg class="icon"><use href="#i-info"/></svg><span>How It Works</span></div>
</div>

<div class="stats">
  <div class="stats-item">
    <svg class="banana-mini" viewBox="0 0 256.85 291.32"><use href="#banana-pin"/></svg>
    <span>Total</span>
    <span class="count" id="totalCount">0</span>
  </div>
</div>

<div class="controls">
  <button class="quick-btn" id="locateBtn" title="My location"><svg class="icon"><use href="#i-location"/></svg></button>
  <button class="quick-btn" id="homeBtn" title="World view"><svg class="icon"><use href="#i-home"/></svg></button>
  <button id="dropBtn" class="fab"><svg class="icon-lg"><use href="#i-plus"/></svg><span>Drop Banana</span></button>
</div>

<div id="map"></div>
<div id="toastContainer"></div>

<div class="prompt-overlay" id="promptOverlay"></div>
<div class="prompt-dialog" id="promptDialog">
  <h3 id="promptTitle">Name this stop</h3>
  <p id="promptMessage">Give this location a memorable name</p>
  <input type="text" id="promptInput" placeholder="e.g., Coffee shop visit" maxlength="50" style="display:block">
  <textarea id="promptTextarea" placeholder="Add notes about this stop..." maxlength="200" style="display:none"></textarea>
  <div class="prompt-actions">
    <button class="btn-secondary" id="promptCancel">Cancel</button>
    <button class="btn-primary" id="promptConfirm">Confirm</button>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay"></div>
<div class="modal" id="modal">
  <div class="modal-content">
    <button class="modal-close" id="modalClose"><svg class="icon"><use href="#i-close"/></svg></button>
    <div class="modal-body">
      <div class="modal-header">
        <h3 id="modalTitle">Banana</h3>
        <div class="modal-meta" id="modalMeta"></div>
      </div>
      <div id="modalReactions"></div>
      <p class="modal-message" id="modalMessage" style="display:none"></p>
      <div id="modalPhotoGallery" style="display:none"></div>
      <div id="modalCustomize" style="display:none"></div>
    </div>
    <div class="modal-actions" id="modalActions" style="display:none">
      <button class="action-edit" id="modalEdit"><svg class="icon"><use href="#i-edit"/></svg>Edit</button>
      <button class="action-customize" id="modalCustomizeBtn"><svg class="icon"><use href="#i-palette"/></svg>Style</button>
      <button class="action-delete" id="modalDelete"><svg class="icon"><use href="#i-trash"/></svg>Delete</button>
    </div>
  </div>
</div>

<div class="sheet" id="sheet">
  <div class="grab"></div>
  <h3 id="sheetTitle">Drop a Banana</h3>
  <p class="subtitle" id="sheetSubtitle">Share your moment with the world</p>
  <label for="name">Your Name</label>
  <input id="name" type="text" placeholder="What should we call you?" maxlength="50">
  <label for="msg">Message</label>
  <textarea id="msg" rows="4" placeholder="Share something fun, inspiring, or interesting..." maxlength="500"></textarea>
  <div class="char-count" id="charCount">0/500</div>
  <label>Photos (Optional - up to 5)</label>
  <div class="file-upload">
    <label for="photo" class="file-upload-label">
      <svg class="icon-lg"><use href="#i-camera"/></svg>
      <span class="file-upload-text">Add Photos</span>
      <span class="file-upload-hint">JPG or PNG ‚Ä¢ Auto-resized for upload</span>
    </label>
    <input id="photo" type="file" accept="image/*" multiple>
  </div>
  <div class="previews" id="previews"></div>
  <div class="privacy-option">
    <input type="checkbox" id="approxLocation">
    <label for="approxLocation">üìç Use approximate location (more privacy)</label>
  </div>
  <div class="sheet-actions">
    <button class="btn-secondary" id="cancelBtn">Cancel</button>
    <button class="btn-primary" id="saveBtn">Save Banana</button>
  </div>
  <div class="footer" style="margin-top:16px;color:var(--muted);font-size:10px;text-align:center">Powered by Nominatim ‚Ä¢ Map ¬© OpenStreetMap & CARTO</div>
</div>

<script>
const BIN_ID="68f0265443b1c97be96a4ad5",API_KEY="$2a$10$RCnUKDWytC/ysiMgbX6/q.QRSKrLrAOPSOsZVPFYaaW06lur2V5X6",BIN_URL=`https://api.jsonbin.io/v3/b/${BIN_ID}`,DEVICE_KEY='banana_device_id',DROPPED_KEY='banana_already_dropped',TUTORIAL_KEY='banana_tutorial_seen';
let deviceId=localStorage.getItem(DEVICE_KEY);
if(!deviceId){
  deviceId=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
  localStorage.setItem(DEVICE_KEY,deviceId);
}

const BASE_SVG_URL='https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/base.svg';
const HEAD_SVG_URLS={
  default:null,
  backcap:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/backcap.svg',
  cat:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/cat.svg',
  chef:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/chef.svg',
  detective:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/detective.svg',
  explorer:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/explorer.svg',
  funcap:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/funcap.svg',
  wizard:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/wizard.svg',
  artcap:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/artcap.svg',
  beanie:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/beanie.svg',
  sailorcap:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/heads/sailorcap.svg',
};
const ACCESSORY_SVG_URLS={
  default:null,
  backpack:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/accessories/backpack.svg',
  shades:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/accessories/shades.svg',
  hearts:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/accessories/hearts.svg',
};
const SHIRT_SVG_URLS={
  default:null,
  bowtie:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/shirts/bowtie.svg',
  suit:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/shirts/suit.svg',
  overalls:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/shirts/overalls.svg',
  shirt:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/shirts/shirt.svg',
  green:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/shirts/green.svg',
  sailor:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/shirts/sailor.svg',
  art:'https://raw.githubusercontent.com/telltonyroni/banana/refs/heads/main/svgs/shirts/art.svg',
};

const svgCache={};
const fetchText=async url=>{
  if(!url)return'';
  if(svgCache[url])return svgCache[url];
  const res=await fetch(url);
  const txt=await res.text();
  svgCache[url]=txt;
  return txt;
};

const VIEWBOX='0 0 308 574';
const stripOuterSVG=s=>{
  if(!s)return'';
  const open=s.indexOf('<svg');
  const close=s.lastIndexOf('</svg>');
  if(open!==-1&&close!==-1){
    const innerStart=s.indexOf('>',open)+1;
    return s.slice(innerStart,close).trim();
  }
  return s.trim();
};

const getCompositeBananaSVG=async(head,accessory,shirt)=>{
  const[base,shirtSVG,accessorySVG,headSVG]=await Promise.all([
    fetchText(BASE_SVG_URL),
    fetchText(SHIRT_SVG_URLS[shirt]||null),
    fetchText(ACCESSORY_SVG_URLS[accessory]||null),
    fetchText(HEAD_SVG_URLS[head]||null),
  ]);
  return`
    <svg viewBox="${VIEWBOX}" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
      <g class="banana-base">${stripOuterSVG(base)}</g>
      ${shirtSVG?`<g class="banana-shirt">${stripOuterSVG(shirtSVG)}</g>`:''}
      ${accessorySVG?`<g class="banana-accessory">${stripOuterSVG(accessorySVG)}</g>`:''}
      ${headSVG?`<g class="banana-head">${stripOuterSVG(headSVG)}</g>`:''}
    </svg>
  `;
};

const CUSTOMIZATION_OPTIONS={
  head:[
    {value:'default',label:'None'},
    {value:'backcap',label:'Back Cap'},
    {value:'artcap',label:'Art Cap'},
    {value:'beanie',label:'Beanie'},
    {value:'sailorcap',label:'Sailor Cap'},
    {value:'cat',label:'Cat'},
    {value:'chef',label:'Chef'},
    {value:'detective',label:'Detective'},
    {value:'explorer',label:'Explorer'},
    {value:'funcap',label:'Fun Cap'},
    {value:'wizard',label:'Wizard'},
  ],
  accessory:[
    {value:'default',label:'None'},
    {value:'shades',label:'Shades'},
    {value:'backpack',label:'Backpack'},
    {value:'hearts',label:'Hearts'},
  ],
  shirt:[
    {value:'default',label:'None'},
    {value:'bowtie',label:'Bow Tie'},
    {value:'suit',label:'Suit'},
    {value:'overalls',label:'Overalls'},
    {value:'shirt',label:'Shirt'},
    {value:'green',label:'Green Tee'},
    {value:'sailor',label:'Sailor'},
    {value:'art',label:'Art Smock'},
  ]
};

const resizeImage=(file,maxW=1200,maxH=1200,q=0.8)=>new Promise((res,rej)=>{
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      let w=img.width,h=img.height;
      if(w>h){if(w>maxW){h*=maxW/w;w=maxW}}else{if(h>maxH){w*=maxH/h;h=maxH}}
      canvas.width=w;canvas.height=h;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      canvas.toBlob(blob=>{
        const r2=new FileReader();
        r2.onload=ev=>res(ev.target.result);
        r2.onerror=rej;
        r2.readAsDataURL(blob);
      },'image/jpeg',q);
    };
    img.onerror=rej;
    img.src=e.target.result;
  };
  reader.onerror=rej;
  reader.readAsDataURL(file);
});

const esc=s=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const timeAgo=t=>{const s=Math.floor((Date.now()-t)/1000);if(s<60)return'just now';const m=Math.floor(s/60);if(m<60)return`${m}m ago`;const h=Math.floor(m/60);if(h<24)return`${h}h ago`;const d=Math.floor(h/24);if(d<30)return`${d}d ago`;const mo=Math.floor(d/30);if(mo<12)return`${mo}mo ago`;return`${Math.floor(mo/12)}y ago`};
const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
const getVagueLocation=addr=>{if(!addr)return'Unknown';const parts=addr.split(',').map(p=>p.trim());if(parts.length>=2){const city=parts[parts.length-3]||parts[0];const region=parts[parts.length-2];return`Near ${city}, ${region}`}return`Near ${parts[0]}`};
const approximateCoords=(lat,lng)=>{const offset=0.01;return{lat:lat+(Math.random()-0.5)*offset,lng:lng+(Math.random()-0.5)*offset}};

let promptResolve=null,promptMode='input';
const showPrompt=(title,message,defaultValue='',mode='input')=>{
  return new Promise((resolve)=>{
    promptResolve=resolve;
    promptMode=mode;
    document.getElementById('promptTitle').textContent=title;
    document.getElementById('promptMessage').textContent=message;
    if(mode==='textarea'){
      document.getElementById('promptInput').style.display='none';
      document.getElementById('promptTextarea').style.display='block';
      document.getElementById('promptTextarea').value=defaultValue;
      setTimeout(()=>document.getElementById('promptTextarea').focus(),100);
    }else{
      document.getElementById('promptInput').style.display='block';
      document.getElementById('promptTextarea').style.display='none';
      document.getElementById('promptInput').value=defaultValue;
      setTimeout(()=>document.getElementById('promptInput').focus(),100);
    }
    document.getElementById('promptOverlay').classList.add('show');
    document.getElementById('promptDialog').classList.add('show');
  });
};
const closePrompt=(value=null)=>{
  document.getElementById('promptOverlay').classList.remove('show');
  document.getElementById('promptDialog').classList.remove('show');
  if(promptResolve){
    promptResolve(value);
    promptResolve=null;
  }
};
document.getElementById('promptCancel').onclick=()=>closePrompt(null);
document.getElementById('promptConfirm').onclick=()=>{
  const value=promptMode==='textarea'?document.getElementById('promptTextarea').value.trim():document.getElementById('promptInput').value.trim();
  closePrompt(value||null);
};
document.getElementById('promptInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const value=document.getElementById('promptInput').value.trim();
    closePrompt(value||null);
  }else if(e.key==='Escape'){
    closePrompt(null);
  }
});
document.getElementById('promptOverlay').onclick=()=>closePrompt(null);

let map,bananasCache=[],domMarkers=[],refreshHandle;
const toast=(msg,type='info',dur=2500)=>{
  const c=document.getElementById('toastContainer'),iconMap={success:'i-check',error:'i-alert',info:'i-info'};
  c.innerHTML=`<div class="toast ${type}"><svg class="icon"><use href="#${iconMap[type]}"/></svg><span>${msg}</span></div>`;
  if(dur>0)setTimeout(()=>c.innerHTML='',dur)
};
const pulseAt=(lng,lat)=>{
  const d=document.createElement('div');
  d.style.cssText=`width:18px;height:18px;border-radius:50%;border:3px solid #FFD93D;position:absolute;transform:translate(-50%,-50%);pointer-events:none;opacity:.9`;
  const m=new maplibregl.Marker({element:d}).setLngLat([lng,lat]).addTo(map);
  d.style.animation='pulseMarker 900ms ease-out forwards';
  setTimeout(()=>m.remove(),900)
};

const makeStyle=()=>{
  const sub=['a','b','c','d'],
    base='https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
    labels='https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png';
  return{
    version:8,
    glyphs:'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources:{
      base:{type:'raster',tiles:sub.map(s=>base.replace('{s}',s)),tileSize:256},
      labels:{type:'raster',tiles:sub.map(s=>labels.replace('{s}',s)),tileSize:256},
      bananas:{type:'geojson',data:{type:'FeatureCollection',features:[]},cluster:true,clusterRadius:50}
    },
    layers:[
      {id:'base',type:'raster',source:'base'},
      {id:'labels',type:'raster',source:'labels',paint:{'raster-opacity':.65}},
      {id:'clusters',type:'circle',source:'bananas',filter:['has','point_count'],paint:{'circle-color':'#FFE066','circle-stroke-width':2,'circle-stroke-color':'#E0C24B','circle-radius':['step',['get','point_count'],15,10,19,25,24]}},
      {id:'cluster-count',type:'symbol',source:'bananas',filter:['has','point_count'],layout:{'text-field':['get','point_count_abbreviated'],'text-size':12,'text-font':['Open Sans Bold','Arial Unicode MS Bold']},paint:{'text-color':'#222'}}
    ]
  }
};

const asFeat=b=>({
  type:'Feature',
  properties:{
    deviceId:b.deviceId||'',
    name:b.name||'',
    msg:b.msg||'',
    photos:b.photos||[b.photo]||[],
    ts:b.ts||0,
    locationHistory:b.locationHistory||[],
    comments:b.comments||[],
    reactions:b.reactions||[],
    head:b.head||'default',
    accessory:b.accessory||'default',
    shirt:b.shirt||'default',
  },
  geometry:{type:'Point',coordinates:[b.lng,b.lat]}
});

const clearMarkers=()=>{domMarkers.forEach(m=>m.remove());domMarkers=[]};

const createMarker=async feat=>{
  const el=document.createElement('div');
  el.className='banana-marker';
  if(feat.properties.deviceId===deviceId)el.className+=' mine';
  const head=feat.properties.head||'default';
  const accessory=feat.properties.accessory||'default';
  const shirt=feat.properties.shirt||'default';
  el.innerHTML=await getCompositeBananaSVG(head,accessory,shirt);
  const openModal=ev=>{
    ev.preventDefault();
    ev.stopPropagation();
    showBananaModal(feat.properties);
  };
  ['pointerdown','touchstart','mousedown'].forEach(type=>el.addEventListener(type,e=>e.stopPropagation(),{passive:true}));
  el.addEventListener('pointerup',openModal);
  el.addEventListener('touchend',openModal);
  el.addEventListener('click',openModal);
  return new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(feat.geometry.coordinates);
};

const renderMarkers=async geojson=>{
  clearMarkers();
  if(map.getLayer('trails'))map.removeLayer('trails');
  if(map.getSource('trails'))map.removeSource('trails');
  const trailFeatures=[];
  for(const f of geojson.features){
    if(f.properties.point_count)continue;
    const m=await createMarker(f);
    m.addTo(map);
    domMarkers.push(m);
    const history=f.properties.locationHistory||[];
    if(history.length>1){
      trailFeatures.push({
        type:'Feature',
        properties:{deviceId:f.properties.deviceId},
        geometry:{type:'LineString',coordinates:history.map(h=>[h.lng,h.lat])}
      })
    }
  };
  if(trailFeatures.length>0){
    map.addSource('trails',{type:'geojson',data:{type:'FeatureCollection',features:trailFeatures}});
    map.addLayer({
      id:'trails',
      type:'line',
      source:'trails',
      paint:{'line-color':'#FFD93D','line-width':3,'line-opacity':0.6,'line-dasharray':[2,2]},
      'layout':{'line-cap':'round','line-join':'round'}
    },'clusters')
  }
};

const updateStats=count=>{document.getElementById('totalCount').textContent=count};
const fetchLatest=async()=>{
  const res=await fetch(`${BIN_URL}/latest`,{headers:{"X-Master-Key":API_KEY}});
  if(!res.ok)throw new Error('Load failed');
  return res.json()
};
const putBananas=async arr=>{
  const res=await fetch(BIN_URL,{method:'PUT',headers:{"X-Master-Key":API_KEY,"Content-Type":"application/json"},body:JSON.stringify({bananas:arr})});
  if(!res.ok)throw new Error('Save failed')
};

const loadBananas=async()=>{
  try{
    const data=await fetchLatest();
    bananasCache=data.record?.bananas||[];
    const feats=bananasCache.filter(b=>typeof b.lat==='number'&&typeof b.lng==='number').map(asFeat);
    const src=map.getSource('bananas');
    if(src)src.setData({type:'FeatureCollection',features:feats});
    renderMarkers({type:'FeatureCollection',features:feats});
    updateStats(feats.length);
    const already=bananasCache.some(b=>b.deviceId===deviceId)||localStorage.getItem(DROPPED_KEY)==='true';
    document.getElementById('dropBtn').disabled=already;
    document.getElementById('dropBtn').querySelector('span').textContent=already?"Banana Dropped":"Drop Banana";
    ['seeMine','shareMine','deleteMine','customizeMine'].forEach(id=>document.getElementById(id).classList.toggle('disabled',!already))
  }catch(e){
    console.error(e);
    toast('Load failed','error',3000)
  }
};

const reactToBanana=async(bananaDeviceId,reactionType)=>{
  try{
    const data=await fetchLatest();
    const bananas=data.record?.bananas||[];
    const idx=bananas.findIndex(b=>b.deviceId===bananaDeviceId);
    if(idx===-1){toast('Banana not found','error',2000);return}
    if(!bananas[idx].reactions)bananas[idx].reactions=[];
    const existingIdx=bananas[idx].reactions.findIndex(r=>r.deviceId===deviceId);
    if(existingIdx!==-1){
      if(bananas[idx].reactions[existingIdx].type===reactionType){
        bananas[idx].reactions.splice(existingIdx,1);
      }else{
        bananas[idx].reactions[existingIdx].type=reactionType;
      }
    }else{
      bananas[idx].reactions.push({deviceId,type:reactionType,ts:Date.now()});
    }
    await fetch(BIN_URL,{method:'PUT',headers:{"X-Master-Key":API_KEY,"Content-Type":"application/json"},body:JSON.stringify({...data.record,bananas})});
    await loadBananas();
    const updatedBanana=bananasCache.find(b=>b.deviceId===bananaDeviceId);
    if(updatedBanana){
      renderReactions(bananaDeviceId,updatedBanana.reactions||[],document.getElementById('modalReactions'));
    }
  }catch(e){
    console.error(e);
    toast('Reaction failed','error',2000);
  }
};

const renderReactions=(bananaDeviceId,reactions,container)=>{
  if(!container)return;
  const reactionTypes=[
    {type:'like',emoji:'üëç',label:'Like'},
    {type:'love',emoji:'‚ù§Ô∏è',label:'Love'},
    {type:'fire',emoji:'üî•',label:'Fire'}
  ];
  const counts={};
  reactionTypes.forEach(r=>counts[r.type]=0);
  reactions.forEach(r=>{
    if(counts[r.type]!==undefined)counts[r.type]++;
  });
  const myReaction=reactions.find(r=>r.deviceId===deviceId);
  container.innerHTML=`<div class="reactions-bar">${reactionTypes.map(r=>{
    const isActive=myReaction&&myReaction.type===r.type;
    return`<button class="reaction-btn ${isActive?'active':''}" data-type="${r.type}" data-banana="${bananaDeviceId}">
      <span class="reaction-emoji">${r.emoji}</span>
      ${counts[r.type]>0?`<span class="reaction-count">${counts[r.type]}</span>`:''}
    </button>`;
  }).join('')}</div>`;
  container.querySelectorAll('.reaction-btn').forEach(btn=>{
    btn.onclick=()=>reactToBanana(btn.dataset.banana,btn.dataset.type);
  });
};

const customizeBanana=async(head,accessory,shirt)=>{
  try{
    const data=await fetchLatest();
    const bananas=data.record?.bananas||[];
    const idx=bananas.findIndex(b=>b.deviceId===deviceId);
    if(idx===-1){toast('No banana to customize','error',2000);return}
    bananas[idx].head=head;
    bananas[idx].accessory=accessory;
    bananas[idx].shirt=shirt||'default';
    await putBananas(bananas);
    await loadBananas();
    toast('Banana customized!','success',2000);
  }catch(e){
    console.error(e);
    toast('Customize failed','error',2000);
  }
};

const showCustomizeModal=async()=>{
  const data=await fetchLatest();
  const banana=data.record?.bananas?.find(b=>b.deviceId===deviceId);
  if(!banana){toast('Drop a banana first','info',2000);return}
  
  let selections={
    head:banana.head||'default',
    accessory:banana.accessory||'default',
    shirt:banana.shirt||'default'
  };
  
  let activeCategory='head';
  
  const updatePreview=async()=>{
    const preview=document.getElementById('customizePreviewSVG');
    preview.classList.add('changing');
    setTimeout(async()=>{
      preview.innerHTML=await getCompositeBananaSVG(selections.head,selections.accessory,selections.shirt);
      setTimeout(()=>preview.classList.remove('changing'),50);
    },200);
  };
  
  const renderCategory=category=>{
    const grid=document.getElementById('customizeGrid');
    grid.innerHTML=CUSTOMIZATION_OPTIONS[category].map(opt=>{
      const isNone=opt.value==='default';
      const isSelected=selections[category]===opt.value;
      return`<div class="customize-option ${isNone?'none-option':''} ${isSelected?'selected':''}" data-value="${opt.value}" data-category="${category}">
        <div class="customize-option-preview" id="preview-${category}-${opt.value}"></div>
        <div class="customize-option-label">${esc(opt.label)}</div>
      </div>`;
    }).join('');
    
    setTimeout(async()=>{
      for(const opt of CUSTOMIZATION_OPTIONS[category]){
        if(opt.value==='default')continue;
        const el=document.getElementById(`preview-${category}-${opt.value}`);
        if(el){
          const tempSel={head:'default',accessory:'default',shirt:'default'};
          tempSel[category]=opt.value;
          el.innerHTML=await getCompositeBananaSVG(tempSel.head,tempSel.accessory,tempSel.shirt);
        }
      }
    },50);
    
    grid.querySelectorAll('.customize-option').forEach(opt=>{
      opt.onclick=()=>{
        const cat=opt.dataset.category;
        const val=opt.dataset.value;
        selections[cat]=val;
        renderCategory(cat);
        updatePreview();
      };
    });
  };
  
  const customizeHTML=`
    <div class="customize-modal">
      <div class="customize-header">
        <div class="customize-stage">
          <div class="customize-preview-svg" id="customizePreviewSVG"></div>
        </div>
        <div class="customize-info">
          <h4>üé® Customize Your Banana</h4>
          <p>Give your banana a unique look! Choose from hats, accessories, and outfits to make it stand out on the map.</p>
        </div>
      </div>
      
      <div class="customize-tabs">
        <button class="customize-tab active" data-category="head">üëí Hats</button>
        <button class="customize-tab" data-category="accessory">üéí Gear</button>
        <button class="customize-tab" data-category="shirt">üëï Outfits</button>
      </div>
      
      <div class="customize-grid" id="customizeGrid"></div>
      
      <div class="customize-action-bar">
        <button class="btn-reset" id="resetCustomize">
          <svg class="icon"><use href="#i-trash"/></svg>
          Reset
        </button>
        <button class="btn-apply" id="applyCustomize">
          <svg class="icon"><use href="#i-sparkles"/></svg>
          Apply
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('modalTitle').textContent='Customize Your Banana';
  document.getElementById('modalMeta').textContent='Make it unique!';
  document.getElementById('modalReactions').innerHTML='';
  document.getElementById('modalMessage').style.display='none';
  document.getElementById('modalPhotoGallery').style.display='none';
  document.getElementById('modalActions').style.display='none';
  
  const customizeDiv=document.getElementById('modalCustomize');
  customizeDiv.innerHTML=customizeHTML;
  customizeDiv.style.display='block';
  
  document.getElementById('modalOverlay').classList.add('show');
  document.getElementById('modal').classList.add('show');
  
  updatePreview();
  renderCategory('head');
  
  document.querySelectorAll('.customize-tab').forEach(tab=>{
    tab.onclick=()=>{
      document.querySelectorAll('.customize-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      activeCategory=tab.dataset.category;
      renderCategory(activeCategory);
    };
  });
  
  document.getElementById('resetCustomize').onclick=()=>{
    selections={head:'default',accessory:'default',shirt:'default'};
    renderCategory(activeCategory);
    updatePreview();
    toast('Reset to default','info',1500);
  };
  
  document.getElementById('applyCustomize').onclick=async()=>{
    await customizeBanana(selections.head,selections.accessory,selections.shirt);
    closeModal();
  };
};

const showBananaModal=p=>{
  document.getElementById('modalTitle').textContent=p.name||'Anonymous';
  document.getElementById('modalMeta').textContent=p.ts?timeAgo(p.ts):'';
  renderReactions(p.deviceId,p.reactions||[],document.getElementById('modalReactions'));
  const msg=document.getElementById('modalMessage');
  if(p.msg){msg.textContent=p.msg;msg.style.display='block'}else{msg.style.display='none'}
  const gallery=document.getElementById('modalPhotoGallery');
  const photos=p.photos||[p.photo]||[];
  photos.filter(ph=>ph).length>0?(()=>{
    gallery.innerHTML='';
    photos.filter(ph=>ph).forEach((ph,i)=>{
      const img=document.createElement('img');
      img.src=ph;
      img.alt=`Photo ${i+1}`;
      gallery.appendChild(img)
    });
    gallery.style.display='flex'
  })():(gallery.style.display='none',gallery.innerHTML='');
  document.getElementById('modalCustomize').style.display='none';
  const actions=document.getElementById('modalActions');
  if(p.deviceId===deviceId){
    actions.style.display='flex';
    document.getElementById('modalEdit').onclick=()=>{
      closeModal();
      openSheet('edit',{lat:0,lng:0,...p})
    };
    document.getElementById('modalCustomizeBtn').onclick=()=>{
      closeModal();
      setTimeout(showCustomizeModal,300);
    };
    document.getElementById('modalDelete').onclick=()=>{
      closeModal();
      deleteMyBanana()
    }
  }else{
    actions.style.display='none'
  }
  document.getElementById('modalOverlay').classList.add('show');
  document.getElementById('modal').classList.add('show')
};

const closeModal=()=>{
  document.getElementById('modalOverlay').classList.remove('show');
  document.getElementById('modal').classList.remove('show')
};
document.getElementById('modalOverlay').onclick=closeModal;
document.getElementById('modalClose').onclick=closeModal;

const wireSearch=()=>{
  const panel=document.getElementById('searchPanel'),input=document.getElementById('searchInput'),results=document.getElementById('searchResults'),toggle=document.getElementById('toggleSearch');
  toggle.onclick=()=>{
    const open=panel.classList.toggle('show');
    toggle.classList.toggle('active',open);
    if(open)input.focus();
    else{input.value='';results.classList.remove('show')}
  };
  document.addEventListener('click',e=>{
    if(!panel.contains(e.target)&&e.target!==toggle){
      panel.classList.remove('show');
      toggle.classList.remove('active');
      input.value='';
      results.classList.remove('show')
    }
  });
  const searchLoc=async q=>{
    if(!q.trim()){results.classList.remove('show');return}
    try{
      const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=8`);
      const data=await res.json();
      results.innerHTML='';
      if(!data||!data.length){
        results.innerHTML='<div class="search-result-item"><small>No results</small></div>'
      }else{
        data.forEach(r=>{
          const item=document.createElement('div');
          item.className='search-result-item';
          const name=r.display_name.split(',')[0];
          item.innerHTML=`<div class="icon-wrapper"><svg class="icon"><use href="#i-location"/></svg></div><div class="text"><strong>${esc(name)}</strong><small>${esc(r.display_name)}</small></div>`;
          item.onclick=()=>{
            map.easeTo({center:[+r.lon,+r.lat],zoom:14,duration:800});
            panel.classList.remove('show');
            toggle.classList.remove('active');
            input.value='';
            results.classList.remove('show');
            toast(name,'info',2000)
          };
          results.appendChild(item)
        })
      }
      results.classList.add('show')
    }catch(e){console.error(e)}
  };
  input.addEventListener('input',debounce(()=>searchLoc(input.value),400));
  input.addEventListener('keydown',e=>{if(e.key==='Enter')searchLoc(input.value)})
};

const goWorld=()=>{
  map.easeTo({center:[0,20],zoom:2,duration:900});
  toast('World view','info',1200)
};

const wireUI=()=>{
  wireSearch();
  const menu=document.getElementById('menu'),toggleMenu=document.getElementById('toggleMenu');
  toggleMenu.onclick=()=>{
    const open=menu.classList.toggle('show');
    toggleMenu.classList.toggle('active',open)
  };
  document.addEventListener('click',e=>{
    if(!menu.contains(e.target)&&e.target!==toggleMenu){
      menu.classList.remove('show');
      toggleMenu.classList.remove('active')
    }
  });
  document.getElementById('brandBtn').onclick=goWorld;
  document.getElementById('homeBtn').onclick=goWorld;
  const dropBtn=document.getElementById('dropBtn');
  dropBtn.onclick=()=>{
    if(dropBtn.disabled){toast('Already dropped','info',2000);return}
    const openForm=(lat,lng)=>{
      map.easeTo({center:[lng,lat],zoom:17,duration:800});
      setTimeout(()=>openSheet('add',{lat,lng}),400)
    };
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(({coords:{latitude,longitude}})=>openForm(latitude,longitude),()=>{
        const c=map.getCenter();
        openForm(c.lat,c.lng)
      },{enableHighAccuracy:true,timeout:6000})
    }else{
      const c=map.getCenter();
      openForm(c.lat,c.lng)
    }
  };
  document.getElementById('locateBtn').onclick=()=>{
    if(!navigator.geolocation)return;
    toast('Locating...','info',1500);
    navigator.geolocation.getCurrentPosition(({coords:{latitude,longitude}})=>{
      map.easeTo({center:[longitude,latitude],zoom:14,duration:800});
      toast('You are here','success',2000)
    },()=>toast('Location unavailable','error',2000),{enableHighAccuracy:true,timeout:8000})
  };
  document.getElementById('seeMine').onclick=async()=>{
    if(document.getElementById('seeMine').classList.contains('disabled')){toast("No banana yet",'info',2000);return}
    try{
      const data=await fetchLatest();
      const b=(data.record?.bananas||[]).find(x=>x.deviceId===deviceId);
      if(!b){toast("No banana yet",'info',2000);return}
      map.easeTo({center:[b.lng,b.lat],zoom:17,duration:1000});
      pulseAt(b.lng,b.lat);
      toast("Your banana",'success',2000);
      menu.classList.remove('show');
      toggleMenu.classList.remove('active');
      setTimeout(()=>showBananaModal(b),500)
    }catch(e){toast('Error','error',2000)}
  };
  document.getElementById('customizeMine').onclick=()=>{
    if(document.getElementById('customizeMine').classList.contains('disabled')){toast('Drop a banana first','info',2000);return}
    menu.classList.remove('show');
    toggleMenu.classList.remove('active');
    showCustomizeModal();
  };
  document.getElementById('shareMine').onclick=async()=>{
    if(document.getElementById('shareMine').classList.contains('disabled')){toast("Drop first",'info',2000);return}
    try{
      const data=await fetchLatest();
const b=(data.record?.bananas||[]).find(x=>x.deviceId===deviceId);
      if(!b){toast("Drop first",'info',2000);return}
      const url=new URL(location.href);
      url.searchParams.set('id',deviceId);
      await navigator.clipboard.writeText(url.toString());
      toast("Link copied!",'success',2000);
      menu.classList.remove('show');
      toggleMenu.classList.remove('active')
    }catch(e){toast('Copy failed','error',2000)}
  };
  document.getElementById('deleteMine').onclick=()=>{
    if(document.getElementById('deleteMine').classList.contains('disabled')){toast("No banana",'info',2000);return}
    menu.classList.remove('show');
    toggleMenu.classList.remove('active');
    deleteMyBanana()
  };
  document.getElementById('randomBanana').onclick=()=>{
    menu.classList.remove('show');
    toggleMenu.classList.remove('active');
    goRandomBanana()
  };
  document.getElementById('browseBananas').onclick=()=>{
    menu.classList.remove('show');
    toggleMenu.classList.remove('active');
    toast('Browse coming soon!','info',2000);
  };
  document.getElementById('showTutorial').onclick=()=>{
    menu.classList.remove('show');
    toggleMenu.classList.remove('active');
    startTutorial();
  };
};

const sheet=document.getElementById('sheet'),sheetTitle=document.getElementById('sheetTitle'),sheetSubtitle=document.getElementById('sheetSubtitle'),nameEl=document.getElementById('name'),msgEl=document.getElementById('msg'),photoEl=document.getElementById('photo'),previews=document.getElementById('previews'),cancelBtn=document.getElementById('cancelBtn'),saveBtn=document.getElementById('saveBtn'),charCount=document.getElementById('charCount');
let sheetMode='add',sheetTarget={lat:null,lng:null,existingPhotos:[]};

msgEl.addEventListener('input',()=>charCount.textContent=`${msgEl.value.length}/500`);

photoEl.addEventListener('change',async()=>{
  const files=Array.from(photoEl.files).slice(0,5-sheetTarget.existingPhotos.length);
  if(!files.length)return;
  previews.innerHTML='';
  toast('Resizing images...','info',1500);
  for(const f of files){
    try{
      const d=await resizeImage(f);
      const wrap=document.createElement('div');
      wrap.style.cssText='position:relative';
      const img=document.createElement('img');
      img.src=d;
      img.style.cssText='width:100%;height:100px;object-fit:cover;border-radius:10px;box-shadow:var(--shadow-md)';
      const btn=document.createElement('button');
      btn.textContent='‚úï';
      btn.style.cssText='position:absolute;top:4px;right:4px;width:24px;height:24px;border-radius:50%;background:var(--warn);color:#fff;border:none;cursor:pointer;font-size:12px;box-shadow:var(--shadow-md)';
      btn.onclick=()=>{
        wrap.remove();
        const dt=new DataTransfer();
        Array.from(photoEl.files).forEach(file=>{
          if(file!==f)dt.items.add(file)
        });
        photoEl.files=dt.files
      };
      wrap.appendChild(img);
      wrap.appendChild(btn);
      previews.appendChild(wrap)
    }catch(e){
      toast('Photo resize failed','error',2000)
    }
  }
});

const openSheet=(mode,p)=>{
  sheetMode=mode;
  if(mode==='add'){
    sheetTitle.textContent='Drop a Banana';
    sheetSubtitle.textContent='Share your moment with the world';
    nameEl.value='';
    msgEl.value='';
    photoEl.value='';
    previews.innerHTML='';
    charCount.textContent='0/500';
    sheetTarget={lat:p.lat,lng:p.lng,existingPhotos:[]};
    saveBtn.textContent='Save Banana';
    document.getElementById('approxLocation').checked=false
  }else{
    sheetTitle.textContent='Edit Banana';
    sheetSubtitle.textContent='Update your moment';
    nameEl.value=p.name||'';
    msgEl.value=p.msg||'';
    photoEl.value='';
    charCount.textContent=`${(p.msg||'').length}/500`;
    const existingPhotos=p.photos||[p.photo]||[];
    sheetTarget={lat:p.lat,lng:p.lng,existingPhotos:existingPhotos.filter(ph=>ph)};
    previews.innerHTML='';
    sheetTarget.existingPhotos.forEach((ph,idx)=>{
      const wrap=document.createElement('div');
      wrap.style.cssText='position:relative';
      const img=document.createElement('img');
      img.src=ph;
      img.style.cssText='width:100%;height:100px;object-fit:cover;border-radius:10px;box-shadow:var(--shadow-md)';
      const btn=document.createElement('button');
      btn.textContent='‚úï';
      btn.style.cssText='position:absolute;top:4px;right:4px;width:24px;height:24px;border-radius:50%;background:var(--warn);color:#fff;border:none;cursor:pointer;font-size:12px;box-shadow:var(--shadow-md)';
      btn.onclick=()=>{
        wrap.remove();
        sheetTarget.existingPhotos.splice(idx,1)
      };
      wrap.appendChild(img);
      wrap.appendChild(btn);
      previews.appendChild(wrap)
    });
    saveBtn.textContent='Update Banana';
    document.getElementById('approxLocation').parentElement.style.display='none'
  }
  sheet.classList.add('show');
  setTimeout(()=>nameEl.focus(),150)
};

const closeSheet=()=>sheet.classList.remove('show');
cancelBtn.onclick=closeSheet;

saveBtn.onclick=async()=>{
  try{
    const name=nameEl.value.trim(),msg=msgEl.value.trim();
    if(!name){toast('Enter name','error',2000);nameEl.focus();return}
    saveBtn.disabled=true;
    saveBtn.textContent='Saving...';
    const newFiles=Array.from(photoEl.files);
    const photos=[...sheetTarget.existingPhotos];
    for(const f of newFiles){
      if(photos.length>=5)break;
      try{
        photos.push(await resizeImage(f))
      }catch(e){
        console.error('Photo error:',e)
      }
    }
    if(sheetMode==='add'){
      const useApprox=document.getElementById('approxLocation').checked;
      await saveBanana(sheetTarget.lat,sheetTarget.lng,msg,photos,name,useApprox)
    }else await updateBanana(msg,photos,name);
    closeSheet();
    saveBtn.disabled=false;
    saveBtn.textContent=sheetMode==='add'?'Save Banana':'Update Banana'
  }catch(e){
    console.error(e);
    toast(e.message||'Failed','error',3000);
    saveBtn.disabled=false;
    saveBtn.textContent=sheetMode==='add'?'Save Banana':'Update Banana'
  }
};

const getAddress=async(lat,lng)=>{
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const data=await res.json();
    return data.display_name||`${lat.toFixed(4)}, ${lng.toFixed(4)}`
  }catch(e){
    return`${lat.toFixed(4)}, ${lng.toFixed(4)}`
  }
};

const saveBanana=async(lat,lng,msg,photos,name,useApprox)=>{
  const data=await fetchLatest();
  const arr=data.record?.bananas||[];
  if(arr.some(b=>b.deviceId===deviceId))throw new Error('Already dropped');
  let finalLat=lat,finalLng=lng;
  if(useApprox){
    const approx=approximateCoords(lat,lng);
    finalLat=approx.lat;
    finalLng=approx.lng
  }
  const address=await getAddress(lat,lng);
  arr.push({lat:finalLat,lng:finalLng,msg,photos:photos||[],name,ts:Date.now(),deviceId,locationHistory:[{lat:finalLat,lng:finalLng,ts:Date.now(),address}],reactions:[],comments:[],head:'default',accessory:'default',shirt:'default'});
  await putBananas(arr);
  localStorage.setItem(DROPPED_KEY,'true');
  await loadBananas();
  map.easeTo({center:[finalLng,finalLat],zoom:17,duration:800});
  pulseAt(finalLng,finalLat);
  toast('Banana dropped!','success',2500)
};

const updateBanana=async(msg,photos,name)=>{
  const latest=await fetchLatest();
  const arr=latest.record?.bananas||[];
  const idx=arr.findIndex(x=>x.deviceId===deviceId);
  if(idx===-1)throw new Error("Not found");
  arr[idx]={...arr[idx],msg,photos:photos||arr[idx].photos||[],name};
  await putBananas(arr);
  await loadBananas();
  toast('Updated!','success',2000)
};

const deleteMyBanana=async()=>{
  if(!confirm('Delete your banana? This cannot be undone.'))return;
  try{
    const latest=await fetchLatest();
    const arr=latest.record?.bananas||[];
    const idx=arr.findIndex(x=>x.deviceId===deviceId);
    if(idx===-1){toast("No banana",'info',2000);return}
    arr.splice(idx,1);
    await putBananas(arr);
    localStorage.removeItem(DROPPED_KEY);
    await loadBananas();
    toast('Deleted','success',2000)
  }catch(e){
    console.error(e);
    toast('Delete failed','error',2000)
  }
};

const goRandomBanana=()=>{
  const list=bananasCache.filter(b=>typeof b.lat==='number'&&typeof b.lng==='number');
  if(!list.length){toast("No bananas yet",'info',2000);return}
  const pick=list[Math.floor(Math.random()*list.length)];
  map.easeTo({center:[pick.lng,pick.lat],zoom:17,duration:900});
  pulseAt(pick.lng,pick.lat);
  toast('Random!','success',2000);
  setTimeout(()=>showBananaModal(pick),500)
};

const startAuto=()=>{
  if(refreshHandle)clearInterval(refreshHandle);
  refreshHandle=setInterval(async()=>{await loadBananas()},30000)
};

const checkURL=()=>{
  const params=new URLSearchParams(location.search),sharedId=params.get('id');
  if(sharedId){
    setTimeout(async()=>{
      try{
        const data=await fetchLatest();
        const b=(data.record?.bananas||[]).find(x=>x.deviceId===sharedId);
        if(b){
          map.easeTo({center:[b.lng,b.lat],zoom:17,duration:1500});
          pulseAt(b.lng,b.lat);
          toast('Shared banana','success',2000);
          setTimeout(()=>showBananaModal(b),1000)
        }else{
          toast('Not found','error',2000)
        }
      }catch(e){
        console.error(e)
      }
    },1500)
  }
};

// Tutorial System
const TUTORIAL_STEPS=[
  {
    title:'üçå Welcome to banana.place!',
    text:'This is a fun global map where you can drop bananas anywhere in the world and customize them with hats, outfits, and accessories!'
  },
  {
    title:'üìç Drop Your First Banana',
    text:'Click the "Drop Banana" button (bottom right) to place your banana at your current location. You can add a message, photos, and choose privacy options.'
  },
  {
    title:'üé® Customize Your Style',
    text:'After dropping your banana, open the menu (top right) to customize it! Choose from hats, accessories, and outfits to make your banana unique.'
  },
  {
    title:'üîç Explore the World',
    text:'Use the search button (top right) to find any location, or click on bananas to see messages, photos, and reactions from people around the world!'
  },
  {
    title:'üè† Quick Navigation',
    text:'The location button finds your current position, and the home button returns you to the world view at any time.'
  },
  {
    title:"üéâ You're All Set!",
    text:"That's it! Now go ahead and drop your banana somewhere special. Have fun exploring and customizing!"
  }
];

let tutorialStep=0;

const startTutorial=()=>{
  tutorialStep=0;
  document.getElementById('tutorialOverlay').classList.add('show');
  showTutorialStep();
};

const endTutorial=()=>{
  document.getElementById('tutorialOverlay').classList.remove('show');
  localStorage.setItem(TUTORIAL_KEY,'true');
};

const showTutorialStep=()=>{
  const step=TUTORIAL_STEPS[tutorialStep];
  
  document.getElementById('tutorialTitle').textContent=step.title;
  document.getElementById('tutorialText').textContent=step.text;
  
  const progress=document.getElementById('tutorialProgress');
  progress.innerHTML=TUTORIAL_STEPS.map((_,i)=>`<div class="tutorial-dot ${i===tutorialStep?'active':''}"></div>`).join('');
  
  document.getElementById('tutorialNext').textContent=tutorialStep===TUTORIAL_STEPS.length-1?'Finish':'Next';
  
  // Hide spotlight for simpler centered tutorial
  document.getElementById('tutorialSpotlight').style.display='none';
};

document.getElementById('tutorialSkip').onclick=endTutorial;
document.getElementById('tutorialNext').onclick=()=>{
  if(tutorialStep===TUTORIAL_STEPS.length-1){
    endTutorial();
  }else{
    tutorialStep++;
    showTutorialStep();
  }
};


(async()=>{
  try{
    map=new maplibregl.Map({container:'map',style:makeStyle(),center:[0,20],zoom:2});
    map.addControl(new maplibregl.NavigationControl({showCompass:false}),'bottom-right');
    map.on('load',async()=>{
      await loadBananas();
      startAuto();
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(({coords:{latitude,longitude}})=>{
          map.easeTo({center:[longitude,latitude],zoom:11,duration:1200})
        },()=>{},{enableHighAccuracy:true,timeout:8000})
      }
      checkURL();
      
      // Show tutorial on first visit
      if(!localStorage.getItem(TUTORIAL_KEY)){
        setTimeout(startTutorial,2000);
      }
    });
    wireUI()
  }catch(e){
    console.error(e);
    toast('Map failed','error',0)
  }
})();
</script>
</body>
</html>
