<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>banana.place - Share Your Moment</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='0.9em' font-size='90'>üçå</text></svg>'"/>
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
:root{
  --bg:#FFF9E5;
  --surface:rgba(255,255,255,0.96);
  --ink:#0A0A0A;
  --muted:#737373;
  --accent:#FFD93D;
  --accent-dark:#E0C24B;
  --success:#10b981;
  --warn:#ef4444;
  --info:#3b82f6;
  --shadow:0 2px 8px rgba(0,0,0,.04);
  --shadow-md:0 4px 16px rgba(0,0,0,.06);
  --shadow-lg:0 8px 24px rgba(0,0,0,.08);
  --shadow-xl:0 12px 32px rgba(0,0,0,.12);
  --radius:12px;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;-webkit-font-smoothing:antialiased;overflow:hidden}
#map{position:relative;height:100vh;width:100%}

@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}

.header{position:fixed;top:16px;left:16px;right:16px;z-index:1000;display:flex;justify-content:space-between;gap:12px;pointer-events:none}
.header>*{pointer-events:auto}
.brand{display:flex;align-items:center;gap:10px;background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:999px;padding:10px 18px;box-shadow:var(--shadow-md);font-weight:600;font-size:15px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.brand:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.brand-icon{width:26px;height:26px;flex-shrink:0}
.hgroup{display:flex;gap:8px}
.iconbtn{width:44px;height:44px;border:none;border-radius:var(--radius);background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);display:grid;place-items:center;box-shadow:var(--shadow-md);cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.iconbtn:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.iconbtn.active{background:var(--accent);border-color:var(--accent-dark)}
.icon{width:18px;height:18px}
.icon-lg{width:22px;height:22px}

.search-panel{position:fixed;top:76px;left:16px;right:16px;z-index:999;display:none;animation:slideDown 0.2s cubic-bezier(0.4,0,0.2,1)}
.search-panel.show{display:block}
.search-input-wrapper{position:relative}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}
.search-panel input{width:100%;padding:14px 14px 14px 44px;border:1px solid rgba(0,0,0,0.08);border-radius:var(--radius);background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:var(--shadow-lg);font:inherit;font-size:14px;transition:all 0.2s ease}
.search-panel input:focus{outline:none;border-color:var(--accent);box-shadow:var(--shadow-xl),0 0 0 3px rgba(255,217,61,0.08)}
.search-panel input::placeholder{color:var(--muted)}
.search-results{margin-top:8px;background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:var(--radius);box-shadow:var(--shadow-lg);max-height:60vh;overflow-y:auto;display:none;border:1px solid rgba(0,0,0,0.06)}
.search-results.show{display:block;animation:slideDown 0.2s ease}
.search-result-item{padding:12px 14px;cursor:pointer;transition:all 0.15s ease;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;gap:10px}
.search-result-item:last-child{border-bottom:none}
.search-result-item:hover{background:rgba(255,217,61,0.08);padding-left:18px}
.search-result-item .icon-wrapper{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));border-radius:10px;display:grid;place-items:center;flex-shrink:0}
.search-result-item .text{flex:1;min-width:0}
.search-result-item strong{display:block;font-size:14px;font-weight:600;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.search-result-item small{display:block;font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.menu{position:fixed;right:16px;top:76px;z-index:999;background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:6px;min-width:220px;display:none;animation:slideDown 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.menu.show{display:block}
.menu .row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.15s ease;font-size:13px;font-weight:500}
.menu .row:hover{background:rgba(255,217,61,0.08);padding-left:16px}
.menu .row.disabled{opacity:0.35;cursor:not-allowed}
.menu .row.disabled:hover{background:transparent;padding-left:12px}
.menu .split{height:1px;background:rgba(0,0,0,0.06);margin:6px 8px}

.controls{position:fixed;right:16px;bottom:16px;z-index:998;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.controls>*{pointer-events:auto}
.fab{border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink);font-weight:600;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 20px;box-shadow:var(--shadow-lg);cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);white-space:nowrap;border:1px solid var(--accent-dark)}
.fab:hover:not(:disabled){box-shadow:var(--shadow-xl),0 8px 20px rgba(255,217,61,0.3);transform:translateY(-2px)}
.fab:active:not(:disabled){transform:translateY(0)}
.fab:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
.quick-btn{width:44px;height:44px;border:none;border-radius:var(--radius);background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);display:grid;place-items:center;box-shadow:var(--shadow-md);cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.quick-btn:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.quick-btn.active{background:var(--accent);border-color:var(--accent-dark)}

.stats{position:fixed;left:16px;bottom:16px;z-index:998;background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:var(--radius);padding:10px 14px;box-shadow:var(--shadow-md);display:flex;align-items:center;gap:12px;font-size:12px;font-weight:600;border:1px solid rgba(0,0,0,0.06);animation:slideUp 0.3s ease}
.stats-item{display:flex;align-items:center;gap:6px;color:var(--muted)}
.stats-item .banana-mini{width:16px;height:16px}
.stats-item .count{color:var(--ink);font-size:14px}
.stats-divider{width:1px;height:16px;background:rgba(0,0,0,0.1)}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;z-index:10000;background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);padding:10px 16px;border-radius:var(--radius);box-shadow:var(--shadow-xl);font-size:13px;font-weight:600;max-width:90vw;animation:slideUp 0.25s cubic-bezier(0.4,0,0.2,1);display:flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,0.06)}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--warn)}
.toast.info{border-left:3px solid var(--info)}
.toast .icon{flex-shrink:0;width:16px;height:16px}

.sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:1001;background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -8px 40px rgba(0,0,0,.1);padding:18px 18px 28px;transition:bottom 0.3s cubic-bezier(0.4,0,0.2,1);max-height:82vh;overflow-y:auto;border-top:1px solid rgba(0,0,0,0.06)}
.sheet.show{bottom:0}
.sheet .grab{width:36px;height:4px;background:rgba(0,0,0,0.15);border-radius:4px;margin:0 auto 14px}
.sheet h3{margin:0 0 6px 0;font-size:20px;font-weight:700;letter-spacing:-0.01em}
.sheet .subtitle{color:var(--muted);font-size:13px;margin-bottom:18px;font-weight:500}
.sheet label{font-size:11px;font-weight:700;color:var(--ink);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em}
.sheet input[type="text"],.sheet textarea{width:100%;padding:12px;border:1px solid rgba(0,0,0,0.1);border-radius:10px;font:inherit;font-size:14px;transition:all 0.2s ease;background:#fff;margin-bottom:14px}
.sheet input[type="text"]:focus,.sheet textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,217,61,0.08)}
.sheet textarea{resize:vertical;min-height:80px;line-height:1.5}
.char-count{font-size:11px;color:var(--muted);text-align:right;margin-top:-10px;margin-bottom:14px}
.file-upload{position:relative;margin-bottom:14px}
.file-upload-label{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;padding:18px;border:2px dashed rgba(0,0,0,0.12);border-radius:10px;cursor:pointer;transition:all 0.2s ease;background:rgba(255,217,61,0.03)}
.file-upload-label:hover{border-color:var(--accent-dark);background:rgba(255,217,61,0.08)}
.file-upload input[type="file"]{position:absolute;opacity:0;width:0;height:0}
.file-upload-text{font-size:13px;font-weight:600;color:var(--ink)}
.file-upload-hint{font-size:11px;color:var(--muted)}
.preview{display:none;margin-bottom:14px;position:relative}
.preview.show{display:block}
.preview img{max-width:100%;max-height:180px;border-radius:10px;box-shadow:var(--shadow-md)}
.preview-remove{position:absolute;top:6px;right:6px;width:28px;height:28px;border-radius:50%;background:var(--warn);color:#fff;border:none;cursor:pointer;display:grid;place-items:center;box-shadow:var(--shadow-md);transition:all 0.2s ease;font-size:14px}
.preview-remove:hover{transform:scale(1.1)}
.sheet-actions{display:flex;gap:10px;margin-top:18px}
.sheet-actions button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink);border:1px solid var(--accent-dark)}
.btn-primary:hover:not(:disabled){box-shadow:0 4px 16px rgba(255,217,61,0.25);transform:translateY(-1px)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed}
.btn-secondary{background:rgba(0,0,0,0.04);color:var(--ink);border:1px solid rgba(0,0,0,0.08)}
.btn-secondary:hover{background:rgba(0,0,0,0.08)}
.sheet .footer{margin-top:16px;color:var(--muted);font-size:10px;text-align:center}

.maplibregl-popup-content{border-radius:var(--radius);padding:16px;box-shadow:var(--shadow-xl);max-width:280px;border:1px solid rgba(0,0,0,0.06)}
.popup-header{display:flex;align-items:start;justify-content:space-between;margin-bottom:8px}
.maplibregl-popup-content strong{font-size:16px;font-weight:700;letter-spacing:-0.01em}
.popup-meta{font-size:11px;color:var(--muted);margin-top:4px;font-weight:500}
.maplibregl-popup-content p{margin:0 0 10px;color:#4b5563;line-height:1.5;font-size:13px}
.maplibregl-popup-content img{max-width:100%;border-radius:8px;margin:10px 0;box-shadow:var(--shadow-md)}
.popup-actions{display:flex;gap:8px;margin-top:10px}
.popbtn{border:none;padding:8px 14px;border-radius:8px;background:var(--ink);color:#fff;font-weight:600;font-size:12px;cursor:pointer;transition:all 0.2s ease;flex:1}
.popbtn:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
.popbtn.danger{background:var(--warn)}

.banana-marker{width:36px;height:36px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);filter:drop-shadow(0 3px 8px rgba(0,0,0,.12))}
.banana-marker:hover{transform:translateY(-5px) scale(1.12);filter:drop-shadow(0 6px 16px rgba(0,0,0,.2))}
.banana-marker.mine{filter:drop-shadow(0 3px 12px rgba(255,217,61,.5))}
.banana-marker.mine:hover{filter:drop-shadow(0 6px 20px rgba(255,217,61,.7))}

.deck{position:fixed;left:0;right:0;bottom:16px;z-index:997;display:none;justify-content:center;pointer-events:none;animation:slideUp 0.3s cubic-bezier(0.4,0,0.2,1)}
.deck.show{display:flex}
.deck>*{pointer-events:auto}
.card{width:min(500px,calc(100vw - 32px));background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:18px;box-shadow:var(--shadow-xl);padding:20px;border:1px solid rgba(0,0,0,0.06)}
.card-header{display:flex;align-items:start;justify-content:space-between;margin-bottom:10px}
.card h4{margin:0;font-size:18px;font-weight:700;letter-spacing:-0.01em}
.card-meta{font-size:11px;color:var(--muted);margin-top:4px;font-weight:500}
.card p{margin:0 0 10px 0;color:#4b5563;line-height:1.6;font-size:14px}
.card img{max-width:100%;border-radius:12px;margin:10px 0;box-shadow:var(--shadow-md)}
.card .actions{display:flex;gap:8px;margin-top:14px}
.card .actions button{flex:1;padding:11px;border:none;border-radius:10px;font-weight:600;background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--ink);cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px;border:1px solid var(--accent-dark)}
.card .actions button:hover{box-shadow:0 4px 16px rgba(255,217,61,0.25);transform:translateY(-1px)}
.deck-nav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;padding:0 10px;pointer-events:none}
.deck-nav button{pointer-events:auto;border:none;background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:var(--shadow-lg);width:42px;height:42px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.deck-nav button:hover:not(:disabled){box-shadow:var(--shadow-xl);transform:scale(1.08)}
.deck-nav button:disabled{opacity:0.25;cursor:not-allowed}
.deckbar{position:absolute;top:-46px;left:0;right:0;height:38px;display:flex;align-items:center;justify-content:center;gap:8px}
.deckbar strong{font-size:13px;font-weight:700}
.deck-counter{font-size:12px;color:var(--muted);font-weight:600}
.deckbar .close{position:absolute;right:10px;border:none;background:var(--surface);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:var(--shadow-md);width:34px;height:34px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(0,0,0,0.06)}
.deckbar .close:hover{transform:scale(1.05) rotate(90deg);box-shadow:var(--shadow-lg)}

.empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-state .icon{width:48px;height:48px;margin:0 auto 12px;opacity:0.3}
.empty-state h4{font-size:16px;font-weight:600;margin-bottom:6px;color:var(--ink)}
.empty-state p{font-size:13px;line-height:1.5}

@media (max-width:640px){
  .header{top:12px;left:12px;right:12px}
  .search-panel{top:68px;left:12px;right:12px}
  .menu{right:12px;top:68px}
  .stats{left:12px;bottom:12px;font-size:11px;padding:8px 12px}
  .controls{right:12px;bottom:12px}
  .brand{padding:8px 14px;font-size:14px}
  .brand-icon{width:22px;height:22px}
  .iconbtn{width:40px;height:40px}
  .quick-btn{width:40px;height:40px}
  .fab{padding:12px 16px;font-size:13px}
  .stats-item .count{font-size:13px}
}

@media (max-width:480px){
  .brand span:not(.brand-icon){display:none}
  .fab span{display:none}
  .fab{width:44px;padding:12px}
  .stats{gap:8px}
  .stats-item span:not(.count){display:none}
}
</style>
</head>
<body>

<svg style="position:absolute;width:0;height:0" aria-hidden="true">
  <symbol id="i-menu" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
  <symbol id="i-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
  <symbol id="i-eye" viewBox="0 0 24 24"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></symbol>
  <symbol id="i-share" viewBox="0 0 24 24"><path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M12 3v14M7 8l5-5 5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-trash" viewBox="0 0 24 24"><path d="M4 7h16M10 11v6M14 11v6M6 7l1 12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-12M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-left" viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-right" viewBox="0 0 24 24"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-close" viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
  <symbol id="i-location" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="10" r="3" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-dice" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="8.5" cy="8.5" r="1" fill="currentColor"/><circle cx="15.5" cy="8.5" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/><circle cx="8.5" cy="15.5" r="1" fill="currentColor"/><circle cx="15.5" cy="15.5" r="1" fill="currentColor"/></symbol>
  <symbol id="i-globe" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-camera" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="13" r="4" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  <symbol id="i-alert" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="16" r="1" fill="currentColor"/></symbol>
  <symbol id="i-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><line x1="12" y1="16" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="8" r="1" fill="currentColor"/></symbol>
  <symbol id="i-home" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" fill="none" stroke="currentColor" stroke-width="2"/><polyline points="9 22 9 12 15 12 15 22" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
</svg>

<div class="header">
  <div class="brand" id="brandBtn" title="Return to world view">
    <svg class="brand-icon" viewBox="0 0 256.85 291.32" xmlns="http://www.w3.org/2000/svg">
      <defs><style>.cls-2{fill:#ffc910;}.cls-5{fill:#ffdb27;}</style></defs>
      <g><path class="cls-5" d="M226.68,282.86c-29.25,13.86-88.77-31.06-120.23-78.8-3.94-5.99-13.84-37.32,9.8-43.5,1.53-.4,2.62-.5,3.61-.38,1.8.23,2.92.93,4.51,1.76,1.39.73,3.46,1.7,6.18,2.59.19-1.78.84-4.19,1.8-7.01.74-2.17,1.79-4.21,3.72-6.24,50.98-39.77,88.26,30.02,110.95,64.13,2.34,3,5.81,7.55,9.54,8.76.38,4.53-3.49,5.6-7.78,4.73-5.68-1.15-15.85-23.65-19.33-29.11-11.19-17.56-35.92-53.71-59.49-55.14-8.08-.49-13.28,2.2-14.31,10.18-1.71,13.24,30.61,61.14,74.3,98.45,3.01,2.57,10.69,9.03,9.79,16.33-.93,7.5-10.45,12.02-13.05,13.25Z"/><path class="cls-2" d="M227.35,283c-8.08-.83-17.63-2.33-25.6-3.61-28.79-4.62-83.79-52-94.63-77.38-2.57-6.02-9.42-29.07.79-37.25,6.96-5.58,18.77-1.65,22.94-.07-2.37-1.63-6.59-4.07-12.37-5.03-3.5-.58-6.53-.45-8.78-.16,0,0,0,0,0,0,0,0-2.19.37-4.33,1.57-6.53,3.68-11.3,12.65-11.3,12.65-4.63,8.69-6.9,17.53-8.02,24.75,6.18,10.25,15.37,24.34,28.93,39.03,11.07,12,23.42,22.98,36.59,32.91,15.18,11.45,37.24,23.97,61.16,18.46,6.38-1.47,11.36-3.93,14.65-5.85Z"/></g>
    </svg>
    <span>banana.place</span>
  </div>
  <div class="hgroup">
    <button class="iconbtn" id="toggleSearch" title="Search locations"><svg class="icon"><use href="#i-search"/></svg></button>
    <button class="iconbtn" id="toggleMenu" title="Menu"><svg class="icon"><use href="#i-menu"/></svg></button>
  </div>
</div>

<div class="search-panel" id="searchPanel">
  <div class="search-input-wrapper">
    <svg class="icon search-icon"><use href="#i-search"/></svg>
    <input type="text" id="searchInput" placeholder="Search any location..." autocomplete="off">
  </div>
  <div class="search-results" id="searchResults"></div>
</div>

<div class="menu" id="menu">
  <div class="row" id="seeMine"><svg class="icon"><use href="#i-eye"/></svg><span>View My Banana</span></div>
  <div class="row" id="shareMine"><svg class="icon"><use href="#i-share"/></svg><span>Share My Banana</span></div>
  <div class="row" id="deleteMine"><svg class="icon"><use href="#i-trash"/></svg><span style="color:var(--warn)">Delete My Banana</span></div>
  <div class="split"></div>
  <div class="row" id="randomBanana"><svg class="icon"><use href="#i-dice"/></svg><span>Random Banana</span></div>
  <div class="row" id="browseBananas"><svg class="icon"><use href="#i-globe"/></svg><span>Browse All</span></div>
</div>

<div class="stats">
  <div class="stats-item">
    <svg class="banana-mini" viewBox="0 0 256.85 291.32"><path d="M227.35,283c-8.08-.83-17.63-2.33-25.6-3.61-28.79-4.62-83.79-52-94.63-77.38-2.57-6.02-9.42-29.07.79-37.25,6.96-5.58,18.77-1.65,22.94-.07-2.37-1.63-6.59-4.07-12.37-5.03-3.5-.58-6.53-.45-8.78-.16,0,0,0,0,0,0,0,0-2.19.37-4.33,1.57-6.53,3.68-11.3,12.65-11.3,12.65-4.63,8.69-6.9,17.53-8.02,24.75,6.18,10.25,15.37,24.34,28.93,39.03,11.07,12,23.42,22.98,36.59,32.91,15.18,11.45,37.24,23.97,61.16,18.46,6.38-1.47,11.36-3.93,14.65-5.85Z" fill="#ffc910"/></svg>
    <span>Total</span>
    <span class="count" id="totalCount">0</span>
  </div>
</div>

<div class="controls">
  <button class="quick-btn" id="locateBtn" title="My location"><svg class="icon"><use href="#i-location"/></svg></button>
  <button class="quick-btn" id="homeBtn" title="World view"><svg class="icon"><use href="#i-home"/></svg></button>
  <button id="dropBtn" class="fab"><svg class="icon-lg"><use href="#i-plus"/></svg><span>Drop Banana</span></button>
</div>

<div id="map"></div>
<div id="toastContainer"></div>

<div class="sheet" id="sheet">
  <div class="grab"></div>
  <h3 id="sheetTitle">Drop a Banana</h3>
  <p class="subtitle" id="sheetSubtitle">Share your moment with the world</p>
  <label for="name">Your Name</label>
  <input id="name" type="text" placeholder="What should we call you?" maxlength="50">
  <label for="msg">Message</label>
  <textarea id="msg" rows="4" placeholder="Share something fun, inspiring, or interesting..." maxlength="500"></textarea>
  <div class="char-count" id="charCount">0 / 500</div>
  <label>Photo (Optional)</label>
  <div class="file-upload">
    <label for="photo" class="file-upload-label">
      <svg class="icon-lg"><use href="#i-camera"/></svg>
      <span class="file-upload-text">Add Photo</span>
      <span class="file-upload-hint">JPG or PNG, up to 5MB</span>
    </label>
    <input id="photo" type="file" accept="image/*">
  </div>
  <div class="preview" id="preview">
    <img alt="preview">
    <button class="preview-remove" id="removePhoto">‚úï</button>
  </div>
  <div class="sheet-actions">
    <button class="btn-secondary" id="cancelBtn">Cancel</button>
    <button class="btn-primary" id="saveBtn">Save Banana</button>
  </div>
  <div class="footer">Powered by Nominatim ‚Ä¢ Map ¬© OpenStreetMap & CARTO</div>
</div>

<div class="deck" id="deck">
  <div class="deckbar">
    <strong>Browse Bananas</strong>
    <span class="deck-counter" id="deckCounter">1/1</span>
    <button class="close" id="deckClose"><svg class="icon"><use href="#i-close"/></svg></button>
  </div>
  <div class="card" id="cardContainer">
    <div id="cardContent">
      <div class="card-header">
        <div>
          <h4 id="cardTitle">Banana</h4>
          <div class="card-meta" id="cardMeta"></div>
        </div>
      </div>
      <p id="cardMsg" style="display:none"></p>
      <img id="cardImg" alt="" style="display:none">
      <div class="actions">
        <button id="focusBtn"><svg class="icon"><use href="#i-location"/></svg> Show on Map</button>
      </div>
    </div>
    <div class="empty-state" id="emptyState" style="display:none">
      <svg class="icon"><use href="#i-globe"/></svg>
      <h4>No Bananas Yet</h4>
      <p>Be the first to drop a banana!</p>
    </div>
  </div>
  <div class="deck-nav">
    <button id="prevBtn" aria-label="Previous"><svg class="icon"><use href="#i-left"/></svg></button>
    <button id="nextBtn" aria-label="Next"><svg class="icon"><use href="#i-right"/></svg></button>
  </div>
</div>

<script>
const BIN_ID="68f0265443b1c97be96a4ad5",API_KEY="$2a$10$RCnUKDWytC/ysiMgbX6/q.QRSKrLrAOPSOsZVPFYaaW06lur2V5X6",BIN_URL=`https://api.jsonbin.io/v3/b/${BIN_ID}`,DEVICE_KEY='banana_device_id',DROPPED_KEY='banana_already_dropped';
let deviceId=localStorage.getItem(DEVICE_KEY);if(!deviceId){deviceId=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));localStorage.setItem(DEVICE_KEY,deviceId)}

const esc=s=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const fileToDataURL=f=>new Promise((r,e)=>{const reader=new FileReader();reader.onload=ev=>r(ev.target.result);reader.onerror=e;reader.readAsDataURL(f)});
const timeAgo=t=>{const s=Math.floor((Date.now()-t)/1000);if(s<60)return'just now';const m=Math.floor(s/60);if(m<60)return`${m}m ago`;const h=Math.floor(m/60);if(h<24)return`${h}h ago`;const d=Math.floor(h/24);if(d<30)return`${d}d ago`;const mo=Math.floor(d/30);if(mo<12)return`${mo}mo ago`;return`${Math.floor(mo/12)}y ago`};
const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

let map,bananasCache=[],domMarkers=[],refreshHandle;
const toast=(msg,type='info',dur=2500)=>{const c=document.getElementById('toastContainer'),iconMap={success:'i-check',error:'i-alert',info:'i-info'};c.innerHTML=`<div class="toast ${type}"><svg class="icon"><use href="#${iconMap[type]}"/></svg><span>${msg}</span></div>`;if(dur>0)setTimeout(()=>c.innerHTML='',dur)};

const makeStyle=()=>{const sub=['a','b','c','d'],base='https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',labels='https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png';return{version:8,glyphs:'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',sources:{base:{type:'raster',tiles:sub.map(s=>base.replace('{s}',s)),tileSize:256},labels:{type:'raster',tiles:sub.map(s=>labels.replace('{s}',s)),tileSize:256},bananas:{type:'geojson',data:{type:'FeatureCollection',features:[]},cluster:true,clusterRadius:50}},layers:[{id:'base',type:'raster',source:'base'},{id:'labels',type:'raster',source:'labels',paint:{'raster-opacity':.65}},{id:'clusters',type:'circle',source:'bananas',filter:['has','point_count'],paint:{'circle-color':'#FFE066','circle-stroke-width':2,'circle-stroke-color':'#E0C24B','circle-radius':['step',['get','point_count'],15,10,19,25,24]}},{id:'cluster-count',type:'symbol',source:'bananas',filter:['has','point_count'],layout:{'text-field':['get','point_count_abbreviated'],'text-size':12,'text-font':['Open Sans Bold','Arial Unicode MS Bold']},paint:{'text-color':'#222'}}]}};

const asFeat=b=>({type:'Feature',properties:{deviceId:b.deviceId||'',name:b.name||'',msg:b.msg||'',photo:b.photo||'',ts:b.ts||0},geometry:{type:'Point',coordinates:[b.lng,b.lat]}});
const clearMarkers=()=>{domMarkers.forEach(m=>m.remove());domMarkers=[]};

const popupHTML=p=>{const title=p.name?esc(p.name):'Anonymous',mine=p.deviceId===deviceId;let h=`<div class="popup-header"><div><strong>${title}</strong>`;if(p.ts)h+=`<div class="popup-meta">${timeAgo(p.ts)}</div>`;h+=`</div></div>`;if(p.msg)h+=`<p>${esc(p.msg)}</p>`;if(p.photo)h+=`<img src="${p.photo}">`;if(mine)h+=`<div class="popup-actions"><button class="popbtn" data-action="edit">Edit</button><button class="popbtn danger" data-action="delete">Delete</button></div>`;return h};

const bananaSVG=`<svg viewBox="0 0 256.85 291.32" xmlns="http://www.w3.org/2000/svg"><defs><style>.cls-1{fill:#34af0e;}.cls-2{fill:#ffc910;}.cls-3{fill:#f8db8f;}.cls-4{fill:#ffeda3;}.cls-5{fill:#ffdb27;}</style></defs><g><path class="cls-3" d="M71.1,141.02c.28,1.47.88,7.33,1.51,8.76,1.93,4.39,14.28,1.42,18.58.95-11.67-38.63-11.64-82.48,8.03-118.8,6.14-11.33,14.88-23.92,27.11-29.82l.25-1.18-4.27-.47c-25.63,3.82-45.46,48.7-50.2,69.81-4.86,21.62-5.22,49.03-1,70.76Z"/><path class="cls-4" d="M122.3.45l4.27.47-.25,1.18c-12.23,5.9-20.97,18.49-27.11,29.82-19.67,36.32-19.7,80.17-8.03,118.8-4.3.48-16.64,3.45-18.58-.95-.63-1.42-1.22-7.29-1.51-8.76l-25.6,2.37c11.12-2.18,20.14.12,27.11,8.76-3.44,1.89-7.15,2.97-10.54,4.97-23.54,13.89-24.41,35.07-30.12,57.27-1.14,17.15,3.46,36,12.55,50.88,6.03,9.87,22.72,28.5,36.15,25.79,1.76-21.88-7.48-39.71-6.02-62.24.91-14.08,10.81-51.24,20.08-62,8.51-9.89,29.8-18.03,36.15-2.13,1.3-5.09,1.66-9.2,5.52-13.25-1.02-2.13,6.58-7.74,6.02-9.23-.07-.19-1.78-.28-2.51-2.84-8.39-29.54-10.59-63.06-5.02-93.24,2.16-11.71,10.88-29.39,3.51-40.23-1.89-2.78-5.1-3.54-7.53-5.44-3.52-.67-5.06-.52-8.53,0Z"/><path class="cls-5" d="M80.64,291.05c15.58-3.14,4.71-25.51,3.01-35.26-3.34-19.23-3.22-36.25,2.01-55.14,2.36-8.51,11.33-33.16,19.33-37.39,5.51-2.92,10.89-2.02,16.82-.95,3.42.62,5.45,2.59,9.04,2.37-6.35-15.9-27.63-7.76-36.15,2.13-9.27,10.76-19.17,47.93-20.08,62-1.45,22.52,7.78,40.35,6.02,62.24Z"/><path class="cls-2" d="M18.89,251.3c6.47-3.93,7.28-19.33,9.04-26.27.88-3.45,3.38-8.16,4.02-10.65,5.71-22.2,6.59-43.38,30.12-57.27.11-2.35,4.35-1.54,3.01-3.55-21.74-19.04-42.85,15.37-49.2,30.29-6.43,15.12-13.02,38.46-11.04,56.32.93,8.39,3.7,17.42,14.06,11.12Z"/><path class="cls-5" d="M45.49,143.38C12.83,149.77-5.18,217.75,1.31,243.96c2.27,9.18,8.63,14.45,17.57,7.34-10.36,6.29-13.13-2.73-14.06-11.12-1.97-17.86,4.62-41.2,11.04-56.32,6.34-14.93,27.46-49.33,49.2-30.29,1.33,2.01-2.91,1.2-3.01,3.55,3.39-2,7.1-3.08,10.54-4.97-6.97-8.64-15.99-10.93-27.11-8.76Z"/><path class="cls-5" d="M226.68,282.86c-29.25,13.86-88.77-31.06-120.23-78.8-3.94-5.99-13.84-37.32,9.8-43.5,1.53-.4,2.62-.5,3.61-.38,1.8.23,2.92.93,4.51,1.76,1.39.73,3.46,1.7,6.18,2.59.19-1.78.84-4.19,1.8-7.01.74-2.17,1.79-4.21,3.72-6.24,50.98-39.77,88.26,30.02,110.95,64.13,2.34,3,5.81,7.55,9.54,8.76.38,4.53-3.49,5.6-7.78,4.73-5.68-1.15-15.85-23.65-19.33-29.11-11.19-17.56-35.92-53.71-59.49-55.14-8.08-.49-13.28,2.2-14.31,10.18-1.71,13.24,30.61,61.14,74.3,98.45,3.01,2.57,10.69,9.03,9.79,16.33-.93,7.5-10.45,12.02-13.05,13.25Z"/><path class="cls-2" d="M227.35,283c-8.08-.83-17.63-2.33-25.6-3.61-28.79-4.62-83.79-52-94.63-77.38-2.57-6.02-9.42-29.07.79-37.25,6.96-5.58,18.77-1.65,22.94-.07-2.37-1.63-6.59-4.07-12.37-5.03-3.5-.58-6.53-.45-8.78-.16,0,0,0,0,0,0,0,0-2.19.37-4.33,1.57-6.53,3.68-11.3,12.65-11.3,12.65-4.63,8.69-6.9,17.53-8.02,24.75,6.18,10.25,15.37,24.34,28.93,39.03,11.07,12,23.42,22.98,36.59,32.91,15.18,11.45,37.24,23.97,61.16,18.46,6.38-1.47,11.36-3.93,14.65-5.85Z"/><path class="cls-4" d="M130.84.45c2.43,1.9,5.64,2.66,7.53,5.44,7.37,10.84-1.35,28.52-3.51,40.23-5.57,30.18-3.37,63.7,5.02,93.24.73,2.56,2.44,2.65,2.51,2.84.55,1.49-7.05,7.1-6.02,9.23,4.75-4.99,17.38-10.2,24.35-10.89,44.57-4.37,65.17,49.12,86.6,75.02,2.42,2.93,5.81,7.55,9.54,8.76-.98-11.53-11.28-36.78-17.57-47.09-18.14-29.76-61.94-63.82-97.9-38.34-7.85-27.87-10.78-56.96-6.53-85.67,1.96-13.26,17.27-48.73-4.02-52.77Z"/><path class="cls-1" d="M232.29,255.34c.65,2.52,2.01,9.24-.91,16.82-4.04,10.51-16.83,15.88-18.68,16.69,2.72.6,12.47.42,19.22-2.27,2.52-1,12.08-4.84,13.35-13.11,1.15-7.51-4.18-15.66-12.98-18.14Z"/></g></svg>`;

const createMarker=feat=>{const el=document.createElement('div');el.className='banana-marker';if(feat.properties.deviceId===deviceId)el.className+=' mine';el.innerHTML=bananaSVG;const openPopup=ev=>{ev.preventDefault();ev.stopPropagation();const p=feat.properties,coords=feat.geometry.coordinates,popup=new maplibregl.Popup({offset:12}).setLngLat(coords).setHTML(popupHTML(p)).addTo(map);const content=popup.getElement().querySelector('.maplibregl-popup-content');if(content)content.addEventListener('click',e=>{const btn=e.target.closest('.popbtn');if(!btn)return;e.preventDefault();const action=btn.dataset.action;if(action==='edit'){popup.remove();openSheet('edit',{lat:coords[1],lng:coords[0],...p})}else if(action==='delete'){popup.remove();deleteMyBanana()}})};['pointerdown','touchstart','mousedown'].forEach(type=>el.addEventListener(type,e=>e.stopPropagation(),{passive:true}));el.addEventListener('pointerup',openPopup);el.addEventListener('touchend',openPopup);el.addEventListener('click',openPopup);return new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(feat.geometry.coordinates)};

const renderMarkers=geojson=>{clearMarkers();geojson.features.forEach(f=>{if(f.properties.point_count)return;const m=createMarker(f).addTo(map);domMarkers.push(m)})};

const updateStats=count=>{document.getElementById('totalCount').textContent=count};

const fetchLatest=async()=>{const res=await fetch(`${BIN_URL}/latest`,{headers:{"X-Master-Key":API_KEY}});if(!res.ok)throw new Error('Load failed');return res.json()};
const putBananas=async arr=>{const res=await fetch(BIN_URL,{method:'PUT',headers:{"X-Master-Key":API_KEY,"Content-Type":"application/json"},body:JSON.stringify({bananas:arr})});if(!res.ok)throw new Error('Save failed')};

const loadBananas=async()=>{try{const data=await fetchLatest();bananasCache=data.record?.bananas||[];const feats=bananasCache.filter(b=>typeof b.lat==='number'&&typeof b.lng==='number').map(asFeat);const src=map.getSource('bananas');if(src)src.setData({type:'FeatureCollection',features:feats});renderMarkers({type:'FeatureCollection',features:feats});updateStats(feats.length);const already=bananasCache.some(b=>b.deviceId===deviceId)||localStorage.getItem(DROPPED_KEY)==='true';document.getElementById('dropBtn').disabled=already;document.getElementById('dropBtn').querySelector('span').textContent=already?"Banana Dropped":"Drop Banana";['seeMine','shareMine','deleteMine'].forEach(id=>document.getElementById(id).classList.toggle('disabled',!already))}catch(e){console.error(e);toast('Load failed','error',3000)}};

const wireSearch=()=>{const panel=document.getElementById('searchPanel'),input=document.getElementById('searchInput'),results=document.getElementById('searchResults'),toggle=document.getElementById('toggleSearch');toggle.onclick=()=>{const open=panel.classList.toggle('show');toggle.classList.toggle('active',open);if(open)input.focus();else{input.value='';results.classList.remove('show')}};document.addEventListener('click',e=>{if(!panel.contains(e.target)&&e.target!==toggle){panel.classList.remove('show');toggle.classList.remove('active');input.value='';results.classList.remove('show')}});const searchLoc=async q=>{if(!q.trim()){results.classList.remove('show');return}try{const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=8`);const data=await res.json();results.innerHTML='';if(!data||!data.length){results.innerHTML='<div class="search-result-item"><small>No results</small></div>'}else{data.forEach(r=>{const item=document.createElement('div');item.className='search-result-item';const name=r.display_name.split(',')[0];item.innerHTML=`<div class="icon-wrapper"><svg class="icon"><use href="#i-location"/></svg></div><div class="text"><strong>${esc(name)}</strong><small>${esc(r.display_name)}</small></div>`;item.onclick=()=>{map.easeTo({center:[+r.lon,+r.lat],zoom:14,duration:800});panel.classList.remove('show');toggle.classList.remove('active');input.value='';results.classList.remove('show');toast(name,'info',2000)};results.appendChild(item)})}results.classList.add('show')}catch(e){console.error(e)}};input.addEventListener('input',debounce(()=>searchLoc(input.value),400));input.addEventListener('keydown',e=>{if(e.key==='Enter')searchLoc(input.value)})};

const wireUI=()=>{wireSearch();const menu=document.getElementById('menu'),toggleMenu=document.getElementById('toggleMenu');toggleMenu.onclick=()=>{const open=menu.classList.toggle('show');toggleMenu.classList.toggle('active',open)};document.addEventListener('click',e=>{if(!menu.contains(e.target)&&e.target!==toggleMenu){menu.classList.remove('show');toggleMenu.classList.remove('active')}});document.getElementById('brandBtn').onclick=()=>{map.easeTo({center:[0,20],zoom:2,duration:1000});toast('World view','info',1500)};document.getElementById('homeBtn').onclick=()=>{map.easeTo({center:[0,20],zoom:2,duration:1000});toast('World view','info',1500)};const dropBtn=document.getElementById('dropBtn');dropBtn.onclick=()=>{if(dropBtn.disabled){toast('Already dropped','info',2000);return}const openForm=(lat,lng)=>{map.easeTo({center:[lng,lat],zoom:17,duration:800});setTimeout(()=>openSheet('add',{lat,lng}),400)};if(navigator.geolocation){navigator.geolocation.getCurrentPosition(({coords:{latitude,longitude}})=>openForm(latitude,longitude),()=>{const c=map.getCenter();openForm(c.lat,c.lng)},{enableHighAccuracy:true,timeout:6000})}else{const c=map.getCenter();openForm(c.lat,c.lng)}};document.getElementById('locateBtn').onclick=()=>{if(!navigator.geolocation)return;toast('Locating...','info',1500);navigator.geolocation.getCurrentPosition(({coords:{latitude,longitude}})=>{map.easeTo({center:[longitude,latitude],zoom:14,duration:800});toast('You are here','success',2000)},()=>toast('Location unavailable','error',2000),{enableHighAccuracy:true,timeout:8000})};document.getElementById('seeMine').onclick=async()=>{if(document.getElementById('seeMine').classList.contains('disabled')){toast("No banana yet",'info',2000);return}try{const data=await fetchLatest();const b=(data.record?.bananas||[]).find(x=>x.deviceId===deviceId);if(!b){toast("No banana yet",'info',2000);return}map.easeTo({center:[b.lng,b.lat],zoom:17,duration:1000});toast("Your banana",'success',2000);menu.classList.remove('show');toggleMenu.classList.remove('active')}catch(e){toast('Error','error',2000)}};document.getElementById('shareMine').onclick=async()=>{if(document.getElementById('shareMine').classList.contains('disabled')){toast("Drop first",'info',2000);return}try{const data=await fetchLatest();const b=(data.record?.bananas||[]).find(x=>x.deviceId===deviceId);if(!b){toast("Drop first",'info',2000);return}const url=new URL(location.href);url.searchParams.set('id',deviceId);await navigator.clipboard.writeText(url.toString());toast("Link copied!",'success',2000);menu.classList.remove('show');toggleMenu.classList.remove('active')}catch(e){toast('Copy failed','error',2000)}};document.getElementById('deleteMine').onclick=()=>{if(document.getElementById('deleteMine').classList.contains('disabled')){toast("No banana",'info',2000);return}menu.classList.remove('show');toggleMenu.classList.remove('active');deleteMyBanana()};document.getElementById('randomBanana').onclick=()=>{menu.classList.remove('show');toggleMenu.classList.remove('active');goRandomBanana()};document.getElementById('browseBananas').onclick=()=>{menu.classList.remove('show');toggleMenu.classList.remove('active');openDeck()}};

const sheet=document.getElementById('sheet'),sheetTitle=document.getElementById('sheetTitle'),sheetSubtitle=document.getElementById('sheetSubtitle'),nameEl=document.getElementById('name'),msgEl=document.getElementById('msg'),photoEl=document.getElementById('photo'),preview=document.getElementById('preview'),previewImg=preview.querySelector('img'),removePhotoBtn=document.getElementById('removePhoto'),cancelBtn=document.getElementById('cancelBtn'),saveBtn=document.getElementById('saveBtn'),charCount=document.getElementById('charCount');let sheetMode='add',sheetTarget={lat:null,lng:null,existingPhoto:''};msgEl.addEventListener('input',()=>charCount.textContent=`${msgEl.value.length}/500`);photoEl.addEventListener('change',async()=>{const f=photoEl.files[0];if(!f){preview.classList.remove('show');previewImg.src='';return}try{const d=await fileToDataURL(f);previewImg.src=d;preview.classList.add('show')}catch(e){toast('Photo load failed','error',2000)}});removePhotoBtn.onclick=()=>{photoEl.value='';preview.classList.remove('show');previewImg.src='';sheetTarget.existingPhoto=''};const openSheet=(mode,p)=>{sheetMode=mode;if(mode==='add'){sheetTitle.textContent='Drop a Banana';sheetSubtitle.textContent='Share your moment with the world';nameEl.value='';msgEl.value='';photoEl.value='';preview.classList.remove('show');previewImg.src='';charCount.textContent='0/500';sheetTarget={lat:p.lat,lng:p.lng,existingPhoto:''};saveBtn.textContent='Save Banana'}else{sheetTitle.textContent='Edit Banana';sheetSubtitle.textContent='Update your moment';nameEl.value=p.name||'';msgEl.value=p.msg||'';photoEl.value='';charCount.textContent=`${(p.msg||'').length}/500`;if(p.photo){previewImg.src=p.photo;preview.classList.add('show')}else{preview.classList.remove('show');previewImg.src=''}sheetTarget={lat:p.lat,lng:p.lng,existingPhoto:p.photo||''};saveBtn.textContent='Update Banana'}sheet.classList.add('show');setTimeout(()=>nameEl.focus(),300)};const closeSheet=()=>sheet.classList.remove('show');cancelBtn.onclick=closeSheet;saveBtn.onclick=async()=>{try{const name=nameEl.value.trim(),msg=msgEl.value.trim();if(!name){toast('Enter name','error',2000);nameEl.focus();return}saveBtn.disabled=true;saveBtn.textContent='Saving...';const f=photoEl.files[0];let photo=sheetMode==='edit'?(sheetTarget.existingPhoto||''):'';if(f)photo=await fileToDataURL(f);if(sheetMode==='add')await saveBanana(sheetTarget.lat,sheetTarget.lng,msg,photo,name);else await updateBanana(msg,photo,name);closeSheet();saveBtn.disabled=false;saveBtn.textContent=sheetMode==='add'?'Save Banana':'Update Banana'}catch(e){console.error(e);toast(e.message||'Failed','error',3000);saveBtn.disabled=false;saveBtn.textContent=sheetMode==='add'?'Save Banana':'Update Banana'}};const saveBanana=async(lat,lng,msg,photo,name)=>{const data=await fetchLatest();const arr=data.record?.bananas||[];if(arr.some(b=>b.deviceId===deviceId))throw new Error('Already dropped');arr.push({lat,lng,msg,photo,name,ts:Date.now(),deviceId});await putBananas(arr);localStorage.setItem(DROPPED_KEY,'true');await loadBananas();map.easeTo({center:[lng,lat],zoom:17,duration:800});toast('Banana dropped!','success',2500)};const updateBanana=async(msg,photo,name)=>{const latest=await fetchLatest();const arr=latest.record?.bananas||[];const idx=arr.findIndex(x=>x.deviceId===deviceId);if(idx===-1)throw new Error("Not found");arr[idx]={...arr[idx],msg,photo,name};await putBananas(arr);await loadBananas();toast('Updated!','success',2000)};const deleteMyBanana=async()=>{if(!confirm('Delete your banana? This cannot be undone.'))return;try{const latest=await fetchLatest();const arr=latest.record?.bananas||[];const idx=arr.findIndex(x=>x.deviceId===deviceId);if(idx===-1){toast("No banana",'info',2000);return}arr.splice(idx,1);await putBananas(arr);localStorage.removeItem(DROPPED_KEY);await loadBananas();toast('Deleted','success',2000)}catch(e){console.error(e);toast('Delete failed','error',2000)}};

const goRandomBanana=()=>{const list=bananasCache.filter(b=>typeof b.lat==='number'&&typeof b.lng==='number');if(!list.length){toast("No bananas yet",'info',2000);return}const pick=list[Math.floor(Math.random()*list.length)];map.easeTo({center:[pick.lng,pick.lat],zoom:17,duration:900});setTimeout(()=>{new maplibregl.Popup({offset:12}).setLngLat([pick.lng,pick.lat]).setHTML(popupHTML(pick)).addTo(map)},500);toast('Random!','success',2000)};

const deck=document.getElementById('deck'),deckClose=document.getElementById('deckClose'),deckCounter=document.getElementById('deckCounter'),cardContent=document.getElementById('cardContent'),emptyState=document.getElementById('emptyState'),cardTitle=document.getElementById('cardTitle'),cardMeta=document.getElementById('cardMeta'),cardMsg=document.getElementById('cardMsg'),cardImg=document.getElementById('cardImg'),focusBtn=document.getElementById('focusBtn'),prevBtn=document.getElementById('prevBtn'),nextBtn=document.getElementById('nextBtn');let deckOpen=false,deckList=[],deckIndex=0;const refreshDeck=()=>{deckList=bananasCache.filter(b=>typeof b.lat==='number'&&typeof b.lng==='number').sort((a,b)=>(b.ts||0)-(a.ts||0));if(deckList.length&&deckIndex>=deckList.length)deckIndex=deckList.length-1;if(deckOpen)renderCard()};const openDeck=()=>{refreshDeck();deckIndex=0;deckOpen=true;deck.classList.add('show');if(!deckList.length){cardContent.style.display='none';emptyState.style.display='block';deckCounter.textContent='0/0';prevBtn.disabled=true;nextBtn.disabled=true}else{cardContent.style.display='block';emptyState.style.display='none';renderCard()}};const closeDeck=()=>{deckOpen=false;deck.classList.remove('show')};deckClose.onclick=closeDeck;const renderCard=()=>{const b=deckList[deckIndex];if(!b){closeDeck();return}cardTitle.textContent=b.name||'Anonymous';cardMeta.textContent=b.ts?timeAgo(b.ts):'';if(b.msg){cardMsg.style.display='block';cardMsg.textContent=b.msg}else{cardMsg.style.display='none'}if(b.photo){cardImg.style.display='block';cardImg.src=b.photo}else{cardImg.style.display='none';cardImg.removeAttribute('src')}deckCounter.textContent=`${deckIndex+1}/${deckList.length}`;prevBtn.disabled=deckIndex===0;nextBtn.disabled=deckIndex===deckList.length-1;focusBtn.onclick=()=>{map.easeTo({center:[b.lng,b.lat],zoom:17,duration:800});setTimeout(()=>{new maplibregl.Popup({offset:12}).setLngLat([b.lng,b.lat]).setHTML(popupHTML(b)).addTo(map)},400);closeDeck()}};prevBtn.onclick=()=>{if(!deckList.length||deckIndex===0)return;deckIndex--;renderCard()};nextBtn.onclick=()=>{if(!deckList.length||deckIndex===deckList.length-1)return;deckIndex++;renderCard()};document.addEventListener('keydown',e=>{if(!deckOpen)return;if(e.key==='ArrowLeft'&&deckIndex>0){deckIndex--;renderCard()}else if(e.key==='ArrowRight'&&deckIndex<deckList.length-1){deckIndex++;renderCard()}else if(e.key==='Escape'){closeDeck()}});

const startAuto=()=>{if(refreshHandle)clearInterval(refreshHandle);refreshHandle=setInterval(async()=>{await loadBananas();if(deckOpen)refreshDeck()},30000)};

const checkURL=()=>{const params=new URLSearchParams(location.search),sharedId=params.get('id');if(sharedId){setTimeout(async()=>{try{const data=await fetchLatest();const b=(data.record?.bananas||[]).find(x=>x.deviceId===sharedId);if(b){map.easeTo({center:[b.lng,b.lat],zoom:17,duration:1500});setTimeout(()=>{new maplibregl.Popup({offset:12}).setLngLat([b.lng,b.lat]).setHTML(popupHTML(b)).addTo(map)},1000);toast('Shared banana','success',2000)}else{toast('Not found','error',2000)}}catch(e){console.error(e)}},1500)}};

(async()=>{try{map=new maplibregl.Map({container:'map',style:makeStyle(),center:[0,20],zoom:2});map.addControl(new maplibregl.NavigationControl({showCompass:false}),'bottom-right');map.on('load',async()=>{await loadBananas();startAuto();if(navigator.geolocation){navigator.geolocation.getCurrentPosition(({coords:{latitude,longitude}})=>{map.easeTo({center:[longitude,latitude],zoom:11,duration:1200})},()=>{},{enableHighAccuracy:true,timeout:8000})}checkURL()});wireUI()}catch(e){console.error(e);toast('Map failed','error',0)}})();
</script>
</body>
</html>
