<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>banana.place üçå</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='0.9em' font-size='90'>üçå</text></svg>"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>

<style>
:root{--bg:#FFF7CC;--chip-bg:#fff;--chip-ink:#222;--chip-shadow:0 2px 8px rgba(0,0,0,.12);}
html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,sans-serif;}
#map{width:100%;height:100dvh;}
.ui{position:fixed;z-index:9999;top:16px;right:16px;display:flex;gap:10px;align-items:center;}
.chip{background:var(--chip-bg);color:var(--chip-ink);border:none;border-radius:999px;
 box-shadow:var(--chip-shadow);display:inline-flex;align-items:center;gap:10px;
 padding:10px 14px;font-weight:600;}
.chip select{border:none;background:transparent;font:inherit;color:inherit;cursor:pointer;
 appearance:none;padding-right:18px;}
.btn{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;border:none;
 background:var(--chip-bg);box-shadow:var(--chip-shadow);font-size:22px;cursor:pointer;}
.status{position:fixed;z-index:9999;left:50%;transform:translateX(-50%);bottom:16px;
 background:#fff;color:#222;padding:8px 12px;border-radius:12px;box-shadow:var(--chip-shadow);
 font-size:12px;}
.watermark{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;z-index:2;}
.watermark span{font-weight:800;letter-spacing:.06em;text-transform:uppercase;
 font-size:clamp(28px,12vw,120px);opacity:.08;transform:rotate(-18deg);color:#000;
 mix-blend-mode:multiply;text-align:center;line-height:1.05;}
input,textarea{width:100%;margin:6px 0;padding:6px;border-radius:6px;border:1px solid #ccc;
 font:inherit;}
</style>
</head>

<body>
<div class="ui">
 <div class="chip" title="Map theme">
  <span>üó∫Ô∏è</span>
  <select id="themeSelect">
   <option value="light">Light</option>
   <option value="dark">Dark</option>
   <option value="voyager">Voyager</option>
  </select>
 </div>
 <button class="btn" onclick="window.location.href='index.html'">üè†</button>
</div>

<div id="map"></div>
<div class="watermark" aria-hidden="true"><span>the banana place is under construction</span></div>
<div class="status" id="status">üçå Loading bananas‚Ä¶</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<script>
/* ===== JSONBin config (final) ===== */
const BIN_ID  = "68f0265443b1c97be96a4ad5";
const API_KEY = "$2a$10$RCnUKDWytC/ysiMgbX6/q.QRSKrLrAOPSOsZVPFYaaW06lur2V5X6";
const BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

const statusEl = document.getElementById("status");
const setStatus = (msg, ok = true) => { statusEl.textContent = msg; statusEl.style.color = ok ? "#111" : "#b00020"; };

/* ===== Map + themes ===== */
const map = L.map("map").setView([20,0],2);
const providers = {
  light:  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
  dark:   'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  voyager:'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'
};
let base;
function setTheme(name){
  if(base) map.removeLayer(base);
  base = L.tileLayer(providers[name]||providers.light, { attribution:'&copy; OpenStreetMap &copy; CARTO', detectRetina:true }).addTo(map);
  localStorage.setItem('banana_theme', name);
}
const select = document.getElementById('themeSelect');
const saved = localStorage.getItem('banana_theme') || 'light';
select.value = saved; setTheme(saved);
select.addEventListener('change', e => setTheme(e.target.value));

const bananaIcon = L.divIcon({ html:'üçå', className:'banana', iconSize:[32,32], iconAnchor:[16,32] });

/* ===== Load bananas ===== */
async function loadBananas(){
  setStatus("üçå Loading bananas‚Ä¶");
  try {
    const res = await fetch(`${BIN_URL}/latest`, {
      headers: { "X-Master-Key": API_KEY, "Content-Type":"application/json" }
    });
    if (!res.ok) {
      const body = await res.text();
      throw new Error(`Read failed: ${res.status} ${body}`);
    }
    const data = await res.json();
    const bananas = data.record?.bananas || [];
    bananas.forEach(b => {
      if (typeof b.lat === 'number' && typeof b.lng === 'number') {
        const m = L.marker([b.lat, b.lng], { icon: bananaIcon }).addTo(map);
        let html = `<strong>üçå Banana!</strong>`;
        if (b.msg)   html += `<p>${b.msg}</p>`;
        if (b.photo) html += `<img src="${b.photo}" style="max-width:140px;border-radius:8px"/>`;
        m.bindPopup(html);
      }
    });
    setStatus(`‚úÖ ${bananas.length} bananas loaded`);
  } catch (err) {
    console.error(err);
    setStatus(`‚ö†Ô∏è ${err.message}`, false);
  }
}

/* ===== Save banana ===== */
async function saveBanana(lat, lng, msg, photo){
  setStatus("üíæ Saving‚Ä¶");
  try {
    const r = await fetch(`${BIN_URL}/latest`, { headers: { "X-Master-Key": API_KEY, "Content-Type":"application/json" }});
    if (!r.ok) { const t = await r.text(); throw new Error(`Read-before-write failed: ${r.status} ${t}`); }
    const j = await r.json();
    const bananas = j.record?.bananas || [];
    bananas.push({ lat, lng, msg, photo, ts: Date.now() });

    const w = await fetch(BIN_URL, {
      method: "PUT",
      headers: { "X-Master-Key": API_KEY, "Content-Type":"application/json" },
      body: JSON.stringify({ bananas })
    });
    if (!w.ok) { const t = await w.text(); throw new Error(`Write failed: ${w.status} ${t}`); }

    setStatus("‚úÖ Banana saved!");
  } catch (err) {
    console.error(err);
    setStatus(`‚ö†Ô∏è ${err.message}`, false);
  }
}

/* ===== Click-to-add form ===== */
map.on("click", (e) => {
  const { lat, lng } = e.latlng;
  const form = document.createElement("div");
  form.innerHTML = `
    <h4 style="margin:0 0 8px">üçå Add a banana</h4>
    <label>Message</label>
    <textarea id="msg" rows="2" placeholder="say something fun‚Ä¶"></textarea>
    <label>Photo</label>
    <input type="file" id="photo" accept="image/*"/>
    <button id="saveBtn" style="margin-top:6px">Save</button>
  `;
  const popup = L.popup().setLatLng([lat, lng]).setContent(form).openOn(map);

  form.querySelector("#saveBtn").onclick = async () => {
    const msg = form.querySelector("#msg").value.trim();
    const file = form.querySelector("#photo").files[0];

    const addMarker = (photoData) => {
      const m = L.marker([lat, lng], { icon: bananaIcon }).addTo(map);
      let html = `<strong>üçå Banana!</strong>`;
      if (msg)       html += `<p>${msg}</p>`;
      if (photoData) html += `<img src="${photoData}" style="max-width:140px;border-radius:8px"/>`;
      m.bindPopup(html).openPopup();
    };

    if (file) {
      const reader = new FileReader();
      reader.onload = async (ev) => {
        const photoData = ev.target.result;
        await saveBanana(lat, lng, msg, photoData);
        addMarker(photoData);
      };
      reader.readAsDataURL(file);
    } else {
      await saveBanana(lat, lng, msg, "");
      addMarker("");
    }
    map.closePopup();
  };
});

/* ===== Geolocate on load ===== */
(function flyToUser(){
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    ({coords:{latitude,longitude}}) => {
      map.flyTo([latitude, longitude], 11, { duration: 1.2 });
      L.marker([latitude, longitude], { icon: bananaIcon }).addTo(map).bindPopup("üçå You are here").openPopup();
    },
    (err) => console.warn("Geolocation denied/unavailable:", err?.message || err),
    { enableHighAccuracy:true, timeout:8000, maximumAge:60000 }
  );
})();

/* ===== Boot ===== */
loadBananas();
</script>
</body>
</html>
