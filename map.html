<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>banana.place 🍌</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='0.9em' font-size='90'>🍌</text></svg>"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>

<style>
:root{--bg:#FFF7CC;--chip-bg:#fff;--chip-ink:#222;--chip-shadow:0 2px 8px rgba(0,0,0,.12);}
html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,sans-serif;}
#map{width:100%;height:100dvh;}
.ui{position:fixed;z-index:9999;top:16px;right:16px;display:flex;gap:10px;align-items:center;}
.chip{background:var(--chip-bg);color:var(--chip-ink);border:none;border-radius:999px;
 box-shadow:var(--chip-shadow);display:inline-flex;align-items:center;gap:10px;
 padding:10px 14px;font-weight:600;}
.chip select{border:none;background:transparent;font:inherit;color:inherit;cursor:pointer;
 appearance:none;padding-right:18px;}
.btn{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;border:none;
 background:var(--chip-bg);box-shadow:var(--chip-shadow);font-size:22px;cursor:pointer;}
.status{position:fixed;z-index:9999;left:50%;transform:translateX(-50%);bottom:16px;
 background:#fff;color:#222;padding:8px 12px;border-radius:12px;box-shadow:var(--chip-shadow);
 font-size:12px;}
.watermark{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;z-index:2;}
.watermark span{font-weight:800;letter-spacing:.06em;text-transform:uppercase;
 font-size:clamp(28px,12vw,120px);opacity:.08;transform:rotate(-18deg);color:#000;
 mix-blend-mode:multiply;text-align:center;line-height:1.05;}
input,textarea{width:100%;margin:6px 0;padding:6px;border-radius:6px;border:1px solid #ccc;
 font:inherit;}
</style>
</head>

<body>
<div class="ui">
 <div class="chip"><span>🗺️</span>
  <select id="themeSelect">
   <option value="light">Light</option><option value="dark">Dark</option>
   <option value="voyager">Voyager</option>
  </select>
 </div>
 <button class="btn" onclick="window.location.href='index.html'">🏠</button>
</div>

<div id="map"></div>
<div class="watermark"><span>the banana place is under construction</span></div>
<div class="status" id="status">🍌 Loading bananas…</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<script>
const BIN_ID="68f01f3143b1c97be96a44ca";
const API_KEY="$2a$10$/c6C8qI2DclpT0tVPmDMPekyPvJoMxy2Jydy.6QammlU2uvi3dG8C";
const BIN_URL=`https://api.jsonbin.io/v3/b/${BIN_ID}`;
const statusEl=document.getElementById("status");
const setStatus=(m,ok=true)=>{statusEl.textContent=m;statusEl.style.color=ok?"#111":"#b00020";};

const map=L.map("map").setView([20,0],2);
const layers={
 light:{url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"},
 dark:{url:"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"},
 voyager:{url:"https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"}
};
let tile;
function setTheme(t){if(tile)map.removeLayer(tile);tile=L.tileLayer(layers[t||'light'].url,
 {attribution:"&copy;OpenStreetMap &copy;CARTO"}).addTo(map);
 localStorage.setItem('banana_theme',t);}
const sel=document.getElementById('themeSelect');
setTheme(localStorage.getItem('banana_theme')||'light');
sel.value=localStorage.getItem('banana_theme')||'light';
sel.addEventListener('change',e=>setTheme(e.target.value));

const icon=L.divIcon({html:"🍌",className:"banana",iconSize:[32,32],iconAnchor:[16,32]});

async function loadBananas(){
 setStatus("🍌 Loading bananas…");
 try{
  const r=await fetch(`${BIN_URL}/latest`,{headers:{"X-Master-Key":API_KEY}});
  if(!r.ok)throw new Error(r.status);
  const d=await r.json();const arr=d.record?.bananas||[];
  arr.forEach(b=>{
   const m=L.marker([b.lat,b.lng],{icon}).addTo(map);
   let html=`<strong>🍌 Banana!</strong>`;
   if(b.msg)html+=`<p>${b.msg}</p>`;
   if(b.photo)html+=`<img src="${b.photo}" style="max-width:120px;border-radius:6px"/>`;
   m.bindPopup(html);
  });
  setStatus(`✅ ${arr.length} bananas loaded`);
 }catch(e){console.error(e);setStatus("⚠️ load error",false);}
}

async function saveBanana(lat,lng,msg,photo){
 setStatus("💾 Saving…");
 try{
  const r=await fetch(`${BIN_URL}/latest`,{headers:{"X-Master-Key":API_KEY}});
  const d=await r.json();const arr=d.record?.bananas||[];
  arr.push({lat,lng,msg,photo,ts:Date.now()});
  const w=await fetch(BIN_URL,{method:"PUT",
   headers:{"X-Master-Key":API_KEY,"Content-Type":"application/json"},
   body:JSON.stringify({bananas:arr})});
  if(!w.ok)throw new Error(w.status);
  setStatus("✅ Banana saved!");
 }catch(e){console.error(e);setStatus("⚠️ save error",false);}
}

map.on("click",e=>{
 const {lat,lng}=e.latlng;
 const form=document.createElement("div");
 form.innerHTML=`
  <h4>🍌 Add a banana</h4>
  <label>Message</label><textarea id="msg" rows="2"></textarea>
  <label>Photo</label><input type="file" id="photo" accept="image/*"/>
  <button id="saveBtn">Save</button>`;
 const popup=L.popup().setLatLng([lat,lng]).setContent(form).openOn(map);
 form.querySelector("#saveBtn").onclick=async()=>{
  const msg=form.querySelector("#msg").value.trim();
  const file=form.querySelector("#photo").files[0];
  let photoData="";
  if(file){
   const r=new FileReader();
   r.onload=async ev=>{
    photoData=ev.target.result;
    await saveBanana(lat,lng,msg,photoData);
    L.marker([lat,lng],{icon})
      .addTo(map)
      .bindPopup(`<strong>🍌 Banana!</strong><p>${msg}</p><img src="${photoData}" style="max-width:120px;border-radius:6px"/>`)
      .openPopup();
   };
   r.readAsDataURL(file);
  }else{
   await saveBanana(lat,lng,msg,"");
   L.marker([lat,lng],{icon})
     .addTo(map)
     .bindPopup(`<strong>🍌 Banana!</strong><p>${msg}</p>`)
     .openPopup();
  }
  map.closePopup();
 };
});

function flyToUser(){
 if(!navigator.geolocation)return;
 navigator.geolocation.getCurrentPosition(p=>{
  const{latitude,longitude}=p.coords;
  map.flyTo([latitude,longitude],11,{duration:1.2});
  L.marker([latitude,longitude],{icon}).addTo(map).bindPopup("🍌 You are here").openPopup();
 });
}

loadBananas();
flyToUser();
</script>
</body>
</html>
