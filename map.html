<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>banana.place üçå</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='0.9em' font-size='90'>üçå</text></svg>'"/>
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
:root{
  --bg:#FFF7CC;
  --surface:rgba(255,255,255,0.95);
  --surface-hover:rgba(255,255,255,0.98);
  --ink:#101010;
  --muted:#6b7280;
  --accent:#FFD93D;
  --accent-dark:#E0C24B;
  --success:#10b981;
  --warn:#FF4757;
  --shadow:0 4px 20px rgba(0,0,0,.08);
  --shadow-lg:0 10px 40px rgba(0,0,0,.12);
  --radius:16px;
  --radius-lg:20px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;-webkit-font-smoothing:antialiased;overflow:hidden}
#map{position:relative;height:100dvh;width:100%}

/* Glass morphism */
.glass{
  background:var(--surface);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  box-shadow:var(--shadow);
  transition:all 0.2s ease;
}

/* Animations */
@keyframes slideDown{
  from{opacity:0;transform:translateY(-12px)}
  to{opacity:1;transform:translateY(0)}
}

@keyframes slideUp{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:translateY(0)}
}

@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}

@keyframes pulse{
  0%,100%{transform:scale(1)}
  50%{transform:scale(1.05)}
}

@keyframes spin{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}

/* Header */
.header{
  position:fixed;
  top:16px;
  left:16px;
  right:16px;
  z-index:30010;
  display:flex;
  justify-content:space-between;
  gap:12px;
  pointer-events:none;
}

.header > *{pointer-events:auto}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
  background:var(--surface);
  backdrop-filter:blur(20px);
  border-radius:9999px;
  padding:10px 18px;
  box-shadow:var(--shadow);
  font-weight:700;
  font-size:15px;
  letter-spacing:-0.02em;
  transition:all 0.2s ease;
  cursor:pointer;
  user-select:none;
}

.brand:hover{
  box-shadow:var(--shadow-lg);
  transform:translateY(-2px);
}

.brand .emoji{
  font-size:22px;
  line-height:1;
  animation:pulse 2s ease-in-out infinite;
}

.hgroup{display:flex;gap:10px}

.iconbtn{
  width:46px;
  height:46px;
  border:none;
  border-radius:var(--radius);
  background:var(--surface);
  backdrop-filter:blur(20px);
  display:grid;
  place-items:center;
  box-shadow:var(--shadow);
  cursor:pointer;
  transition:all 0.2s ease;
  position:relative;
}

.iconbtn:hover{
  background:var(--surface-hover);
  box-shadow:var(--shadow-lg);
  transform:translateY(-2px);
}

.iconbtn:active{
  transform:translateY(0);
}

.iconbtn.active{
  background:var(--accent);
}

.iconbtn .badge{
  position:absolute;
  top:-4px;
  right:-4px;
  background:var(--warn);
  color:#fff;
  font-size:10px;
  font-weight:700;
  min-width:18px;
  height:18px;
  border-radius:9999px;
  display:grid;
  place-items:center;
  padding:0 5px;
  box-shadow:0 2px 8px rgba(255,71,87,0.4);
}

.icon{width:20px;height:20px;display:inline-block}
.icon-lg{width:24px;height:24px}

/* Search Panel */
.search-panel{
  position:fixed;
  top:78px;
  left:16px;
  right:16px;
  z-index:30009;
  display:none;
  animation:slideDown 0.2s ease;
}

.search-panel.show{display:block}

.search-input-wrapper{
  position:relative;
}

.search-panel input{
  width:100%;
  padding:14px 48px 14px 18px;
  border:none;
  border-radius:var(--radius);
  background:var(--surface);
  backdrop-filter:blur(20px);
  box-shadow:var(--shadow-lg);
  font:inherit;
  font-size:15px;
  transition:all 0.2s ease;
}

.search-panel input:focus{
  outline:none;
  box-shadow:0 6px 24px rgba(0,0,0,.12);
}

.search-panel input::placeholder{
  color:var(--muted);
}

.search-loading{
  position:absolute;
  right:16px;
  top:50%;
  transform:translateY(-50%);
  display:none;
}

.search-loading.show{display:block}

.spinner{
  width:20px;
  height:20px;
  border:2px solid rgba(0,0,0,0.1);
  border-top-color:var(--accent-dark);
  border-radius:50%;
  animation:spin 0.6s linear infinite;
}

.search-results{
  margin-top:10px;
  background:var(--surface);
  backdrop-filter:blur(20px);
  border-radius:var(--radius);
  box-shadow:var(--shadow-lg);
  max-height:60vh;
  overflow-y:auto;
  display:none;
}

.search-results.show{display:block}

.search-result-item{
  padding:14px 16px;
  cursor:pointer;
  transition:all 0.15s ease;
  border-bottom:1px solid rgba(0,0,0,0.05);
  display:flex;
  align-items:center;
  gap:12px;
}

.search-result-item:last-child{border-bottom:none}

.search-result-item:hover{
  background:rgba(255,217,61,0.15);
  padding-left:20px;
}

.search-result-item .icon-wrapper{
  width:36px;
  height:36px;
  background:rgba(255,217,61,0.2);
  border-radius:10px;
  display:grid;
  place-items:center;
  flex-shrink:0;
  font-size:18px;
}

.search-result-item .text{flex:1;min-width:0}

.search-result-item strong{
  display:block;
  font-size:15px;
  font-weight:600;
  margin-bottom:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.search-result-item small{
  display:block;
  font-size:12px;
  color:var(--muted);
  line-height:1.4;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Menu */
.menu{
  position:fixed;
  right:16px;
  top:78px;
  z-index:30008;
  background:var(--surface);
  backdrop-filter:blur(20px);
  border-radius:var(--radius-lg);
  box-shadow:var(--shadow-lg);
  padding:8px;
  min-width:240px;
  display:none;
  animation:slideDown 0.2s ease;
}

.menu.show{display:block}

.menu .row{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 14px;
  border-radius:12px;
  cursor:pointer;
  transition:all 0.15s ease;
  font-size:14px;
  font-weight:500;
}

.menu .row:hover{
  background:rgba(255,217,61,0.15);
  padding-left:18px;
}

.menu .row.disabled{
  opacity:0.4;
  cursor:not-allowed;
}

.menu .row.disabled:hover{
  background:transparent;
  padding-left:14px;
}

.menu .split{
  height:1px;
  background:rgba(0,0,0,0.06);
  margin:8px 10px;
}

/* Controls cluster */
.controls{
  position:fixed;
  right:16px;
  bottom:16px;
  z-index:30005;
  display:flex;
  flex-direction:column;
  gap:10px;
  pointer-events:none;
}

.controls > *{pointer-events:auto}

/* Legend */
.legend{
  position:fixed;
  left:16px;
  bottom:16px;
  z-index:30004;
  background:var(--surface);
  backdrop-filter:blur(20px);
  border-radius:9999px;
  padding:10px 16px;
  box-shadow:var(--shadow);
  display:flex;
  align-items:center;
  gap:12px;
  font-size:13px;
  font-weight:600;
  animation:slideUp 0.3s ease;
}

.legend .cluster{
  width:20px;
  height:20px;
  border-radius:50%;
  background:var(--accent);
  border:2.5px solid var(--accent-dark);
}

/* FAB */
.fab{
  border:none;
  border-radius:var(--radius);
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
  color:var(--ink);
  font-weight:700;
  font-size:15px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:14px 20px;
  box-shadow:var(--shadow-lg);
  cursor:pointer;
  transition:all 0.2s ease;
  white-space:nowrap;
  user-select:none;
}

.fab:hover{
  box-shadow:0 12px 48px rgba(255,217,61,0.4);
  transform:translateY(-3px);
}

.fab:active{
  transform:translateY(-1px);
}

.fab[disabled]{
  opacity:0.5;
  cursor:not-allowed;
  transform:none !important;
}

.fab.secondary{
  background:#fff;
  color:var(--ink);
}

.fab.secondary:hover{
  box-shadow:var(--shadow-lg);
}

/* Quick action buttons */
.quick-actions{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.quick-btn{
  width:46px;
  height:46px;
  border:none;
  border-radius:var(--radius);
  background:var(--surface);
  backdrop-filter:blur(20px);
  display:grid;
  place-items:center;
  box-shadow:var(--shadow);
  cursor:pointer;
  transition:all 0.2s ease;
  font-size:20px;
}

.quick-btn:hover{
  box-shadow:var(--shadow-lg);
  transform:translateY(-2px);
}

.quick-btn:active{
  transform:translateY(0);
}

/* Toast notifications */
.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:100px;
  z-index:40000;
  background:var(--surface);
  backdrop-filter:blur(20px);
  padding:12px 20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow-lg);
  font-size:14px;
  font-weight:500;
  max-width:90vw;
  animation:slideUp 0.3s ease;
  display:flex;
  align-items:center;
  gap:10px;
  pointer-events:none;
}

.toast.success{border-left:4px solid var(--success)}
.toast.error{border-left:4px solid var(--warn)}
.toast.info{border-left:4px solid var(--accent-dark)}

.toast button{
  margin-left:8px;
  padding:6px 12px;
  border-radius:8px;
  border:none;
  background:rgba(0,0,0,0.06);
  font-weight:600;
  font-size:12px;
  cursor:pointer;
  transition:all 0.15s ease;
  pointer-events:auto;
}

.toast button:hover{
  background:rgba(0,0,0,0.1);
}

/* Sheet */
.sheet{
  position:fixed;
  left:0;
  right:0;
  bottom:-100%;
  z-index:30012;
  background:var(--surface);
  backdrop-filter:blur(20px);
  border-top-left-radius:var(--radius-lg);
  border-top-right-radius:var(--radius-lg);
  box-shadow:0 -10px 50px rgba(0,0,0,.15);
  padding:20px 20px 30px;
  transition:bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  max-height:85vh;
  overflow-y:auto;
}

.sheet.show{bottom:0}

.sheet .grab{
  width:40px;
  height:4px;
  background:rgba(0,0,0,0.15);
  border-radius:4px;
  margin:0 auto 16px;
  cursor:grab;
}

.sheet h3{
  margin:0 0 8px 0;
  font-size:22px;
  font-weight:700;
  letter-spacing:-0.02em;
}

.sheet .subtitle{
  color:var(--muted);
  font-size:14px;
  margin-bottom:24px;
}

.sheet label{
  font-size:13px;
  font-weight:600;
  color:var(--muted);
  display:block;
  margin-bottom:8px;
  text-transform:uppercase;
  letter-spacing:0.03em;
}

.sheet input[type="text"], .sheet textarea{
  width:100%;
  margin-bottom:16px;
  padding:14px;
  border:2px solid rgba(0,0,0,0.08);
  border-radius:12px;
  font:inherit;
  font-size:15px;
  transition:all 0.2s ease;
  background:var(--surface);
}

.sheet input[type="text"]:focus, .sheet textarea:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 4px rgba(255,217,61,0.1);
}

.sheet textarea{
  resize:vertical;
  min-height:80px;
}

.file-upload{
  position:relative;
  margin-bottom:16px;
}

.file-upload-label{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:16px;
  border:2px dashed rgba(0,0,0,0.12);
  border-radius:12px;
  cursor:pointer;
  transition:all 0.2s ease;
  background:rgba(255,217,61,0.05);
}

.file-upload-label:hover{
  border-color:var(--accent-dark);
  background:rgba(255,217,61,0.1);
}

.file-upload input[type="file"]{
  position:absolute;
  opacity:0;
  width:0;
  height:0;
}

.file-upload-text{
  font-size:14px;
  font-weight:500;
  color:var(--muted);
}

.preview{
  display:none;
  margin-bottom:16px;
  position:relative;
}

.preview.show{display:block}

.preview img{
  max-width:100%;
  max-height:200px;
  border-radius:12px;
  display:block;
  box-shadow:var(--shadow);
}

.preview-remove{
  position:absolute;
  top:8px;
  right:8px;
  width:32px;
  height:32px;
  border-radius:50%;
  background:rgba(255,71,87,0.9);
  color:#fff;
  border:none;
  cursor:pointer;
  display:grid;
  place-items:center;
  box-shadow:var(--shadow);
  transition:all 0.2s ease;
}

.preview-remove:hover{
  transform:scale(1.1);
  background:var(--warn);
}

.sheet .row{
  display:flex;
  gap:12px;
  margin-top:24px;
}

.sheet .row button{
  flex:1;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:15px;
  cursor:pointer;
  transition:all 0.2s ease;
}

.sheet .save{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
  color:var(--ink);
}

.sheet .save:hover:not(:disabled){
  box-shadow:0 6px 20px rgba(255,217,61,0.3);
  transform:translateY(-2px);
}

.sheet .save:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

.sheet .cancel{
  background:rgba(0,0,0,0.06);
  color:var(--ink);
}

.sheet .cancel:hover{
  background:rgba(0,0,0,0.1);
}

.sheet .footer{
  margin-top:20px;
  color:var(--muted);
  font-size:11px;
  text-align:center;
}

/* Popup */
.maplibregl-popup-content{
  border-radius:var(--radius);
  padding:18px;
  box-shadow:var(--shadow-lg);
  max-width:300px;
}

.maplibregl-popup-content strong{
  font-size:17px;
  font-weight:700;
  display:block;
  margin-bottom:8px;
}

.maplibregl-popup-content p{
  margin:0 0 12px;
  color:#555;
  line-height:1.6;
  font-size:14px;
}

.maplibregl-popup-content img{
  max-width:100%;
  border-radius:10px;
  display:block;
  margin:12px 0;
  box-shadow:var(--shadow);
}

.popup-actions{
  display:flex;
  gap:8px;
  margin-top:12px;
}

.popbtn{
  appearance:none;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  background:var(--ink);
  color:#fff;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s ease;
  flex:1;
}

.popbtn:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow);
}

.popbtn.danger{
  background:var(--warn);
}

/* Banana Pin */
.banana-pin{
  font-size:32px;
  line-height:1;
  padding:8px;
  margin:-8px 0 0 -8px;
  filter:drop-shadow(0 4px 12px rgba(0,0,0,.2));
  user-select:none;
  -webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
  cursor:pointer;
  transform:translateY(-4px);
  background:transparent;
  border-radius:var(--radius);
  transition:all 0.2s ease;
}

.banana-pin:hover{
  transform:translateY(-8px) scale(1.15);
  filter:drop-shadow(0 8px 20px rgba(0,0,0,.3));
}

.banana-pin.mine{
  filter:drop-shadow(0 4px 12px rgba(255,217,61,.6));
}

.banana-pin.mine:hover{
  filter:drop-shadow(0 8px 20px rgba(255,217,61,.8));
}

/* Deck */
.deck{
  position:fixed;
  left:0;
  right:0;
  bottom:16px;
  z-index:30011;
  display:none;
  justify-content:center;
  animation:slideUp 0.3s ease;
  pointer-events:none;
}

.deck.show{display:flex}

.deck > *{pointer-events:auto}

.card{
  width:min(540px,92vw);
  background:var(--surface);
  backdrop-filter:blur(20px);
  border-radius:var(--radius-lg);
  box-shadow:var(--shadow-lg);
  padding:24px;
  touch-action:pan-y;
  will-change:transform;
}

.card-header{
  display:flex;
  align-items:start;
  justify-content:space-between;
  margin-bottom:12px;
}

.card h4{
  margin:0;
  font-size:20px;
  font-weight:700;
  letter-spacing:-0.02em;
}

.card-meta{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

.card p{
  margin:0 0 12px 0;
  color:#555;
  line-height:1.6;
  font-size:15px;
}

.card img{
  max-width:100%;
  border-radius:12px;
  margin:12px 0;
  box-shadow:var(--shadow);
}

.card .actions{
  display:flex;
  gap:10px;
  margin-top:16px;
}

.card .actions button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
  color:var(--ink);
  transition:all 0.2s ease;
  font-size:14px;
}

.card .actions button:hover{
  box-shadow:0 6px 20px rgba(255,217,61,0.3);
  transform:translateY(-2px);
}

.deck-nav{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  pointer-events:none;
  padding:0 12px;
}

.deck-nav button{
  pointer-events:auto;
  border:none;
  background:var(--surface);
  backdrop-filter:blur(20px);
  box-shadow:var(--shadow);
  width:48px;
  height:48px;
  border-radius:999px;
  display:grid;
  place-items:center;
  cursor:pointer;
  transition:all 0.2s ease;
}

.deck-nav button:hover{
  box-shadow:var(--shadow-lg);
  transform:scale(1.1);
}

.deck-nav button:disabled{
  opacity:0.3;
  cursor:not-allowed;
  transform:none;
}

.deckbar{
  position:absolute;
  top:-50px;
  left:0;
  right:0;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.deckbar strong{
  font-size:14px;
  font-weight:700;
  color:#444;
  letter-spacing:-0.01em;
}

.deck-counter{
  font-size:13px;
  color:var(--muted);
  font-weight:500;
}

.deckbar .close{
  position:absolute;
  right:12px;
  top:2px;
  border:none;
  background:var(--surface);
  backdrop-filter:blur(20px);
  box-shadow:var(--shadow);
  width:38px;
  height:38px;
  border-radius:999px;
  display:grid;
  place-items:center;
  cursor:pointer;
  transition:all 0.2s ease;
}

.deckbar .close:hover{
  box-shadow:var(--shadow-lg);
  transform:scale(1.05) rotate(90deg);
}

/* Watermark */
.watermark{
  position:fixed;
  inset:0;
  display:grid;
  place-items:center;
  pointer-events:none;
  z-index:2;
  opacity:0;
  transition:opacity 0.3s ease;
}

.watermark.show{opacity:1}

.watermark span{
  font-weight:800;
  letter-spacing:0.06em;
  text-transform:uppercase;
  font-size:clamp(20px,8vw,80px);
  opacity:0.06;
  transform:rotate(-18deg);
  color:#000;
  mix-blend-mode:multiply;
  text-align:center;
  line-height:1.1;
  padding:20px;
}

/* Loading overlay */
.loading-overlay{
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:50000;
  display:grid;
  place-items:center;
  transition:opacity 0.3s ease;
}

.loading-overlay.hide{
  opacity:0;
  pointer-events:none;
}

.loading-content{
  text-align:center;
}

.loading-content .emoji{
  font-size:64px;
  display:block;
  margin-bottom:20px;
  animation:pulse 1.5s ease-in-out infinite;
}

.loading-content h2{
  font-size:24px;
  font-weight:700;
  margin-bottom:8px;
  letter-spacing:-0.02em;
}

.loading-content p{
  color:var(--muted);
  font-size:14px;
}

/* Responsive */
@media (max-width:640px){
  .banana-pin{font-size:28px}
  .header{top:12px;left:12px;right:12px}
  .search-panel{top:70px;left:12px;right:12px}
  .menu{right:12px;top:70px}
  .legend{left:12px;bottom:12px;font-size:12px;padding:8px 12px}
  .controls{right:12px;bottom:12px}
  .fab{padding:12px 16px;font-size:14px}
  .sheet{max-height:90vh}
  .card{padding:20px}
}

@media (max-width:420px){
  .brand span:not(.emoji){display:none}
  .fab span{display:none}
  .fab{padding:14px;width:46px;justify-content:center}
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <span class="emoji">üçå</span>
    <h2>banana.place</h2>
    <p>Loading your banana experience...</p>
  </div>
</div>

<!-- SVG Icons -->
<svg style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
  <symbol id="i-menu" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-search" viewBox="0 0 24 24"><path d="M11 19a8 8 0 1 1 5.292-14.036A8 8 0 0 1 11 19Z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-eye" viewBox="0 0 24 24"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></symbol>
  <symbol id="i-share" viewBox="0 0 24 24"><path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 3v14M7 8l5-5 5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-trash" viewBox="0 0 24 24"><path d="M4 7h16M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 7l1 12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-12M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-left" viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  <symbol id="i-right" viewBox="0 0 24 24"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  <symbol id="i-close" viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-location" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="10" r="3" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
</svg>

<!-- Header -->
<div class="header">
  <div class="brand" id="brandBtn" title="Back to overview"><span class="emoji">üçå</span><span>banana.place</span></div>
  <div class="hgroup">
    <button class="iconbtn" id="toggleSearch" aria-label="Search"><svg class="icon"><use href="#i-search"/></svg></button>
    <button class="iconbtn" id="toggleMenu" aria-label="Menu"><svg class="icon"><use href="#i-menu"/></svg></button>
  </div>
</div>

<!-- Search Panel -->
<div class="search-panel" id="searchPanel">
  <div class="search-input-wrapper">
    <input type="text" id="searchInput" placeholder="Search any location..." autocomplete="off">
    <div class="search-loading" id="searchLoading"><div class="spinner"></div></div>
  </div>
  <div class="search-results" id="searchResults"></div>
</div>

<!-- Menu -->
<div class="menu" id="menu">
  <div class="row" id="seeMine"><svg class="icon"><use href="#i-eye"/></svg><span class="label">See my banana</span></div>
  <div class="row" id="shareMine"><svg class="icon"><use href="#i-share"/></svg><span class="label">Share my banana</span></div>
  <div class="row" id="deleteMine"><svg class="icon"><use href="#i-trash"/></svg><span class="label" style="color:var(--warn)">Delete my banana</span></div>
  <div class="split"></div>
  <div class="row" id="randomBanana">üé≤ <span class="label">Random banana</span></div>
  <div class="row" id="browseBananas">üåç <span class="label">Browse bananas</span></div>
</div>

<!-- Legend -->
<div class="legend"><span class="emoji">üçå</span><span style="color:var(--muted)">banana</span><span class="cluster"></span><span style="color:var(--muted)">cluster</span></div>

<!-- Controls -->
<div class="controls">
  <div class="quick-actions">
    <button class="quick-btn" id="locateBtn" title="Go to my location">üìç</button>
  </div>
  <button id="dropBtn" class="fab" title="Drop a banana">
    <svg class="icon-lg"><use href="#i-plus"/></svg>
    <span>Drop Banana</span>
  </button>
</div>

<div id="map"></div>
<div class="watermark" id="watermark" aria-hidden="true"><span>Welcome to banana.place</span></div>

<!-- Toast notification container -->
<div id="toastContainer"></div>

<!-- Bottom-sheet -->
<div class="sheet" id="sheet">
  <div class="grab"></div>
  <h3 id="sheetTitle">Drop a banana</h3>
  <p class="subtitle" id="sheetSubtitle">Share your moment with the world üåç</p>
  
  <label for="name">Your Name</label>
  <input id="name" type="text" placeholder="What should we call you?" maxlength="50">
  
  <label for="msg">Message</label>
  <textarea id="msg" rows="3" placeholder="Share something fun, inspiring, or interesting..." maxlength="500"></textarea>
  
  <label>Photo (optional)</label>
  <div class="file-upload">
    <label for="photo" class="file-upload-label">
      <span style="font-size:24px">üì∏</span>
      <span class="file-upload-text">Tap to add a photo</span>
    </label>
    <input id="photo" type="file" accept="image/*">
  </div>
  
  <div class="preview" id="preview">
    <img alt="preview">
    <button class="preview-remove" id="removePhoto" type="button">‚úï</button>
  </div>
  
  <div class="row">
    <button class="cancel" id="cancelBtn">Cancel</button>
    <button class="save" id="saveBtn">Save Banana</button>
  </div>
  <div class="footer">Search powered by Nominatim ‚Ä¢ Map ¬© OpenStreetMap & CARTO</div>
</div>

<!-- Swipe deck -->
<div class="deck" id="deck">
  <div class="deckbar">
    <strong>Browse Bananas</strong>
    <span class="deck-counter" id="deckCounter">1 / 1</span>
    <button class="close" id="deckClose" aria-label="Close"><svg class="icon"><use href="#i-close"/></svg></button>
  </div>
  <div class="card" id="card">
    <div class="card-header">
      <div>
        <h4 id="cardTitle">Banana</h4>
        <div class="card-meta" id="cardMeta"></div>
      </div>
    </div>
    <p id="cardMsg" style="display:none"></p>
    <img id="cardImg" alt="" style="display:none">
    <div class="actions">
      <button id="focusBtn">üìç Show on map</button>
    </div>
  </div>
  <div class="deck-nav">
    <button id="prevBtn" aria-label="Previous"><svg class="icon"><use href="#i-left"/></svg></button>
    <button id="nextBtn" aria-label="Next"><svg class="icon"><use href="#i-right"/></svg></button>
  </div>
</div>

<script>
/* ---------- Toast notification system ---------- */
const toastContainer = document.getElementById('toastContainer');
let activeToast = null;

function showToast(message, type = 'info', duration = 3000, showRetry = false) {
  // Remove existing toast
  if (activeToast) {
    activeToast.remove();
    activeToast = null;
  }

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span>${message}</span>`;

  if (showRetry) {
    const retryBtn = document.createElement('button');
    retryBtn.textContent = 'Retry';
    retryBtn.onclick = () => loadBananas();
    toast.appendChild(retryBtn);
  }

  toastContainer.appendChild(toast);
  activeToast = toast;

  if (duration > 0) {
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
      if (activeToast === toast) activeToast = null;
    }, duration);
  }
}

/* ---------- Utils ---------- */
function uuid(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));}
function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file);});}
function timeAgo(timestamp) {
  const seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return 'just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  if (days < 30) return `${days}d ago`;
  const months = Math.floor(days / 30);
  if (months < 12) return `${months}mo ago`;
  return `${Math.floor(months / 12)}y ago`;
}

/* ---------- Error handling ---------- */
window.addEventListener('error', e => {
  console.error(e.error || e.message);
  showToast('‚ö†Ô∏è Something went wrong', 'error', 5000, true);
});
window.addEventListener('unhandledrejection', e => {
  console.error(e.reason);
  showToast('‚ö†Ô∏è Connection error', 'error', 5000, true);
});

/* ---------- Device ID & Storage ---------- */
const DEVICE_KEY = 'banana_device_id';
const DROPPED_KEY = 'banana_already_dropped';
let deviceId = localStorage.getItem(DEVICE_KEY);
if (!deviceId) {
  deviceId = uuid();
  localStorage.setItem(DEVICE_KEY, deviceId);
}

/* ---------- JSONBin Config ---------- */
const BIN_ID = "68f0265443b1c97be96a4ad5";
const API_KEY = "$2a$10$RCnUKDWytC/ysiMgbX6/q.QRSKrLrAOPSOsZVPFYaaW06lur2V5X6";
const BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

/* ---------- Map Style ---------- */
function makeStyle() {
  const sub = ['a', 'b', 'c', 'd'];
  const base = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
  const labels = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png';
  return {
    version: 8,
    glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources: {
      base: { type: 'raster', tiles: sub.map(s => base.replace('{s}', s)), tileSize: 256, attribution: '¬© OpenStreetMap, ¬© CARTO' },
      labels: { type: 'raster', tiles: sub.map(s => labels.replace('{s}', s)), tileSize: 256 },
      bananas: { type: 'geojson', data: { type: 'FeatureCollection', features: [] }, cluster: true, clusterRadius: 55 }
    },
    layers: [
      { id: 'base', type: 'raster', source: 'base' },
      { id: 'labels', type: 'raster', source: 'labels', paint: { 'raster-opacity': .65 } },
      {
        id: 'clusters', type: 'circle', source: 'bananas', filter: ['has', 'point_count'],
        paint: {
          'circle-color': '#FFE066',
          'circle-stroke-width': 2,
          'circle-stroke-color': '#E0C24B',
          'circle-radius': ['step', ['get', 'point_count'], 14, 10, 18, 25, 24, 50, 30]
        }
      },
      {
        id: 'cluster-count', type: 'symbol', source: 'bananas', filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-size': 12,
          'text-font': ['Open Sans Bold', 'Noto Sans Regular', 'Arial Unicode MS Bold']
        },
        paint: { 'text-color': '#222' }
      }
    ]
  };
}

/* ---------- Boot Map ---------- */
let map;
const loadingOverlay = document.getElementById('loadingOverlay');
const watermark = document.getElementById('watermark');

(async function boot() {
  try {
    map = new maplibregl.Map({
      container: 'map',
      style: makeStyle(),
      center: [0, 20],
      zoom: 2
    });

    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'bottom-right');

    map.on('load', async () => {
      await loadBananas();
      startAutoRefresh();
      setTimeout(() => {
        loadingOverlay.classList.add('hide');
        watermark.classList.add('show');
        setTimeout(() => watermark.classList.remove('show'), 3000);
      }, 500);
      geolocateUser();
    });

    wireUI();
  } catch (e) {
    console.error(e);
    showToast('‚ö†Ô∏è Failed to load map', 'error', 0, true);
  }
})();

/* ---------- Banana Data ---------- */
let bananasCache = [];
let domMarkers = [];

const asFeature = b => ({
  type: 'Feature',
  properties: {
    deviceId: b.deviceId || '',
    name: b.name || '',
    msg: b.msg || '',
    photo: b.photo || '',
    ts: b.ts || 0
  },
  geometry: {
    type: 'Point',
    coordinates: [b.lng, b.lat]
  }
});

function clearDomMarkers() {
  domMarkers.forEach(m => m.remove());
  domMarkers = [];
}

function popupHTML(p) {
  const title = p.name ? escapeHTML(p.name) : 'Anonymous Banana';
  const isMine = p.deviceId === deviceId;
  
  let html = `<div><strong>${title}</strong>`;
  
  if (p.ts) {
    html += `<p style="font-size:12px;color:var(--muted);margin:4px 0 8px">${timeAgo(p.ts)}</p>`;
  }
  
  if (p.msg) {
    html += `<p>${escapeHTML(p.msg)}</p>`;
  }
  
  if (p.photo) {
    html += `<img src="${p.photo}" alt="banana photo">`;
  }
  
  if (isMine) {
    html += `<div class="popup-actions">
              <button class="popbtn" data-action="edit">Edit</button>
              <button class="popbtn danger" data-action="delete">Delete</button>
            </div>`;
  }
  
  return html + '</div>';
}

function createBananaMarker(feature) {
  const el = document.createElement('div');
  el.className = 'banana-pin';
  if (feature.properties.deviceId === deviceId) {
    el.className += ' mine';
  }
  el.textContent = 'üçå';
  el.title = feature.properties.name || 'Banana';

  const openDetails = (ev) => {
    ev.preventDefault();
    ev.stopPropagation();
    
    const p = feature.properties;
    const coords = feature.geometry.coordinates;

    const popup = new maplibregl.Popup({ offset: 12, closeOnClick: true })
      .setLngLat(coords)
      .setHTML(popupHTML(p))
      .addTo(map);

    const root = popup.getElement();
    const content = root.querySelector('.maplibregl-popup-content');
    
    if (content) {
      content.addEventListener('click', (e) => {
        const btn = e.target.closest('.popbtn');
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();

        const action = btn.dataset.action;
        if (action === 'edit') {
          popup.remove();
          openSheet('edit', { lat: coords[1], lng: coords[0], ...p });
        } else if (action === 'delete') {
          popup.remove();
          deleteMyBanana();
        }
      }, { passive: false });
    }
  };

  ['pointerdown', 'touchstart', 'mousedown'].forEach(type => {
    el.addEventListener(type, (e) => { e.stopPropagation(); }, { passive: true });
  });
  el.addEventListener('pointerup', openDetails, { passive: false });
  el.addEventListener('touchend', openDetails, { passive: false });
  el.addEventListener('click', openDetails, { passive: false });

  return new maplibregl.Marker({ element: el, anchor: 'bottom' })
    .setLngLat(feature.geometry.coordinates);
}

function renderDomMarkers(geojson) {
  clearDomMarkers();
  geojson.features.forEach(f => {
    if (f.properties.point_count) return;
    const m = createBananaMarker(f).addTo(map);
    domMarkers.push(m);
  });
}

async function fetchLatest() {
  const res = await fetch(`${BIN_URL}/latest`, {
    headers: { "X-Master-Key": API_KEY, "Content-Type": "application/json" }
  });
  if (!res.ok) throw new Error(`Failed to load bananas`);
  return res.json();
}

async function putBananas(arr) {
  const res = await fetch(BIN_URL, {
    method: 'PUT',
    headers: { "X-Master-Key": API_KEY, "Content-Type": "application/json" },
    body: JSON.stringify({ bananas: arr })
  });
  if (!res.ok) throw new Error(`Failed to save banana`);
}

async function loadBananas() {
  try {
    const data = await fetchLatest();
    bananasCache = data.record?.bananas || [];
    
    const feats = bananasCache
      .filter(b => typeof b.lat === 'number' && typeof b.lng === 'number')
      .map(asFeature);
    
    const src = map.getSource('bananas');
    if (src) src.setData({ type: 'FeatureCollection', features: feats });
    
    renderDomMarkers({ type: 'FeatureCollection', features: feats });
    
    const already = bananasCache.some(b => b.deviceId === deviceId) || 
                    localStorage.getItem(DROPPED_KEY) === 'true';
    
    const dropBtn = document.getElementById('dropBtn');
    const seeMine = document.getElementById('seeMine');
    const shareMine = document.getElementById('shareMine');
    const deleteMine = document.getElementById('deleteMine');
    
    dropBtn.disabled = already;
    dropBtn.querySelector('span').textContent = already ? "Banana Dropped" : "Drop Banana";
    
    if (already) {
      seeMine.classList.remove('disabled');
      shareMine.classList.remove('disabled');
      deleteMine.classList.remove('disabled');
    } else {
      seeMine.classList.add('disabled');
      shareMine.classList.add('disabled');
      deleteMine.classList.add('disabled');
    }
    
    showToast(`‚úÖ Loaded ${feats.length} banana${feats.length !== 1 ? 's' : ''}`, 'success', 2000);
  } catch (e) {
    console.error(e);
    showToast('‚ö†Ô∏è Failed to load bananas', 'error', 0, true);
  }
}

/* ---------- Search Functionality ---------- */
function wireSearch() {
  const toggleSearch = document.getElementById('toggleSearch');
  const searchPanel = document.getElementById('searchPanel');
  const searchInput = document.getElementById('searchInput');
  const searchResults = document.getElementById('searchResults');
  const searchLoading = document.getElementById('searchLoading');

  if (!toggleSearch || !searchPanel || !searchInput || !searchResults) return;

  toggleSearch.onclick = () => {
    const isOpen = searchPanel.classList.contains('show');
    searchPanel.classList.toggle('show', !isOpen);
    toggleSearch.classList.toggle('active', !isOpen);
    
    if (!isOpen) {
      searchInput.focus();
    } else {
      searchInput.value = '';
      searchResults.classList.remove('show');
      searchResults.innerHTML = '';
    }
  };

  document.addEventListener('click', (e) => {
    if (!searchPanel.contains(e.target) && e.target !== toggleSearch) {
      searchPanel.classList.remove('show');
      searchResults.classList.remove('show');
      toggleSearch.classList.remove('active');
      searchInput.value = '';
      searchResults.innerHTML = '';
    }
  });

  function debounce(fn, ms) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), ms);
    };
  }

  async function searchLocations(query) {
    if (!query.trim()) {
      searchResults.classList.remove('show');
      searchResults.innerHTML = '';
      searchLoading.classList.remove('show');
      return;
    }

    try {
      searchLoading.classList.add('show');
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8`
      );
      const results = await response.json();
      searchLoading.classList.remove('show');
      displayResults(results);
    } catch (e) {
      console.error('Search error:', e);
      searchLoading.classList.remove('show');
      searchResults.innerHTML = '<div class="search-result-item"><small style="color:var(--warn)">Search failed. Try again.</small></div>';
      searchResults.classList.add('show');
    }
  }

  function displayResults(results) {
    searchResults.innerHTML = '';

    if (!results || results.length === 0) {
      searchResults.innerHTML = '<div class="search-result-item"><small>No locations found</small></div>';
      searchResults.classList.add('show');
      return;
    }

    results.forEach(result => {
      const item = document.createElement('div');
      item.className = 'search-result-item';

      const nameParts = result.display_name.split(',');
      const mainName = nameParts[0];
      const fullName = result.display_name;

      item.innerHTML = `
        <div class="icon-wrapper">üìç</div>
        <div class="text">
          <strong>${escapeHTML(mainName)}</strong>
          <small>${escapeHTML(fullName)}</small>
        </div>
      `;

      item.onclick = () => {
        const lon = parseFloat(result.lon);
        const lat = parseFloat(result.lat);

        map.easeTo({
          center: [lon, lat],
          zoom: 15,
          duration: 800
        });

        searchPanel.classList.remove('show');
        searchResults.classList.remove('show');
        toggleSearch.classList.remove('active');
        searchInput.value = '';
        searchResults.innerHTML = '';

        showToast(`üìç ${mainName}`, 'info', 2000);
      };

      searchResults.appendChild(item);
    });

    searchResults.classList.add('show');
  }

  searchInput.addEventListener('input', debounce(() => {
    searchLocations(searchInput.value);
  }, 400));

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      searchLocations(searchInput.value);
    }
  });
}

/* ---------- UI Wiring ---------- */
function wireUI() {
  wireSearch();

  const menu = document.getElementById('menu');
  const toggleMenu = document.getElementById('toggleMenu');
  
  toggleMenu.onclick = () => {
    const isOpen = menu.classList.contains('show');
    menu.classList.toggle('show', !isOpen);
    toggleMenu.classList.toggle('active', !isOpen);
  };

  document.addEventListener('click', e => {
    if (!menu.contains(e.target) && e.target !== toggleMenu) {
      menu.classList.remove('show');
      toggleMenu.classList.remove('active');
    }
  });

  // Brand button - return to overview
  document.getElementById('brandBtn').onclick = () => {
    map.easeTo({ center: [0, 20], zoom: 2, duration: 1000 });
    showToast('üåç World view', 'info', 1500);
  };

  // Drop button
  const dropBtn = document.getElementById('dropBtn');
  dropBtn.onclick = () => {
    if (dropBtn.disabled) {
      showToast('You already dropped a banana!', 'info', 2000);
      return;
    }

    const openForm = (lat, lng) => {
      map.easeTo({ center: [lng, lat], zoom: 18, duration: 800 });
      setTimeout(() => openSheet('add', { lat, lng }), 400);
    };

    if (navigator.geolocation) {
      showToast('üìç Finding your location...', 'info', 2000);
      navigator.geolocation.getCurrentPosition(
        ({ coords: { latitude, longitude } }) => openForm(latitude, longitude),
        () => {
          const c = map.getCenter();
          openForm(c.lat, c.lng);
          showToast('Using map center', 'info', 2000);
        },
        { enableHighAccuracy: true, timeout: 6000, maximumAge: 60000 }
      );
    } else {
      const c = map.getCenter();
      openForm(c.lat, c.lng);
    }
  };

  // Locate button
  document.getElementById('locateBtn').onclick = () => {
    if (!navigator.geolocation) {
      showToast('Geolocation not supported', 'error', 2000);
      return;
    }
    
    showToast('üìç Locating...', 'info', 1500);
    navigator.geolocation.getCurrentPosition(
      ({ coords: { latitude, longitude } }) => {
        map.easeTo({ center: [longitude, latitude], zoom: 15, duration: 800 });
        showToast('üìç You are here', 'success', 2000);
      },
      () => showToast('Could not get location', 'error', 2000),
      { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
    );
  };

  // Menu actions
  document.getElementById('seeMine').onclick = async () => {
    if (document.getElementById('seeMine').classList.contains('disabled')) {
      showToast("You haven't dropped a banana yet", 'info', 2000);
      return;
    }
    
    try {
      const data = await fetchLatest();
      const arr = data.record?.bananas || [];
      const b = arr.find(x => x.deviceId === deviceId);
      
      if (!b) {
        showToast("You haven't dropped a banana yet", 'info', 2000);
        return;
      }
      
      map.easeTo({ center: [b.lng, b.lat], zoom: 18, duration: 1000 });
      showToast("üìç Your banana", 'success', 2000);
      menu.classList.remove('show');
      toggleMenu.classList.remove('active');
    } catch (e) {
      showToast('‚ö†Ô∏è Failed to find your banana', 'error', 2000);
    }
  };

  document.getElementById('shareMine').onclick = async () => {
    if (document.getElementById('shareMine').classList.contains('disabled')) {
      showToast("Drop a banana first", 'info', 2000);
      return;
    }
    
    try {
      const data = await fetchLatest();
      const arr = data.record?.bananas || [];
      const b = arr.find(x => x.deviceId === deviceId);
      
      if (!b) {
        showToast("Drop a banana first", 'info', 2000);
        return;
      }
      
      const url = new URL(location.href);
      url.searchParams.set('id', deviceId);
      await navigator.clipboard.writeText(url.toString());
      
      showToast("üîó Link copied to clipboard!", 'success', 2000);
      menu.classList.remove('show');
      toggleMenu.classList.remove('active');
    } catch (e) {
      showToast('‚ö†Ô∏è Failed to copy link', 'error', 2000);
    }
  };

  document.getElementById('deleteMine').onclick = () => {
    if (document.getElementById('deleteMine').classList.contains('disabled')) {
      showToast("You don't have a banana to delete", 'info', 2000);
      return;
    }
    menu.classList.remove('show');
    toggleMenu.classList.remove('active');
    deleteMyBanana();
  };

  document.getElementById('randomBanana').onclick = () => {
    menu.classList.remove('show');
    toggleMenu.classList.remove('active');
    goRandomBanana();
  };

  document.getElementById('browseBananas').onclick = () => {
    menu.classList.remove('show');
    toggleMenu.classList.remove('active');
    openDeck();
  };
}

/* ---------- Sheet (Add/Edit Banana) ---------- */
const sheet = document.getElementById('sheet');
const sheetTitle = document.getElementById('sheetTitle');
const sheetSubtitle = document.getElementById('sheetSubtitle');
const nameEl = document.getElementById('name');
const msgEl = document.getElementById('msg');
const photoEl = document.getElementById('photo');
const preview = document.getElementById('preview');
const previewImg = preview.querySelector('img');
const removePhotoBtn = document.getElementById('removePhoto');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');

let sheetMode = 'add';
let sheetTarget = { lat: null, lng: null, existingPhoto: '' };

photoEl.addEventListener('change', async () => {
  const f = photoEl.files[0];
  if (!f) {
    preview.classList.remove('show');
    previewImg.src = '';
    return;
  }
  
  try {
    const dataUrl = await fileToDataURL(f);
    previewImg.src = dataUrl;
    preview.classList.add('show');
  } catch (e) {
    showToast('Failed to load photo', 'error', 2000);
  }
});

removePhotoBtn.onclick = () => {
  photoEl.value = '';
  preview.classList.remove('show');
  previewImg.src = '';
  sheetTarget.existingPhoto = '';
};

function openSheet(mode, p) {
  sheetMode = mode;
  
  if (mode === 'add') {
    sheetTitle.textContent = 'Drop a banana';
    sheetSubtitle.textContent = 'Share your moment with the world üåç';
    nameEl.value = '';
    msgEl.value = '';
    photoEl.value = '';
    preview.classList.remove('show');
    previewImg.src = '';
    sheetTarget = { lat: p.lat, lng: p.lng, existingPhoto: '' };
    saveBtn.textContent = 'Save Banana';
  } else {
    sheetTitle.textContent = 'Edit your banana';
    sheetSubtitle.textContent = 'Update your moment';
    nameEl.value = p.name || '';
    msgEl.value = p.msg || '';
    photoEl.value = '';
    
    if (p.photo) {
      previewImg.src = p.photo;
      preview.classList.add('show');
    } else {
      preview.classList.remove('show');
      previewImg.src = '';
    }
    
    sheetTarget = { lat: p.lat, lng: p.lng, existingPhoto: p.photo || '' };
    saveBtn.textContent = 'Update Banana';
  }
  
  sheet.classList.add('show');
  nameEl.focus();
}

function closeSheet() {
  sheet.classList.remove('show');
}

cancelBtn.onclick = closeSheet;

saveBtn.onclick = async () => {
  try {
    const name = nameEl.value.trim();
    const msg = msgEl.value.trim();
    
    if (!name) {
      showToast('Please enter your name', 'error', 2000);
      nameEl.focus();
      return;
    }
    
    saveBtn.disabled = true;
    saveBtn.textContent = sheetMode === 'add' ? 'Saving...' : 'Updating...';
    
    const f = photoEl.files[0];
    let photo = sheetMode === 'edit' ? (sheetTarget.existingPhoto || '') : '';
    
    if (f) {
      photo = await fileToDataURL(f);
    }
    
    if (sheetMode === 'add') {
      await saveBanana(sheetTarget.lat, sheetTarget.lng, msg, photo, name);
    } else {
      await updateBanana(msg, photo, name);
    }
    
    closeSheet();
    saveBtn.disabled = false;
    saveBtn.textContent = sheetMode === 'add' ? 'Save Banana' : 'Update Banana';
  } catch (e) {
    console.error(e);
    showToast('‚ö†Ô∏è ' + (e.message || 'Failed to save'), 'error', 3000);
    saveBtn.disabled = false;
    saveBtn.textContent = sheetMode === 'add' ? 'Save Banana' : 'Update Banana';
  }
};

async function saveBanana(lat, lng, msg, photo, name) {
  const data = await fetchLatest();
  const arr = data.record?.bananas || [];
  
  if (arr.some(b => b.deviceId === deviceId)) {
    throw new Error('You already dropped a banana on this device');
  }
  
  arr.push({
    lat,
    lng,
    msg,
    photo,
    name,
    ts: Date.now(),
    deviceId
  });
  
  await putBananas(arr);
  localStorage.setItem(DROPPED_KEY, 'true');
  await loadBananas();
  
  map.easeTo({ center: [lng, lat], zoom: 18, duration: 800 });
  showToast('üéâ Banana dropped successfully!', 'success', 3000);
}

async function updateBanana(msg, photo, name) {
  const latest = await fetchLatest();
  const arr = latest.record?.bananas || [];
  const idx = arr.findIndex(x => x.deviceId === deviceId);
  
  if (idx === -1) {
    throw new Error("Couldn't find your banana");
  }
  
  arr[idx] = { ...arr[idx], msg, photo, name };
  await putBananas(arr);
  await loadBananas();
  
  showToast('‚úÖ Banana updated!', 'success', 2000);
}

async function deleteMyBanana() {
  if (!confirm('Are you sure you want to delete your banana? This cannot be undone.')) {
    return;
  }
  
  try {
    const latest = await fetchLatest();
    const arr = latest.record?.bananas || [];
    const idx = arr.findIndex(x => x.deviceId === deviceId);
    
    if (idx === -1) {
      showToast("You don't have a banana to delete", 'info', 2000);
      return;
    }
    
    arr.splice(idx, 1);
    await putBananas(arr);
    localStorage.removeItem(DROPPED_KEY);
    
    document.getElementById('dropBtn').disabled = false;
    await loadBananas();
    
    showToast('üóëÔ∏è Banana deleted', 'success', 2000);
  } catch (e) {
    console.error(e);
    showToast('‚ö†Ô∏è Failed to delete banana', 'error', 2000);
  }
}

/* ---------- Random Banana ---------- */
function goRandomBanana() {
  const list = bananasCache.filter(b => typeof b.lat === 'number' && typeof b.lng === 'number');
  
  if (!list.length) {
    showToast("No bananas to explore yet ü§∑", 'info', 2000);
    return;
  }
  
  const pick = list[Math.floor(Math.random() * list.length)];
  
  map.easeTo({ center: [pick.lng, pick.lat], zoom: 18, duration: 900 });
  
  setTimeout(() => {
    new maplibregl.Popup({ offset: 12 })
      .setLngLat([pick.lng, pick.lat])
      .setHTML(popupHTML(pick))
      .addTo(map);
  }, 500);
  
  showToast('üé≤ Random banana!', 'success', 2000);
}

/* ---------- Browse Deck ---------- */
const deck = document.getElementById('deck');
const deckClose = document.getElementById('deckClose');
const deckCounter = document.getElementById('deckCounter');
const card = document.getElementById('card');
const cardTitle = document.getElementById('cardTitle');
const cardMeta = document.getElementById('cardMeta');
const cardMsg = document.getElementById('cardMsg');
const cardImg = document.getElementById('cardImg');
const focusBtn = document.getElementById('focusBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

let deckOpen = false;
let deckList = [];
let deckIndex = 0;

function refreshDeckList() {
  deckList = bananasCache
    .filter(b => typeof b.lat === 'number' && typeof b.lng === 'number')
    .sort((a, b) => (b.ts || 0) - (a.ts || 0));
  
  if (deckList.length && deckIndex >= deckList.length) {
    deckIndex = deckList.length - 1;
  }
  
  if (deckOpen) renderCard();
}

function openDeck() {
  refreshDeckList();
  
  if (!deckList.length) {
    showToast("No bananas to browse yet ü§∑", 'info', 2000);
    return;
  }
  
  deckIndex = 0;
  deckOpen = true;
  deck.classList.add('show');
  renderCard();
}

function closeDeck() {
  deckOpen = false;
  deck.classList.remove('show');
}

deckClose.onclick = closeDeck;

function renderCard() {
  const b = deckList[deckIndex];
  
  if (!b) {
    closeDeck();
    return;
  }
  
  cardTitle.textContent = b.name || 'Anonymous Banana';
  
  if (b.ts) {
    cardMeta.textContent = timeAgo(b.ts);
  } else {
    cardMeta.textContent = '';
  }
  
  if (b.msg) {
    cardMsg.style.display = 'block';
    cardMsg.textContent = b.msg;
  } else {
    cardMsg.style.display = 'none';
  }
  
  if (b.photo) {
    cardImg.style.display = 'block';
    cardImg.src = b.photo;
  } else {
    cardImg.style.display = 'none';
    cardImg.removeAttribute('src');
  }
  
  deckCounter.textContent = `${deckIndex + 1} / ${deckList.length}`;
  
  prevBtn.disabled = deckIndex === 0;
  nextBtn.disabled = deckIndex === deckList.length - 1;
  
  focusBtn.onclick = () => {
    map.easeTo({ center: [b.lng, b.lat], zoom: 18, duration: 800 });
    
    setTimeout(() => {
      new maplibregl.Popup({ offset: 12 })
        .setLngLat([b.lng, b.lat])
        .setHTML(popupHTML(b))
        .addTo(map);
    }, 400);
    
    closeDeck();
  };
}

prevBtn.onclick = () => {
  if (!deckList.length || deckIndex === 0) return;
  deckIndex--;
  renderCard();
};

nextBtn.onclick = () => {
  if (!deckList.length || deckIndex === deckList.length - 1) return;
  deckIndex++;
  renderCard();
};

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (!deckOpen) return;
  
  if (e.key === 'ArrowLeft' && deckIndex > 0) {
    deckIndex--;
    renderCard();
  } else if (e.key === 'ArrowRight' && deckIndex < deckList.length - 1) {
    deckIndex++;
    renderCard();
  } else if (e.key === 'Escape') {
    closeDeck();
  }
});

/* ---------- Auto-refresh ---------- */
let refreshHandle = null;

function startAutoRefresh() {
  stopAutoRefresh();
  refreshHandle = setInterval(async () => {
    await loadBananas();
    if (deckOpen) refreshDeckList();
  }, 30000); // Refresh every 30 seconds
}

function stopAutoRefresh() {
  if (refreshHandle) {
    clearInterval(refreshHandle);
    refreshHandle = null;
  }
}

/* ---------- Geolocation ---------- */
function geolocateUser() {
  if (!navigator.geolocation) return;
  
  navigator.geolocation.getCurrentPosition(
    ({ coords: { latitude, longitude } }) => {
      map.easeTo({ center: [longitude, latitude], zoom: 12, duration: 1200 });
      showToast('üìç Located!', 'success', 2000);
    },
    () => {
      // Silently fail - user might have denied permission
    },
    { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
  );
}

/* ---------- URL Parameter Handling ---------- */
(function checkURLParams() {
  const params = new URLSearchParams(location.search);
  const sharedId = params.get('id');
  
  if (sharedId) {
    setTimeout(async () => {
      try {
        const data = await fetchLatest();
        const arr = data.record?.bananas || [];
        const b = arr.find(x => x.deviceId === sharedId);
        
        if (b) {
          map.easeTo({ center: [b.lng, b.lat], zoom: 18, duration: 1500 });
          setTimeout(() => {
            new maplibregl.Popup({ offset: 12 })
              .setLngLat([b.lng, b.lat])
              .setHTML(popupHTML(b))
              .addTo(map);
          }, 1000);
          showToast('üìç Showing shared banana', 'success', 2000);
        } else {
          showToast('Shared banana not found', 'error', 2000);
        }
      } catch (e) {
        console.error(e);
      }
    }, 1500);
  }
})();
</script>
</body>
</html>
