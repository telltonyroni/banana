<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>banana.place üçå</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='0.9em' font-size='90'>üçå</text></svg>'"/>
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
:root{--bg:#FFF7CC;--surface:#fff;--ink:#101010;--muted:#6b7280;--accent:#111;--warn:#b00020;--shadow:0 8px 28px rgba(0,0,0,.14)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial}
#map{position:relative;height:100dvh;width:100%}

/* Icons */
.icon{width:22px;height:22px;display:inline-block;fill:currentColor}
.icon-lg{width:26px;height:26px}

/* Header */
.header{position:fixed;top:10px;left:10px;right:10px;z-index:30010;display:flex;justify-content:space-between;gap:8px}
.brand{display:flex;align-items:center;gap:10px;background:var(--surface);border-radius:9999px;padding:8px 12px;box-shadow:var(--shadow);font-weight:700}
.brand .emoji{font-size:18px;line-height:1}
.hgroup{display:flex;gap:8px}
.iconbtn{width:44px;height:44px;border:none;border-radius:14px;background:var(--surface);display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer}

/* Collapsible search */
.search-wrap{position:fixed;left:50%;transform:translateX(-50%);top:64px;width:min(720px,92vw);z-index:30006;display:none}
.search{display:flex;align-items:center;gap:10px;background:var(--surface);border-radius:16px;padding:10px 14px;box-shadow:var(--shadow)}
.search input{border:none;outline:none;background:transparent;font:inherit;width:100%}
.results{margin-top:8px;background:var(--surface);border-radius:14px;box-shadow:var(--shadow);max-height:45vh;overflow:auto;display:none}
.results.show{display:block}
.result-item{padding:10px 14px;border-top:1px solid #f1f1f1;cursor:pointer}
.result-item:first-child{border-top:none}
.result-item small{display:block;color:var(--muted)}

/* Menu */
.menu{position:fixed;right:10px;top:64px;z-index:30008;background:var(--surface);border-radius:16px;box-shadow:var(--shadow);padding:10px;min-width:230px;display:none}
.menu.show{display:block}
.menu .row{display:flex;align-items:center;gap:10px;padding:10px 8px;border-radius:12px;cursor:pointer}
.menu .row:hover{background:#f6f6f6}
.menu .split{height:1px;background:#eee;margin:6px 0}

/* Legend bottom-left */
.legend{position:fixed;left:12px;bottom:12px;z-index:30004;background:var(--surface);border-radius:9999px;padding:8px 12px;box-shadow:var(--shadow);display:flex;align-items:center;gap:10px}
.legend .emoji{font-size:18px;line-height:1}
.legend .cluster{width:18px;height:18px;border-radius:50%;background:#FFE066;border:2px solid #E0C24B}

/* Drop FAB */
.fab{position:fixed;right:12px;bottom:12px;z-index:30000;border:none;border-radius:16px;background:var(--accent);color:#fff;font-weight:700;display:flex;align-items:center;gap:10px;padding:12px 16px;box-shadow:var(--shadow);cursor:pointer}
.fab[disabled]{opacity:.5;cursor:not-allowed}

/* Status */
.status{position:fixed;left:50%;transform:translateX(-50%);bottom:110px;z-index:30000;background:var(--surface);padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);font-size:12px}
.status button{margin-left:8px;padding:4px 8px;border-radius:8px;border:1px solid #e5e5e5;background:#fff;font-weight:600;cursor:pointer}

/* Bottom-sheet */
.sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:30012;background:#fff;border-top-left-radius:20px;border-top-right-radius:20px;box-shadow:0 -20px 40px rgba(0,0,0,.15);padding:14px 16px 18px;transition:bottom .25s ease}
.sheet.show{bottom:0}
.sheet .grab{width:44px;height:4px;background:#ddd;border-radius:4px;margin:6px auto 10px}
.sheet h3{margin:0 0 8px 0;font-size:18px}
.sheet label{font-size:13px;color:#444}
.sheet input[type="text"], .sheet textarea{width:100%;margin:8px 0 10px;padding:12px;border:1px solid #e5e5e5;border-radius:12px;font:inherit}
.sheet input[type="file"]{width:100%;margin:6px 0 10px}
.preview{display:none;margin-top:6px}
.preview img{max-width:120px;border-radius:10px;display:block}
.sheet .row{display:flex;gap:8px}
.sheet .row button{flex:1;padding:12px;border:none;border-radius:12px;font-weight:700;cursor:pointer}
.sheet .save{background:var(--accent);color:#fff}
.sheet .cancel{background:#f2f2f2;color:#111}

/* Popup */
.maplibregl-popup{max-width:300px}
.maplibregl-popup-content img{max-width:140px;border-radius:8px;display:block;margin-top:6px}

/* Emoji marker (DOM) */
.banana-pin{
  font-size:28px; line-height:1; filter: drop-shadow(0 2px 4px rgba(0,0,0,.25));
  user-select:none; -webkit-user-select:none; cursor:pointer; transform: translateY(-4px);
}

/* Watermark */
.watermark{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;z-index:2}
.watermark span{font-weight:800;letter-spacing:.06em;text-transform:uppercase;font-size:clamp(26px,11vw,110px);opacity:.08;transform:rotate(-18deg);color:#000;mix-blend-mode:multiply;text-align:center;line-height:1.05}

/* Mobile */
@media (max-width:520px){ .legend{left:10px;bottom:10px} }
</style>
</head>

<body>
<!-- SVG icon sprite -->
<svg style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
  <symbol id="i-menu" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-search" viewBox="0 0 24 24"><path d="M11 19a8 8 0 1 1 5.292-14.036A8 8 0 0 1 11 19Z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-eye" viewBox="0 0 24 24"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></symbol>
  <symbol id="i-share" viewBox="0 0 24 24"><path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 3v14M7 8l5-5 5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="i-trash" viewBox="0 0 24 24"><path d="M4 7h16M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 7l1 12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-12M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
</svg>

<!-- Header -->
<div class="header">
  <div class="brand"><span class="emoji">üçå</span><span>banana.place</span></div>
  <div class="hgroup">
    <button class="iconbtn" id="toggleSearch" aria-label="Search"><svg class="icon"><use href="#i-search"/></svg></button>
    <button class="iconbtn" id="toggleMenu" aria-label="Menu"><svg class="icon"><use href="#i-menu"/></svg></button>
  </div>
</div>

<!-- Search -->
<div class="search-wrap" id="searchWrap">
  <div class="search">
    <svg class="icon"><use href="#i-search"/></svg>
    <input id="searchInput" type="text" placeholder="Search a place‚Ä¶"/>
  </div>
  <div class="results" id="results"></div>
</div>

<!-- Legend -->
<div class="legend">
  <span class="emoji">üçå</span>
  <span style="color:var(--muted);font-weight:600">banana</span>
  <span class="cluster"></span><span style="color:var(--muted);font-weight:600">cluster</span>
</div>

<!-- Menu -->
<div class="menu" id="menu">
  <div class="row" id="seeMine"><svg class="icon"><use href="#i-eye"/></svg><span class="label">See my banana</span></div>
  <div class="row" id="shareMine"><svg class="icon"><use href="#i-share"/></svg><span class="label">Share my banana</span></div>
  <div class="row" id="deleteMine"><svg class="icon"><use href="#i-trash"/></svg><span class="label" style="color:var(--warn)">Delete my banana</span></div>
  <div class="split"></div>
  <div class="row" style="justify-content:space-between">
    <span class="label">Auto refresh</span>
    <input id="liveToggle" type="checkbox" checked style="appearance:none;width:40px;height:24px;background:#ddd;border-radius:999px;position:relative;cursor:pointer;outline:none">
  </div>
  <div class="row" style="cursor:default;color:var(--muted);font-size:12px">Refreshes every 20s.</div>
</div>

<!-- Drop FAB -->
<button id="dropBtn" class="fab" title="Drop a banana">
  <svg class="icon-lg"><use href="#i-plus"/></svg><span>Drop Banana</span>
</button>

<div id="map"></div>
<div class="watermark" aria-hidden="true"><span>the banana place is under construction</span></div>
<div class="status" id="status">üçå Loading bananas‚Ä¶ <button id="retryBtn" style="display:none">Retry</button></div>

<!-- Bottom-sheet -->
<div class="sheet" id="sheet">
  <div class="grab"></div>
  <h3 id="sheetTitle">Add a banana</h3>
  <label for="name">Name</label>
  <input id="name" type="text" placeholder="your name"/>
  <label for="msg">Message</label>
  <textarea id="msg" rows="3" placeholder="say something fun‚Ä¶"></textarea>
  <label for="photo">Photo (optional)</label>
  <input id="photo" type="file" accept="image/*"/>
  <div class="preview" id="preview"><img alt="preview"/></div>
  <div class="row"><button class="cancel" id="cancelBtn">Cancel</button><button class="save" id="saveBtn">Save</button></div>
  <div style="margin-top:6px;color:#999;font-size:11px">Search by Nominatim ‚Ä¢ Map ¬© OpenStreetMap & CARTO</div>
</div>

<script>
/* ===== JSONBin config ===== */
const BIN_ID  = "68f0265443b1c97be96a4ad5";
const API_KEY = "$2a$10$RCnUKDWytC/ysiMgbX6/q.QRSKrLrAOPSOsZVPFYaaW06lur2V5X6";
const BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

/* ===== UI refs ===== */
const statusEl = document.getElementById("status");
const retryBtn = document.getElementById("retryBtn");
const setStatus=(msg,ok=true,showRetry=false)=>{ statusEl.textContent=msg; statusEl.style.color=ok?"#111":"#b00020"; if(showRetry){ retryBtn.style.display='inline-block'; statusEl.appendChild(retryBtn);} else retryBtn.style.display='none'; };

/* One banana per device */
function uuid(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));}
const DEVICE_KEY='banana_device_id';
let deviceId=localStorage.getItem(DEVICE_KEY);
if(!deviceId){ deviceId=uuid(); localStorage.setItem(DEVICE_KEY,deviceId); }
const DROPPED_KEY='banana_already_dropped';

/* ===== Map (Voyager) ===== */
function makeStyle(){
  const sub=['a','b','c','d'];
  const base='https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
  const labels='https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png';
  return{version:8,glyphs:'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources:{
      base:{type:'raster',tiles:sub.map(s=>base.replace('{s}',s)),tileSize:256,attribution:'¬© OpenStreetMap, ¬© CARTO'},
      labels:{type:'raster',tiles:sub.map(s=>labels.replace('{s}',s)),tileSize:256,attribution:'¬© CARTO labels'},
      bananas:{type:'geojson',data:{type:'FeatureCollection',features:[]},cluster:true,clusterRadius:55}
    },
    layers:[
      {id:'base',type:'raster',source:'base'},
      {id:'labels',type:'raster',source:'labels',paint:{'raster-opacity':.65}},
      {id:'clusters',type:'circle',source:'bananas',filter:['has','point_count'],
        paint:{'circle-color':'#FFE066','circle-stroke-width':2,'circle-stroke-color':'#E0C24B',
               'circle-radius':['step',['get','point_count'],14,10,18,25,24,50,30]}},
      {id:'cluster-count',type:'symbol',source:'bananas',filter:['has','point_count'],
        layout:{'text-field':['get','point_count_abbreviated'],'text-size':12,'text-font':['Open Sans Bold','Noto Sans Regular','Arial Unicode MS Bold']},
        paint:{'text-color':'#222'}}
      /* no unclustered layer ‚Äî we render DOM emoji markers for those */
    ]};
}
const map=new maplibregl.Map({container:'map',style:makeStyle(),center:[0,20],zoom:2});
map.addControl(new maplibregl.NavigationControl({showCompass:false}),'bottom-right');

/* ===== Data helpers ===== */
let bananasCache=[]; let lastGeoJSON={type:'FeatureCollection',features:[]};
const asFeature=b=>({type:'Feature',properties:{deviceId:b.deviceId||'',name:b.name||'',msg:b.msg||'',photo:b.photo||'',ts:b.ts||0},geometry:{type:'Point',coordinates:[b.lng,b.lat]}});

/* DOM emoji markers for unclustered points */
let domMarkers=[];
function clearDomMarkers(){ domMarkers.forEach(m=>m.remove()); domMarkers=[]; }
function renderDomMarkers(geojson){
  clearDomMarkers();
  geojson.features.forEach(f=>{
    if (f.properties.point_count) return; // clusters handled by layers
    const el=document.createElement('div');
    el.className='banana-pin';
    el.textContent='üçå';
    el.title = f.properties.name || 'Banana';
    el.addEventListener('click',()=>{
      const p=f.properties, coords=f.geometry.coordinates;
      const html = popupHTML(p);
      new maplibregl.Popup({offset:12}).setLngLat(coords).setHTML(html).addTo(map);
      setTimeout(()=>{
        const edit=document.getElementById('editBan');
        const del =document.getElementById('delBan');
        if(edit) edit.onclick=(ev)=>{ev.preventDefault(); openSheet('edit',{lat:coords[1],lng:coords[0],...p});};
        if(del)  del.onclick =(ev)=>{ev.preventDefault(); deleteMyBanana();};
      },0);
    });
    const marker=new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map);
    domMarkers.push(marker);
  });
}

function drawBananas(gj){
  lastGeoJSON=gj;
  const src=map.getSource('bananas');
  if(src) src.setData(gj);
  renderDomMarkers(gj);
}

async function fetchLatest(){
  const res=await fetch(`${BIN_URL}/latest`,{headers:{"X-Master-Key":API_KEY,"Content-Type":"application/json"}});
  if(!res.ok){ const t=await res.text(); throw new Error(`Read ${res.status}: ${t||'check BIN_ID/key/privacy'}`); }
  return res.json();
}
async function putBananas(arr){
  const w=await fetch(BIN_URL,{method:"PUT",headers:{"X-Master-Key":API_KEY,"Content-Type":"application/json"},body:JSON.stringify({bananas:arr})});
  if(!w.ok){ const t=await w.text(); throw new Error(`Write ${w.status}: ${t||'check BIN permissions'}`); }
}

/* Load & retry */
async function loadBananas(skipToast=false){
  if(!skipToast) setStatus("üçå Loading bananas‚Ä¶");
  try{
    const data=await fetchLatest();
    bananasCache=data.record?.bananas||[];
    const feats=bananasCache.filter(b=>typeof b.lat==='number'&&typeof b.lng==='number').map(asFeature);
    drawBananas({type:'FeatureCollection',features:feats});
    const already=bananasCache.some(b=>b.deviceId===deviceId)||localStorage.getItem(DROPPED_KEY)==='true';
    dropBtn.disabled=already; dropBtn.querySelector('span').textContent=already?"Banana Dropped":"Drop Banana";
    if(!skipToast) setStatus(`‚úÖ Loaded ${feats.length} bananas`);
  }catch(e){ console.error(e); setStatus(`‚ö†Ô∏è ${e.message}`,false,true); }
}
retryBtn.onclick=()=> loadBananas(false);

/* Search */
const searchWrap=document.getElementById('searchWrap');
const toggleSearch=document.getElementById('toggleSearch');
const input=document.getElementById('searchInput');
const results=document.getElementById('results');
toggleSearch.onclick=()=>{const open=searchWrap.style.display==='block'; searchWrap.style.display=open?'none':'block'; if(!open) input.focus();}
function showResults(items){ results.innerHTML=''; items.forEach(r=>{const d=document.createElement('div'); d.className='result-item'; d.innerHTML=`<strong>${escapeHTML(r.display_name.split(',')[0])}</strong><small>${escapeHTML(r.display_name)}</small>`; d.onclick=()=>{results.classList.remove('show'); map.easeTo({center:[+r.lon,+r.lat],zoom:15,duration:800});}; results.appendChild(d);}); results.classList.toggle('show',items.length>0); }
async function doSearch(q){ if(!q.trim()){results.classList.remove('show');return;} try{const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=8`); showResults(await r.json()); }catch(e){console.error(e);} }
input.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(input.value); });
input.addEventListener('input',debounce(()=>doSearch(input.value),300));
document.addEventListener('click',e=>{ if(!searchWrap.contains(e.target)&&e.target!==toggleSearch){ results.classList.remove('show'); }});
function debounce(fn,ms){let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);}}

/* Popups + edit/delete (shared) */
let currentPopup=null;
function popupHTML(p){
  const title=p.name?escapeHTML(p.name):'Banana';
  let h=`<div><strong>${title}</strong>`;
  if(p.msg) h+=`<p style="margin:.35rem 0">${escapeHTML(p.msg)}</p>`;
  if(p.photo) h+=`<img src="${p.photo}" alt="banana photo"/>`;
  if(p.deviceId===deviceId){
    h+=`<div style="display:flex;gap:12px;margin-top:8px">
          <a href="#" id="editBan">Edit</a>
          <a href="#" id="delBan" style="color:${getComputedStyle(document.documentElement).getPropertyValue('--warn')||'#b00020'}">Delete</a>
        </div>`;
  }
  return h+`</div>`;
}

/* Bottom-sheet */
const sheet=document.getElementById('sheet'); const sheetTitle=document.getElementById('sheetTitle');
const nameEl=document.getElementById('name'); const msgEl=document.getElementById('msg'); const photoEl=document.getElementById('photo');
const preview=document.getElementById('preview'); const previewImg=preview.querySelector('img');
const cancelBtn=document.getElementById('cancelBtn'); const saveBtn=document.getElementById('saveBtn');
let sheetMode='add'; let sheetTarget={lat:null,lng:null,existingPhoto:""};
photoEl.addEventListener('change',async()=>{const f=photoEl.files[0]; if(!f){preview.style.display='none'; previewImg.src=''; return;} const d=await fileToDataURL(f); previewImg.src=d; preview.style.display='block';});
function openSheet(mode,p){ sheetMode=mode; if(mode==='add'){ sheetTitle.textContent='Add a banana'; nameEl.value=''; msgEl.value=''; photoEl.value=''; preview.style.display='none'; sheetTarget={lat:p.lat,lng:p.lng,existingPhoto:""}; } else { sheetTitle.textContent='Edit your banana'; nameEl.value=p.name||''; msgEl.value=p.msg||''; photoEl.value=''; preview.style.display='none'; sheetTarget={lat:p.lat,lng:p.lng,existingPhoto:p.photo||""}; } sheet.classList.add('show'); }
const closeSheet=()=> sheet.classList.remove('show'); cancelBtn.onclick=closeSheet;
function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file);});}

/* CRUD */
async function saveBanana(lat,lng,msg,photo,name){
  setStatus("üíæ Saving‚Ä¶");
  try{
    const data=await fetchLatest();
    const arr=data.record?.bananas||[];
    if(arr.some(b=>b.deviceId===deviceId)){ setStatus("You already dropped a banana on this device.",false); dropBtn.disabled=true; dropBtn.querySelector('span').textContent='Banana Dropped'; return; }
    arr.push({lat,lng,msg,photo,name,ts:Date.now(),deviceId});
    await putBananas(arr);
    localStorage.setItem(DROPPED_KEY,'true');
    await loadBananas(true);
    setStatus("‚úÖ Banana saved!");
  }catch(e){ console.error(e); setStatus(`‚ö†Ô∏è ${e.message}`,false,true); }
}
saveBtn.onclick=async()=>{
  try{
    const name=nameEl.value.trim();
    const msg=msgEl.value.trim();
    const f=photoEl.files[0];
    let photo=sheetMode==='edit'?(sheetTarget.existingPhoto||""):"";
    if(f) photo=await fileToDataURL(f);
    if(sheetMode==='add'){
      await saveBanana(sheetTarget.lat,sheetTarget.lng,msg,photo,name);
    }else{
      const latest=await fetchLatest();
      const arr=latest.record?.bananas||[];
      const idx=arr.findIndex(x=>x.deviceId===deviceId);
      if(idx===-1){ setStatus("üòï Couldn‚Äôt find your banana.",false,true); return; }
      arr[idx]={...arr[idx],msg,photo,name};
      await putBananas(arr);
      await loadBananas(true);
      setStatus("‚úÖ Banana updated!");
    }
    closeSheet(); if(currentPopup) currentPopup.remove();
  }catch(e){ console.error(e); setStatus(`‚ö†Ô∏è ${e.message}`,false,true); }
};
async function deleteMyBanana(){
  try{
    const latest=await fetchLatest();
    const arr=latest.record?.bananas||[];
    const idx=arr.findIndex(x=>x.deviceId===deviceId);
    if(idx===-1){ setStatus("You don't have a banana yet.",false); return; }
    if(!confirm("Delete your banana?")) return;
    setStatus("üóëÔ∏è Deleting‚Ä¶");
    arr.splice(idx,1); await putBananas(arr);
    localStorage.removeItem(DROPPED_KEY);
    dropBtn.disabled=false; dropBtn.querySelector('span').textContent='Drop Banana';
    await loadBananas(true);
    setStatus("‚úÖ Banana deleted.");
    if(currentPopup) currentPopup.remove();
  }catch(e){ console.error(e); setStatus(`‚ö†Ô∏è ${e.message}`,false,true); }
}

/* Buttons & menu */
const dropBtn=document.getElementById('dropBtn');
const menu=document.getElementById('menu');
const toggleMenu=document.getElementById('toggleMenu');
toggleMenu.onclick=()=>{const open=menu.classList.contains('show'); menu.classList.toggle('show',!open); searchWrap.style.display='none';}
document.addEventListener('click',e=>{ if(!menu.contains(e.target)&&e.target!==toggleMenu) menu.classList.remove('show'); });

dropBtn.onclick=()=>{
  if(dropBtn.disabled) return;
  const openForm=(lat,lng)=>{ map.easeTo({center:[lng,lat],zoom:18,duration:800}); openSheet('add',{lat,lng}); };
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(({coords:{latitude,longitude}})=>openForm(latitude,longitude),
      ()=>{ const c=map.getCenter(); openForm(c.lat,c.lng); },
      {enableHighAccuracy:true,timeout:6000,maximumAge:60000});
  } else { const c=map.getCenter(); openForm(c.lat,c.lng); }
};

document.getElementById('seeMine').onclick=async()=>{
  try{
    const latest=await fetchLatest();
    const arr=latest.record?.bananas||[];
    const b=arr.find(x=>x.deviceId===deviceId);
    if(!b){ setStatus("You haven't dropped a banana yet.",false); return; }
    map.easeTo({center:[b.lng,b.lat],zoom:18,duration:1000});
    setStatus("üìç Showing your banana");
    menu.classList.remove('show');
  }catch(e){ console.error(e); setStatus(`‚ö†Ô∏è ${e.message}`,false,true); }
};

document.getElementById('shareMine').onclick=async()=>{
  try{
    const latest=await fetchLatest();
    const arr=latest.record?.bananas||[];
    const b=arr.find(x=>x.deviceId===deviceId);
    if(!b){ setStatus("Drop a banana first to share.",false); return; }
    const url=new URL(location.href); url.searchParams.set('id',deviceId);
    await navigator.clipboard.writeText(url.toString());
    setStatus("üîó Link copied!");
    menu.classList.remove('show');
  }catch(e){ console.error(e); setStatus(`‚ö†Ô∏è ${e.message}`,false,true); }
};

document.getElementById('deleteMine').onclick=()=>{ menu.classList.remove('show'); deleteMyBanana(); };

/* Live reload */
const liveToggle=document.getElementById('liveToggle'); let refreshHandle=null;
function startAuto(){ stopAuto(); refreshHandle=setInterval(()=>loadBananas(true),20000); }
function stopAuto(){ if(refreshHandle){ clearInterval(refreshHandle); refreshHandle=null; } }
liveToggle.addEventListener('change',()=> liveToggle.checked?startAuto():stopAuto());
window.addEventListener('visibilitychange',()=>{ if(document.hidden) stopAuto(); else if(liveToggle.checked) startAuto(); });
window.addEventListener('beforeunload',stopAuto);

/* Geolocate on load */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(
    ({coords:{latitude,longitude}})=>{
      map.easeTo({center:[longitude,latitude],zoom:18,duration:900});
      new maplibregl.Popup({offset:12}).setLngLat([longitude,latitude]).setHTML("You are here").addTo(map);
    }, ()=>{}, {enableHighAccuracy:true,timeout:8000,maximumAge:60000}
  );
}

/* Utils */
function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function debounce(fn,ms){let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);}}

/* Boot */
map.on('load', async ()=>{
  try{
    wireClusterClicks();
    await loadBananas();
    startAuto();
    // Deep-link ?id=
    const qid = new URLSearchParams(location.search).get('id');
    if (qid){
      const latest=await fetchLatest(); const arr=latest.record?.bananas||[];
      const b=arr.find(x=>x.deviceId===qid); if(b){ map.easeTo({center:[b.lng,b.lat],zoom:18,duration:1000}); }
    }
  }catch(e){ console.error(e); setStatus(`‚ö†Ô∏è ${e.message}`,false,true); }
});

/* Cluster click ‚Üí zoom into cluster */
function wireClusterClicks(){
  map.on('click','clusters', e=>{
    const f = map.queryRenderedFeatures(e.point,{layers:['clusters']})[0];
    const id = f.properties.cluster_id;
    map.getSource('bananas').getClusterExpansionZoom(id,(err,z)=>{ if(err) return; map.easeTo({center:f.geometry.coordinates, zoom:z}); });
  });
  map.on('mouseenter','clusters',()=> map.getCanvas().style.cursor='pointer');
  map.on('mouseleave','clusters',()=> map.getCanvas().style.cursor='');
}
</script>
</body>
</html>
